<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-TW">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">








  <meta name="google-site-verification" content="hljKlMsU2SXcxNs19upKC7c-yN09EjgKqMi2zR2Ojgg">















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  


<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
 <script>
  (adsbygoogle = window.adsbygoogle || []).push({
     google_ad_client: "ca-pub-7997572949867824",
     enable_page_level_ads: true
   });
 </script>


  <meta name="description" content="身為微軟 MVP，沒將 Angular 與 O365 做整合，好像說不過去。Microsoft O365 系列，其生態系其實算是很完整了，也提供了相當不錯的 API 供開發者做延伸應用。基於這個理由，我也決定要來玩看看 O365 了。但在開始之前，要先搞定登入 MS 帳號並取得通行 Token。所以這篇筆記就是記錄如何登入並取得 Token.">
<meta name="keywords" content="Angular,O365">
<meta property="og:type" content="article">
<meta property="og:title" content="[Angular] 與 O365 跳舞系列 - 登入">
<meta property="og:url" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/index.html">
<meta property="og:site_name" content="CK&#39;s Notepad">
<meta property="og:description" content="身為微軟 MVP，沒將 Angular 與 O365 做整合，好像說不過去。Microsoft O365 系列，其生態系其實算是很完整了，也提供了相當不錯的 API 供開發者做延伸應用。基於這個理由，我也決定要來玩看看 O365 了。但在開始之前，要先搞定登入 MS 帳號並取得通行 Token。所以這篇筆記就是記錄如何登入並取得 Token.">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/SNAGHTML4f488482.PNG">
<meta property="og:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/1564108231023.png">
<meta property="og:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/1564108300903.png">
<meta property="og:image" content="https://i.imgur.com/sw5KaeL.png">
<meta property="og:image" content="https://i.imgur.com/U9SE5dj.png">
<meta property="og:image" content="https://i.imgur.com/wC6LQvY.png">
<meta property="og:image" content="https://i.imgur.com/YnaO3DX.png">
<meta property="og:image" content="https://i.imgur.com/JtsayFx.png">
<meta property="og:image" content="https://i.imgur.com/K7dKP1E.png">
<meta property="og:image" content="https://i.imgur.com/tTs1Gp1.png">
<meta property="og:updated_time" content="2021-02-18T02:39:29.012Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[Angular] 與 O365 跳舞系列 - 登入">
<meta name="twitter:description" content="身為微軟 MVP，沒將 Angular 與 O365 做整合，好像說不過去。Microsoft O365 系列，其生態系其實算是很完整了，也提供了相當不錯的 API 供開發者做延伸應用。基於這個理由，我也決定要來玩看看 O365 了。但在開始之前，要先搞定登入 MS 帳號並取得通行 Token。所以這篇筆記就是記錄如何登入並取得 Token.">
<meta name="twitter:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/SNAGHTML4f488482.PNG">



  <link rel="alternate" href="/atom.xml" title="CK's Notepad" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>[Angular] 與 O365 跳舞系列 - 登入 | CK's Notepad</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56711593-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-56711593-1');
    }
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CK's Notepad</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首頁</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分類</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>歸檔</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>標籤</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜尋</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜尋..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="KevinYang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/4550568.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CK's Notepad">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[Angular] 與 O365 跳舞系列 - 登入

              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              

              
                
              

              <time title="創建時間：2018-10-20 10:31:45" itemprop="dateCreated datePublished" datetime="2018-10-20T10:31:45+08:00">2018-10-20</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/O365/" itemprop="url" rel="index"><span itemprop="name">O365</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">評論數：</span>
                <a href="/2018/10/20/angular-with-o365-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/20/angular-with-o365-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>身為微軟 MVP，沒將 Angular 與 O365 做整合，好像說不過去。Microsoft O365 系列，其生態系其實算是很完整了，也提供了相當不錯的 API 供開發者做延伸應用。基於這個理由，我也決定要來玩看看 O365 了。但在開始之前，要先搞定登入 MS 帳號並取得通行 Token。所以這篇筆記就是記錄如何登入並取得 Token.</p>
<a id="more"></a>
<h1 id="環境準備"><a class="header-anchor" href="#環境準備"> </a>環境準備</h1>
<p>在開發之前，需要先到微軟的 <a href="https://apps.dev.microsoft.com/" target="_blank" rel="noopener">Application Registration Portal</a> 新增應用程式並取得應用程式識別碼。操作步驟如下</p>
<p>(2019/7/26) 目前註冊應用程式的方法</p>
<ol>
<li>
<p>登入 Azure portal</p>
</li>
<li>
<p>前往 Azure Active Directory</p>
<p><img src="SNAGHTML4f488482.PNG" alt="img"></p>
<ol start="3">
<li>
<p>點選【應用程式註冊】</p>
<p><img src="1564108231023.png" alt="1564108231023"></p>
</li>
<li>
<p>依自己的需求選擇註冊位置</p>
<p><img src="1564108300903.png" alt="1564108300903"></p>
</li>
<li>
<p>註冊要新增的內容與舊有的註冊流程類似，可以參閱下面的填寫內容</p>
</li>
</ol>
</li>
</ol>
<p>(以下步驟失效)</p>
<ol>
<li>
<p>登入 MS 帳號</p>
<p><img src="https://i.imgur.com/sw5KaeL.png" alt></p>
</li>
<li>
<p>按 【新增應用程式】</p>
<p><img src="https://i.imgur.com/U9SE5dj.png" alt></p>
</li>
<li>
<p>輸入應用程式名稱</p>
<p><img src="https://i.imgur.com/wC6LQvY.png" alt></p>
<ol start="4">
<li>
<p>新增【平台】</p>
<p><img src="https://i.imgur.com/YnaO3DX.png" alt></p>
<ol start="5">
<li>
<p>選擇 <strong>Web</strong></p>
<p><img src="https://i.imgur.com/JtsayFx.png" alt></p>
</li>
<li>
<p>設定【重新導向 URL】，這裡必須設定正確，不然會出現無法操作的錯誤畫面。因為我們會使用 Angular 做開發，預設的網址是 <code>http://localhost:4200</code> 。</p>
<p><img src="https://i.imgur.com/K7dKP1E.png" alt></p>
</li>
<li>
<p>將應用程式識別碼先記錄起來，待會會用到</p>
<p><img src="https://i.imgur.com/tTs1Gp1.png" alt></p>
</li>
<li>
<p>最後，按下【儲存】即完成第一步的設定</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h1 id="angular-部分"><a class="header-anchor" href="#angular-部分"> </a>Angular 部分</h1>
<p>完成了新增應用程式並取得應用程式識別碼後，就可以開始來寫 Angular 的部分了。這次會使用到 <code>msal</code> 這個套件 (<a href="https://www.npmjs.com/package/msal" target="_blank" rel="noopener">npm套件位置</a>)</p>
<blockquote>
<p>The MSAL library preview for JavaScript is the core library which enables JavaScript web applications to authenticate enterprise users using Microsoft Azure Active Directory (AAD), Microsoft account users (MSA), users using social identity providers like Facebook, Google, LinkedIn etc. and get access to <a href="https://cloud.microsoft.com/" target="_blank" rel="noopener">Microsoft Cloud</a> OR <a href="https://graph.microsoft.io/" target="_blank" rel="noopener">Microsoft Graph</a>.</p>
</blockquote>
<h2 id="基本環境設定"><a class="header-anchor" href="#基本環境設定"> </a>基本環境設定</h2>
<ol>
<li>
<p>建立 Angular 專案</p>
<p><code>ng new &lt;project name&gt;</code></p>
</li>
<li>
<p>安裝 <code>msal</code> 套件</p>
<p><code>npm install msal</code></p>
</li>
<li>
<p>新增一個 <code>service</code> ，等一下會將登入的相關邏輯寫在這個 service 內，名稱自取</p>
</li>
<li>
<p>在 <code>environment.ts</code> 內新增一個 <code>APPLICATION_CONFIG</code> ，內放要給 msal 使用的設定檔</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APPLICATION_CONFIG: &#123;</span><br><span class="line">   clientID: <span class="string">'放剛剛記下來的應用程式識別碼'</span>,</span><br><span class="line">   redirectUri: <span class="string">'http://localhost:4200/'</span>,</span><br><span class="line">   interactionMode: <span class="string">'popUp'</span>,</span><br><span class="line">   graphEndpoint: <span class="string">'https://graph.microsoft.com/v1.0/me'</span>,</span><br><span class="line">   graphScopes: [<span class="string">'user.read'</span>]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>clientID: 應用程式識別碼</li>
<li>graphScopes: 設定此應用程式需要與使用者請求的授權範圍</li>
</ul>
</li>
</ol>
<h2 id="使用者登入"><a class="header-anchor" href="#使用者登入"> </a>使用者登入</h2>
<h3 id="service"><a class="header-anchor" href="#service"> </a>service</h3>
<ol>
<li>
<p>建立 <code>Msal.UserAgentApplication</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">'../environments/environment'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Msal <span class="keyword">from</span> <span class="string">'msal'</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> GraphHelperService &#123;</span><br><span class="line">  readonly APPLICATION_CONFIG = environment.APPLICATION_CONFIG;</span><br><span class="line">  <span class="keyword">private</span> clientApplication: Msal.UserAgentApplication;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.clientApplication = <span class="keyword">this</span>.createApplication();</span><br><span class="line">    <span class="keyword">this</span>.clientApplication.handleRedirectCallback(<span class="function">(<span class="params">error, response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// handle redirect response or error</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> createApplication() &#123;</span><br><span class="line">    <span class="keyword">const</span> msalConfig = &#123;</span><br><span class="line">      auth: &#123;</span><br><span class="line">        clientId: <span class="keyword">this</span>.APPLICATION_CONFIG.clientID</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Msal.UserAgentApplication(msalConfig);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>建立 <code>login()</code> 方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">login() &#123;</span><br><span class="line">    <span class="keyword">const</span> acquireTokenSilent = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">this</span>.clientApplication.acquireTokenSilent(&#123;</span><br><span class="line">            scopes: <span class="keyword">this</span>.APPLICATION_CONFIG.graphScopes</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> acquireTokenPopup = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">      <span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">this</span>.clientApplication.acquireTokenPopup(&#123;</span><br><span class="line">            scopes: <span class="keyword">this</span>.APPLICATION_CONFIG.graphScopes</span><br><span class="line">        &#125;)</span><br><span class="line">      ).pipe(</span><br><span class="line">        catchError(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">window</span>.alert(<span class="string">'Error acquiring the popup:\n'</span> + error);</span><br><span class="line">          <span class="keyword">return</span> EMPTY;</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span>(<span class="keyword">this</span>.clientApplication.loginPopup(&#123;scopes:<span class="keyword">this</span>.APPLICATION_CONFIG.graphScopes&#125;))</span><br><span class="line">      .pipe(</span><br><span class="line">        mergeMap(<span class="function"><span class="params">token</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> acquireTokenSilent().pipe(</span><br><span class="line">            catchError(<span class="function"><span class="params">err</span> =&gt;</span> acquireTokenPopup())</span><br><span class="line">          );</span><br><span class="line">        &#125;)</span><br><span class="line">      )</span><br><span class="line">      .subscribe(</span><br><span class="line">        accessToken =&gt; &#123;</span><br><span class="line">          localStorage.token = accessToken;</span><br><span class="line">          <span class="built_in">window</span>.location.reload();</span><br><span class="line">        &#125;,</span><br><span class="line">        error =&gt; &#123;</span><br><span class="line">          <span class="built_in">window</span>.alert(<span class="string">'Error during login:\n'</span> + error);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>loginPopup</code> 會開啟一個邀情登入微軟帳號的畫面，輸入完帳號密碼時，會進入下一個步驟</li>
<li><code>acquireTokenSilent</code> : 取得 <code>accessToken</code></li>
<li>再將取到的 <code>accessToken</code> 存入到 <code>localStorage</code> 內</li>
<li>將整個畫面重整 (<strong>這個動作可以替換成更合適的行為</strong>)</li>
</ul>
</li>
<li>
<p>建立 <code>logout()</code> 方法，這個比較簡單</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logout() &#123;</span><br><span class="line">  <span class="keyword">this</span>.clientApplication.logout();</span><br><span class="line">  <span class="keyword">delete</span> localStorage.token;</span><br><span class="line">  <span class="keyword">delete</span> localStorage.user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>直接呼叫 logout() 方法</li>
<li>刪除儲存在 <code>localStorage</code> 內的相關資訊</li>
</ul>
</li>
</ol>
<h3 id="component"><a class="header-anchor" href="#component"> </a>component</h3>
<p>當 Service 建立完成後，我們就可以在 Component 的地方使用該 service 做使用者登入的動作了</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> graphHelper: GraphHelperService</span>) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">  login() &#123;</span><br><span class="line">    <span class="keyword">this</span>.graphHelper.login();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  logout() &#123;</span><br><span class="line">    <span class="keyword">this</span>.graphHelper.logout();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="取得使用者資訊"><a class="header-anchor" href="#取得使用者資訊"> </a>取得使用者資訊</h2>
<p>當成功登入後，我們就可以利用取得的 <code>accessToken</code> 來使用 MS Graph，什麼是 MS Graph ？MS Graph 是一個可以使用 Microsoft 365 服務的 API，透過這個 API 可以存取使用 O365 的服務內容，例如信件、行事曆、OneDrive 等。</p>
<p>這篇筆記，先來做個基本資料的取得，如帳號的顯示名稱跟 Email</p>
<h3 id="service-v2"><a class="header-anchor" href="#service-v2"> </a>service</h3>
<p>可以透過呼叫 <code>https://graph.microsoft.com/v1.0/me</code> 來取得登入帳號的基本資訊</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">me() &#123;</span><br><span class="line">    <span class="keyword">const</span> header = <span class="keyword">new</span> HttpHeaders().append(</span><br><span class="line">      <span class="string">'Authorization'</span>,</span><br><span class="line">      <span class="string">`Bearer <span class="subst">$&#123;localStorage.token&#125;</span>`</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.http.get(<span class="string">'https://graph.microsoft.com/v1.0/me'</span>, &#123;</span><br><span class="line">      headers: header</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="component-v2"><a class="header-anchor" href="#component-v2"> </a>component</h3>
<p>呼叫 service 的 <code>me()</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.graphHelper.me().subscribe(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">    localStorage.setItem(<span class="string">'user'</span>, <span class="built_in">JSON</span>.stringify(user));</span><br><span class="line">    <span class="keyword">this</span>.displayName = user.displayName;</span><br><span class="line">    <span class="keyword">this</span>.emailAddress = user.mail || user.userPrincipalName;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果想要進一步知道取回來使用者資料有哪些項目，可以使用 <code>console.log</code> 的方法觀看</p>
<h1 id="recap"><a class="header-anchor" href="#recap"> </a>Recap</h1>
<p>當正常登入後，就可以使用 Graph REST API 了。O365 的服務種類很多，可以透過延伸服務創造出另外一種的應用程式。但相關的開發文件又不多，所以在多次撞牆後，還是覺得將過程記錄起來，方便其他有興趣的人可以少走一些路。</p>
<h1 id="參考資料"><a class="header-anchor" href="#參考資料"> </a>參考資料</h1>
<ul>
<li><a href="https://www.npmjs.com/package/msal" target="_blank" rel="noopener">npm-msal</a></li>
<li><a href="https://developer.microsoft.com/en-us/graph/docs/concepts/v1-overview" target="_blank" rel="noopener">Graph REST API v1.0 reference</a></li>
<li><a href="https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/users" target="_blank" rel="noopener">Users API</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/Angular/" rel="tag"># Angular</a>
          
            <a href="/tags/O365/" rel="tag"># O365</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/14/angular-akita-first-impression/" rel="next" title="[Angular] Akita 第一次接觸">
                <i class="fa fa-chevron-left"></i> [Angular] Akita 第一次接觸
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/20/angular-with-o365-2/" rel="prev" title="[Angular] 與 O365 跳舞系列 - MAIL">
                [Angular] 與 O365 跳舞系列 - MAIL <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    
      <div>
        <div class="addthis_inline_share_toolbox">
  <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-587058bb56929fc8" async="async"></script>
</div>

      </div>
    
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/4550568.jpg" alt="KevinYang">
            
              <p class="site-author-name" itemprop="name">KevinYang</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">300</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">分類</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">64</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/chgc" title="GitHub &rarr; https://github.com/chgc" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/yoKevinYang" title="Twitter &rarr; https://twitter.com/yoKevinYang" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.facebook.com/CKNotepad" title="FB Page &rarr; https://www.facebook.com/CKNotepad" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i>FB Page</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情連結
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.miniasp.com/" title="https://blog.miniasp.com/" rel="noopener" target="_blank">The Will Will Web | Will 保哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wellwind.idv.tw/blog/" title="https://wellwind.idv.tw/blog/" rel="noopener" target="_blank">全端開發人員天梯</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://poychang.github.io/" title="https://poychang.github.io/" rel="noopener" target="_blank">POY CHANG | Trial and Error</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jeffwu85182.github.io/" title="https://jeffwu85182.github.io/" rel="noopener" target="_blank">Jeffs WebTech Note</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#環境準備"><span class="nav-number">1.</span> <span class="nav-text"> 環境準備</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#angular-部分"><span class="nav-number">2.</span> <span class="nav-text"> Angular 部分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本環境設定"><span class="nav-number">2.1.</span> <span class="nav-text"> 基本環境設定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用者登入"><span class="nav-number">2.2.</span> <span class="nav-text"> 使用者登入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service"><span class="nav-number">2.2.1.</span> <span class="nav-text"> service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#component"><span class="nav-number">2.2.2.</span> <span class="nav-text"> component</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#取得使用者資訊"><span class="nav-number">2.3.</span> <span class="nav-text"> 取得使用者資訊</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service-v2"><span class="nav-number">2.3.1.</span> <span class="nav-text"> service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#component-v2"><span class="nav-number">2.3.2.</span> <span class="nav-text"> component</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#recap"><span class="nav-number">3.</span> <span class="nav-text"> Recap</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#參考資料"><span class="nav-number">4.</span> <span class="nav-text"> 參考資料</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
    <div class="gooAd sidebar-inner" style="display: block;">
        <!-- Google AdSense start -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog-sidebar -->
<ins class="adsbygoogle" style="display: block" data-ad-client="ca-pub-7997572949867824" data-ad-slot="3959999538" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>

     </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KevinYang</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 強力驅動 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>



  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  


  <script src="/js/next-boot.js?v=7.2.0"></script>


  

  

  

  
  
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://cksnotepad.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>


<script>
  var disqus_config = function() {
    this.page.url = "http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/";
    this.page.identifier = "2018/10/20/angular-with-o365-1/";
    this.page.title = '[Angular] 與 O365 跳舞系列 - 登入';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://cksnotepad.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    window.addEventListener('load', loadComments, false);
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
