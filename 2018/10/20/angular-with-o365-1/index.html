<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="hljKlMsU2SXcxNs19upKC7c-yN09EjgKqMi2zR2Ojgg">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.kevinyang.net","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="身為微軟 MVP，沒將 Angular 與 O365 做整合，好像說不過去。Microsoft O365 系列，其生態系其實算是很完整了，也提供了相當不錯的 API 供開發者做延伸應用。基於這個理由，我也決定要來玩看看 O365 了。但在開始之前，要先搞定登入 MS 帳號並取得通行 Token。所以這篇筆記就是記錄如何登入並取得 Token.">
<meta property="og:type" content="article">
<meta property="og:title" content="[Angular] 與 O365 跳舞系列 - 登入">
<meta property="og:url" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/index.html">
<meta property="og:site_name" content="CK&#39;s Notepad">
<meta property="og:description" content="身為微軟 MVP，沒將 Angular 與 O365 做整合，好像說不過去。Microsoft O365 系列，其生態系其實算是很完整了，也提供了相當不錯的 API 供開發者做延伸應用。基於這個理由，我也決定要來玩看看 O365 了。但在開始之前，要先搞定登入 MS 帳號並取得通行 Token。所以這篇筆記就是記錄如何登入並取得 Token.">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/SNAGHTML4f488482.PNG">
<meta property="og:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/1564108231023.png">
<meta property="og:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/1564108300903.png">
<meta property="og:image" content="https://i.imgur.com/sw5KaeL.png">
<meta property="og:image" content="https://i.imgur.com/U9SE5dj.png">
<meta property="og:image" content="https://i.imgur.com/wC6LQvY.png">
<meta property="og:image" content="https://i.imgur.com/YnaO3DX.png">
<meta property="og:image" content="https://i.imgur.com/JtsayFx.png">
<meta property="og:image" content="https://i.imgur.com/K7dKP1E.png">
<meta property="og:image" content="https://i.imgur.com/tTs1Gp1.png">
<meta property="article:published_time" content="2018-10-20T02:31:45.000Z">
<meta property="article:modified_time" content="2022-02-20T11:50:12.430Z">
<meta property="article:author" content="KevinYang">
<meta property="article:tag" content="Angular">
<meta property="article:tag" content="O365">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/SNAGHTML4f488482.PNG">

<link rel="canonical" href="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>[Angular] 與 O365 跳舞系列 - 登入 | CK's Notepad</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56711593-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-56711593-1');
      }
    </script>


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: 'ca-pub-7997572949867824',
          enable_page_level_ads: true
     });
</script>







  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="CK's Notepad" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CK's Notepad</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

  
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/4550568.jpg">
      <meta itemprop="name" content="KevinYang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CK's Notepad">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [Angular] 與 O365 跳舞系列 - 登入
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2018-10-20 10:31:45" itemprop="dateCreated datePublished" datetime="2018-10-20T10:31:45+08:00">2018-10-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/O365/" itemprop="url" rel="index"><span itemprop="name">O365</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/10/20/angular-with-o365-1/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/20/angular-with-o365-1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>身為微軟 MVP，沒將 Angular 與 O365 做整合，好像說不過去。Microsoft O365 系列，其生態系其實算是很完整了，也提供了相當不錯的 API 供開發者做延伸應用。基於這個理由，我也決定要來玩看看 O365 了。但在開始之前，要先搞定登入 MS 帳號並取得通行 Token。所以這篇筆記就是記錄如何登入並取得 Token.</p>
<span id="more"></span>
<h1 id="環境準備"><a class="header-anchor" href="#環境準備"> </a>環境準備</h1>
<p>在開發之前，需要先到微軟的 <a target="_blank" rel="noopener" href="https://apps.dev.microsoft.com/">Application Registration Portal</a> 新增應用程式並取得應用程式識別碼。操作步驟如下</p>
<p>(2019/7/26) 目前註冊應用程式的方法</p>
<ol>
<li>
<p>登入 Azure portal</p>
</li>
<li>
<p>前往 Azure Active Directory</p>
<p><img src="SNAGHTML4f488482.PNG" alt="img"></p>
<ol start="3">
<li>
<p>點選【應用程式註冊】</p>
<p><img src="1564108231023.png" alt="1564108231023"></p>
</li>
<li>
<p>依自己的需求選擇註冊位置</p>
<p><img src="1564108300903.png" alt="1564108300903"></p>
</li>
<li>
<p>註冊要新增的內容與舊有的註冊流程類似，可以參閱下面的填寫內容</p>
</li>
</ol>
</li>
</ol>
<p>(以下步驟失效)</p>
<ol>
<li>
<p>登入 MS 帳號</p>
<p><img src="https://i.imgur.com/sw5KaeL.png" alt=""></p>
</li>
<li>
<p>按 【新增應用程式】</p>
<p><img src="https://i.imgur.com/U9SE5dj.png" alt=""></p>
</li>
<li>
<p>輸入應用程式名稱</p>
<p><img src="https://i.imgur.com/wC6LQvY.png" alt=""></p>
<ol start="4">
<li>
<p>新增【平台】</p>
<p><img src="https://i.imgur.com/YnaO3DX.png" alt=""></p>
<ol start="5">
<li>
<p>選擇 <strong>Web</strong></p>
<p><img src="https://i.imgur.com/JtsayFx.png" alt=""></p>
</li>
<li>
<p>設定【重新導向 URL】，這裡必須設定正確，不然會出現無法操作的錯誤畫面。因為我們會使用 Angular 做開發，預設的網址是 <code>http://localhost:4200</code> 。</p>
<p><img src="https://i.imgur.com/K7dKP1E.png" alt=""></p>
</li>
<li>
<p>將應用程式識別碼先記錄起來，待會會用到</p>
<p><img src="https://i.imgur.com/tTs1Gp1.png" alt=""></p>
</li>
<li>
<p>最後，按下【儲存】即完成第一步的設定</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h1 id="Angular-部分"><a class="header-anchor" href="#Angular-部分"> </a>Angular 部分</h1>
<p>完成了新增應用程式並取得應用程式識別碼後，就可以開始來寫 Angular 的部分了。這次會使用到 <code>msal</code> 這個套件 (<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/msal">npm套件位置</a>)</p>
<blockquote>
<p>The MSAL library preview for JavaScript is the core library which enables JavaScript web applications to authenticate enterprise users using Microsoft Azure Active Directory (AAD), Microsoft account users (MSA), users using social identity providers like Facebook, Google, LinkedIn etc. and get access to <a target="_blank" rel="noopener" href="https://cloud.microsoft.com/">Microsoft Cloud</a> OR <a target="_blank" rel="noopener" href="https://graph.microsoft.io/">Microsoft Graph</a>.</p>
</blockquote>
<h2 id="基本環境設定"><a class="header-anchor" href="#基本環境設定"> </a>基本環境設定</h2>
<ol>
<li>
<p>建立 Angular 專案</p>
<p><code>ng new &lt;project name&gt;</code></p>
</li>
<li>
<p>安裝 <code>msal</code> 套件</p>
<p><code>npm install msal</code></p>
</li>
<li>
<p>新增一個 <code>service</code> ，等一下會將登入的相關邏輯寫在這個 service 內，名稱自取</p>
</li>
<li>
<p>在 <code>environment.ts</code> 內新增一個 <code>APPLICATION_CONFIG</code> ，內放要給 msal 使用的設定檔</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">APPLICATION_CONFIG</span>: &#123;</span><br><span class="line">   <span class="attr">clientID</span>: <span class="string">&#x27;放剛剛記下來的應用程式識別碼&#x27;</span>,</span><br><span class="line">   <span class="attr">redirectUri</span>: <span class="string">&#x27;http://localhost:4200/&#x27;</span>,</span><br><span class="line">   <span class="attr">interactionMode</span>: <span class="string">&#x27;popUp&#x27;</span>,</span><br><span class="line">   <span class="attr">graphEndpoint</span>: <span class="string">&#x27;https://graph.microsoft.com/v1.0/me&#x27;</span>,</span><br><span class="line">   <span class="attr">graphScopes</span>: [<span class="string">&#x27;user.read&#x27;</span>]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>clientID: 應用程式識別碼</li>
<li>graphScopes: 設定此應用程式需要與使用者請求的授權範圍</li>
</ul>
</li>
</ol>
<h2 id="使用者登入"><a class="header-anchor" href="#使用者登入"> </a>使用者登入</h2>
<h3 id="service"><a class="header-anchor" href="#service"> </a>service</h3>
<ol>
<li>
<p>建立 <code>Msal.UserAgentApplication</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; environment &#125; <span class="keyword">from</span> <span class="string">&#x27;../environments/environment&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Msal</span> <span class="keyword">from</span> <span class="string">&#x27;msal&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GraphHelperService</span> &#123;</span><br><span class="line">  <span class="keyword">readonly</span> <span class="variable constant_">APPLICATION_CONFIG</span> = environment.<span class="property">APPLICATION_CONFIG</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">clientApplication</span>: <span class="title class_">Msal</span>.<span class="property">UserAgentApplication</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clientApplication</span> = <span class="variable language_">this</span>.<span class="title function_">createApplication</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clientApplication</span>.<span class="title function_">handleRedirectCallback</span>(<span class="function">(<span class="params">error, response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// handle redirect response or error</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">createApplication</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> msalConfig = &#123;</span><br><span class="line">      <span class="attr">auth</span>: &#123;</span><br><span class="line">        <span class="attr">clientId</span>: <span class="variable language_">this</span>.<span class="property">APPLICATION_CONFIG</span>.<span class="property">clientID</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Msal</span>.<span class="title class_">UserAgentApplication</span>(msalConfig);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>建立 <code>login()</code> 方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">acquireTokenSilent</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">      <span class="title function_">from</span>(</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">clientApplication</span>.<span class="title function_">acquireTokenSilent</span>(&#123;</span><br><span class="line">            <span class="attr">scopes</span>: <span class="variable language_">this</span>.<span class="property">APPLICATION_CONFIG</span>.<span class="property">graphScopes</span></span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">acquireTokenPopup</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">      <span class="title function_">from</span>(</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">clientApplication</span>.<span class="title function_">acquireTokenPopup</span>(&#123;</span><br><span class="line">            <span class="attr">scopes</span>: <span class="variable language_">this</span>.<span class="property">APPLICATION_CONFIG</span>.<span class="property">graphScopes</span></span><br><span class="line">        &#125;)</span><br><span class="line">      ).<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">catchError</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">window</span>.<span class="title function_">alert</span>(<span class="string">&#x27;Error acquiring the popup:\n&#x27;</span> + error);</span><br><span class="line">          <span class="keyword">return</span> <span class="variable constant_">EMPTY</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">clientApplication</span>.<span class="title function_">loginPopup</span>(&#123;<span class="attr">scopes</span>:<span class="variable language_">this</span>.<span class="property">APPLICATION_CONFIG</span>.<span class="property">graphScopes</span>&#125;))</span><br><span class="line">      .<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">mergeMap</span>(<span class="function"><span class="params">token</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">acquireTokenSilent</span>().<span class="title function_">pipe</span>(</span><br><span class="line">            <span class="title function_">catchError</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">acquireTokenPopup</span>())</span><br><span class="line">          );</span><br><span class="line">        &#125;)</span><br><span class="line">      )</span><br><span class="line">      .<span class="title function_">subscribe</span>(</span><br><span class="line">        <span class="function"><span class="params">accessToken</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">localStorage</span>.<span class="property">token</span> = accessToken;</span><br><span class="line">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">window</span>.<span class="title function_">alert</span>(<span class="string">&#x27;Error during login:\n&#x27;</span> + error);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>loginPopup</code> 會開啟一個邀情登入微軟帳號的畫面，輸入完帳號密碼時，會進入下一個步驟</li>
<li><code>acquireTokenSilent</code> : 取得 <code>accessToken</code></li>
<li>再將取到的 <code>accessToken</code> 存入到 <code>localStorage</code> 內</li>
<li>將整個畫面重整 (<strong>這個動作可以替換成更合適的行為</strong>)</li>
</ul>
</li>
<li>
<p>建立 <code>logout()</code> 方法，這個比較簡單</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">clientApplication</span>.<span class="title function_">logout</span>();</span><br><span class="line">  <span class="keyword">delete</span> <span class="variable language_">localStorage</span>.<span class="property">token</span>;</span><br><span class="line">  <span class="keyword">delete</span> <span class="variable language_">localStorage</span>.<span class="property">user</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>直接呼叫 logout() 方法</li>
<li>刪除儲存在 <code>localStorage</code> 內的相關資訊</li>
</ul>
</li>
</ol>
<h3 id="component"><a class="header-anchor" href="#component"> </a>component</h3>
<p>當 Service 建立完成後，我們就可以在 Component 的地方使用該 service 做使用者登入的動作了</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> <span class="keyword">implements</span> <span class="title class_">OnInit</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> graphHelper: GraphHelperService</span>) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphHelper</span>.<span class="title function_">login</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">graphHelper</span>.<span class="title function_">logout</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="取得使用者資訊"><a class="header-anchor" href="#取得使用者資訊"> </a>取得使用者資訊</h2>
<p>當成功登入後，我們就可以利用取得的 <code>accessToken</code> 來使用 MS Graph，什麼是 MS Graph ？MS Graph 是一個可以使用 Microsoft 365 服務的 API，透過這個 API 可以存取使用 O365 的服務內容，例如信件、行事曆、OneDrive 等。</p>
<p>這篇筆記，先來做個基本資料的取得，如帳號的顯示名稱跟 Email</p>
<h3 id="service-v2"><a class="header-anchor" href="#service-v2"> </a>service</h3>
<p>可以透過呼叫 <code>https://graph.microsoft.com/v1.0/me</code> 來取得登入帳號的基本資訊</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">me</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> header = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>().<span class="title function_">append</span>(</span><br><span class="line">      <span class="string">&#x27;Authorization&#x27;</span>,</span><br><span class="line">      <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">localStorage</span>.token&#125;</span>`</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">get</span>(<span class="string">&#x27;https://graph.microsoft.com/v1.0/me&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">headers</span>: header</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="component-v2"><a class="header-anchor" href="#component-v2"> </a>component</h3>
<p>呼叫 service 的 <code>me()</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">graphHelper</span>.<span class="title function_">me</span>().<span class="title function_">subscribe</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;user&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">displayName</span> = user.<span class="property">displayName</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">emailAddress</span> = user.<span class="property">mail</span> || user.<span class="property">userPrincipalName</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果想要進一步知道取回來使用者資料有哪些項目，可以使用 <code>console.log</code> 的方法觀看</p>
<h1 id="Recap"><a class="header-anchor" href="#Recap"> </a>Recap</h1>
<p>當正常登入後，就可以使用 Graph REST API 了。O365 的服務種類很多，可以透過延伸服務創造出另外一種的應用程式。但相關的開發文件又不多，所以在多次撞牆後，還是覺得將過程記錄起來，方便其他有興趣的人可以少走一些路。</p>
<h1 id="參考資料"><a class="header-anchor" href="#參考資料"> </a>參考資料</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/msal">npm-msal</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.microsoft.com/en-us/graph/docs/concepts/v1-overview">Graph REST API v1.0 reference</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/users">Users API</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Angular/" rel="tag"># Angular</a>
              <a href="/tags/O365/" rel="tag"># O365</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/10/14/angular-akita-first-impression/" rel="prev" title="[Angular] Akita 第一次接觸">
      <i class="fa fa-chevron-left"></i> [Angular] Akita 第一次接觸
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/10/20/angular-with-o365-2/" rel="next" title="[Angular] 與 O365 跳舞系列 - MAIL">
      [Angular] 與 O365 跳舞系列 - MAIL <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    

    
      <div>
        <div class="addthis_inline-share_toolbox">
   <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=" async="async"></script>
</div>        
      </div>
     
  </article>
  
  
  
 
  
 

          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%92%B0%E5%A2%83%E6%BA%96%E5%82%99"><span class="nav-number">1.</span> <span class="nav-text">環境準備</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Angular-%E9%83%A8%E5%88%86"><span class="nav-number">2.</span> <span class="nav-text">Angular 部分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A"><span class="nav-number">2.1.</span> <span class="nav-text">基本環境設定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%80%85%E7%99%BB%E5%85%A5"><span class="nav-number">2.2.</span> <span class="nav-text">使用者登入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service"><span class="nav-number">2.2.1.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#component"><span class="nav-number">2.2.2.</span> <span class="nav-text">component</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%96%E5%BE%97%E4%BD%BF%E7%94%A8%E8%80%85%E8%B3%87%E8%A8%8A"><span class="nav-number">2.3.</span> <span class="nav-text">取得使用者資訊</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service-v2"><span class="nav-number">2.3.1.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#component-v2"><span class="nav-number">2.3.2.</span> <span class="nav-text">component</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Recap"><span class="nav-number">3.</span> <span class="nav-text">Recap</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="nav-number">4.</span> <span class="nav-text">參考資料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="KevinYang"
      src="/images/4550568.jpg">
  <p class="site-author-name" itemprop="name">KevinYang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">325</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/chgc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chgc" rel="noopener" target="_blank"><i class="fa fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/yoKevinYang" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;yoKevinYang" rel="noopener" target="_blank"><i class="fa fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/CKNotepad" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;CKNotepad" rel="noopener" target="_blank"><i class="fa fa-facebook fa-fw"></i>FB Page</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.miniasp.com/" title="https:&#x2F;&#x2F;blog.miniasp.com&#x2F;" rel="noopener" target="_blank">The Will Will Web | Will 保哥</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wellwind.idv.tw/blog/" title="https:&#x2F;&#x2F;wellwind.idv.tw&#x2F;blog&#x2F;" rel="noopener" target="_blank">全端開發人員天梯</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://poychang.github.io/" title="https:&#x2F;&#x2F;poychang.github.io&#x2F;" rel="noopener" target="_blank">POY CHANG | Trial and Error</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://jeffwu85182.github.io/" title="https:&#x2F;&#x2F;jeffwu85182.github.io&#x2F;" rel="noopener" target="_blank">Jeffs WebTech Note</a>
        </li>
    </ul>
  </div>

      </div>
        <!--google_adsense-->
        
          <div class="links-of-blogroll-title">
            <i class="fa fa-google"></i> 廣告
            <ins class="adsbygoogle"
                style="display:block"
                data-ad-client="ca-pub-7997572949867824"
                data-ad-slot="3959999538"
                data-ad-format="auto"
                data-full-width-responsive="true"></ins>
            <script>
              (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
          </div>
        
        <!--/google_adsense-->
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>    
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KevinYang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 強力驅動
  </div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-587058bb56929fc8" async="async"></script>
  </div>

        








      </div>
    </footer>

    

    

    
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://cksnotepad.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://blog.kevinyang.net/2018/10/20/angular-with-o365-1/";
    this.page.identifier = "2018/10/20/angular-with-o365-1/";
    this.page.title = "[Angular] 與 O365 跳舞系列 - 登入";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://cksnotepad.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
