<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CK&#39;s Notepad</title>
  
  
  <link href="http://blog.kevinyang.net/atom.xml" rel="self"/>
  
  <link href="http://blog.kevinyang.net/"/>
  <updated>2023-12-30T10:00:10.171Z</updated>
  <id>http://blog.kevinyang.net/</id>
  
  <author>
    <name>KevinYang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>[gRPC] é‡æ–°å­¸ç¿’ gRPC ç³»åˆ— - 2</title>
    <link href="http://blog.kevinyang.net/2023/12/30/backto-grpc-note2/"/>
    <id>http://blog.kevinyang.net/2023/12/30/backto-grpc-note2/</id>
    <published>2023-12-30T02:21:25.000Z</published>
    <updated>2023-12-30T10:00:10.171Z</updated>
    
    <content type="html"><![CDATA[<p>äº†è§£ <code>proto</code> çš„åŸºæœ¬èªæ³•å¾Œï¼Œå°±å¯ä»¥ä¾†ç”¨ä¸€å€‹ç¨‹å¼èªè¨€å¯¦ä½œ gRPC æœå‹™äº†ï¼Œæœ¬ç¯‡å°±ç”¨ Golang ä¾†ä½œç¯„ä¾‹å§ï¼Œç·´ç¿’å…§å®¹æ˜¯æ ¹æ“šå®˜æ–¹æ–‡ä»¶æ‰€æä¾›çš„æ•™å­¸å…§å®¹ï¼Œç´°ç¯€å¯ä»¥åˆ°<a href="https://grpc.io/docs/languages/go/quickstart/">é€™é‚Š</a>é–±è®€ã€‚</p><span id="more"></span><h1 id="ç·´ç¿’ä¸€"><a class="header-anchor" href="#ç·´ç¿’ä¸€"> </a>ç·´ç¿’ä¸€</h1><p>Golang ç’°å¢ƒå¦‚ä½•å®‰è£é€™é‚Šå°±ä¸èªªæ˜äº†ã€‚éœ€è¦å®‰è£ <code>Protobuf Compiler</code>(<a href="https://github.com/protocolbuffers/protobuf#protobuf-compiler-installation">å®‰è£é€£çµ</a>)ï¼Œå¦‚æœç’°å¢ƒæ²’æœ‰å®‰è£ C++ï¼Œä¹Ÿå¯ä»¥ä¸‹è¼‰é å…ˆ compile å¥½çš„åŸ·è¡Œæª”ï¼Œä¸¦è¨­å®šå¥½ç’°å¢ƒåƒæ•¸ (<a href="https://grpc.io/docs/protoc-installation/#install-pre-compiled-binaries-any-os">æ­¥é©Ÿèªªæ˜</a>)ï¼Œå¦‚æœä¸€åˆ‡è¨­å®šæ­£ç¢ºï¼Œåœ¨å‘½ä»¤è¦–çª—å…§æ‡‰å¯åŸ·è¡Œ <code>protoc</code> æŒ‡ä»¤äº†</p><p>ç·´ç¿’é¡Œç›®: å»ºç«‹ä¸€å€‹ address bookï¼ŒåŠŸèƒ½æ˜¯å¯ä»¥å¾æª”æ¡ˆä¸­å­˜å–è¯çµ¡è³‡è¨Šï¼Œè¯çµ¡è³‡è¨ŠåŒ…å«å§“åã€IDã€Emailã€é€£çµ¡é›»è©±</p><h2 id="åˆå§‹åŒ–å°ˆæ¡ˆ"><a class="header-anchor" href="#åˆå§‹åŒ–å°ˆæ¡ˆ"> </a>åˆå§‹åŒ–å°ˆæ¡ˆ</h2><ol><li><p>å»ºç«‹ä¸€å€‹æ–°çš„è³‡æ–™å¤¾</p></li><li><p>åŸ·è¡Œ <code>go mod init &lt;project name&gt;</code> æŒ‡ä»¤</p></li><li><p>å»ºç«‹ <code>addressbook.proto</code> æª”æ¡ˆ</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/timestamp.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./tutorialpb&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int32</span> id = <span class="number">2</span>;</span><br><span class="line">    <span class="type">string</span> email = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">repeated</span> PhoneNumber phones = <span class="number">4</span>;</span><br><span class="line">    google.protobuf.Timestamp last_updated = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">message </span><span class="title class_">PhoneNumber</span> &#123;</span><br><span class="line">        <span class="type">string</span> number = <span class="number">1</span>;</span><br><span class="line">        PhoneType type = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">PhoneType</span> &#123;</span><br><span class="line">  PHONE_TYPE_UNSPECIFIED = <span class="number">0</span>;</span><br><span class="line">  PHONE_TYPE_MOBILE = <span class="number">1</span>;</span><br><span class="line">  PHONE_TYPE_HOME = <span class="number">2</span>;</span><br><span class="line">  PHONE_TYPE_WORK = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">AddressBook</span> &#123;</span><br><span class="line">    <span class="keyword">repeated</span> Person people = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>123</li></ul></li><li><p>å®‰è£ <code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</code></p></li><li><p>é–‹å•Ÿå‘½ä»¤è¦–çª—ï¼ŒåŸ·è¡Œ <code>protoc -I=. --go_out . addressbook.proto</code> æŒ‡ä»¤ï¼Œå³å¯çœ‹åˆ°ç¨‹å¼ç¢¼ç”¢ç”Ÿå† <code>tutorialpb</code> çš„è³‡æ–™å¤¾ä¸‹</p></li></ol><h2 id="å¯¦ä½œ"><a class="header-anchor" href="#å¯¦ä½œ"> </a>å¯¦ä½œ</h2><ol><li><p>å»ºç«‹ <code>main.go</code></p></li><li><p>å¼•ç”¨å‰›å‰›ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ï¼Œå…¶å…§å®¹æœƒåŒ…å«</p><ol><li>An <code>AddressBook</code> structure with a <code>People</code> field.</li><li>A <code>Person</code> structure with fields for <code>Name</code>, <code>Id</code>, <code>Email</code> and <code>Phones</code>.</li><li>A <code>Person_PhoneNumber</code> structure, with fields for <code>Number</code> and <code>Type</code>.</li><li>The type <code>Person_PhoneType</code> and a value defined for each value in the <code>Person.PhoneType</code> enum.</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">pb <span class="string">&quot;go-grpc/tutorialpb&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">p := pb.Person&#123;</span><br><span class="line">Id:    <span class="number">1234</span>,</span><br><span class="line">Name:  <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">Email: <span class="string">&quot;jdoe@example.com&quot;</span>,</span><br><span class="line">Phones: []*pb.Person_PhoneNumber&#123;</span><br><span class="line">&#123;Number: <span class="string">&quot;555-4321&quot;</span>, Type: pb.PhoneType_PHONE_TYPE_HOME&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="Writing-a-Message"><a class="header-anchor" href="#Writing-a-Message"> </a>Writing a Message</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">pb <span class="string">&quot;go-grpc/tutorialpb&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/protobuf/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fname := <span class="string">&quot;adress&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®€å–æª”æ¡ˆå…§å®¹</span></span><br><span class="line">in, err := os.ReadFile(fname)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s: File not found.  Creating new file.\n&quot;</span>, fname)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Error reading file:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»ºç«‹ Person ç‰©ä»¶</span></span><br><span class="line">p := pb.Person&#123;</span><br><span class="line">Id:    <span class="number">1234</span>,</span><br><span class="line">Name:  <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">Email: <span class="string">&quot;jdoe@example.com&quot;</span>,</span><br><span class="line">Phones: []*pb.Person_PhoneNumber&#123;</span><br><span class="line">&#123;Number: <span class="string">&quot;555-4321&quot;</span>, Type: pb.PhoneType_PHONE_TYPE_HOME&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">book := &amp;pb.AddressBook&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°‡æª”æ¡ˆå…§å®¹æ”¾é€² AddressBook ç‰©ä»¶å…§</span></span><br><span class="line"><span class="keyword">if</span> err := proto.Unmarshal(in, book); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Failed to parse address book:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°å¢è¯çµ¡äºº</span></span><br><span class="line">book.People = <span class="built_in">append</span>(book.People, &amp;p)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Marshal &amp; å„²å­˜å›æª”æ¡ˆä¸­</span></span><br><span class="line">out, err := proto.Marshal(book)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Failed to encode address book:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := os.WriteFile(fname, out, <span class="number">0644</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Failed to write address book:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Reading-a-Message"><a class="header-anchor" href="#Reading-a-Message"> </a>Reading a Message</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">pb <span class="string">&quot;go-grpc/tutorialpb&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/protobuf/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fname := <span class="string">&quot;adress&quot;</span></span><br><span class="line"></span><br><span class="line">in, err := os.ReadFile(fname)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Error reading file:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">book := &amp;pb.AddressBook&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := proto.Unmarshal(in, book); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalln(<span class="string">&quot;Failed to parse address book:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ—å‡ºè¯çµ¡ç°¿è³‡è¨Š</span></span><br><span class="line"><span class="keyword">for</span> _, p := <span class="keyword">range</span> book.People &#123;</span><br><span class="line">log.Println(<span class="string">&quot;Person ID&quot;</span>, p.Id)</span><br><span class="line"><span class="keyword">for</span> _, pn := <span class="keyword">range</span> p.Phones &#123;</span><br><span class="line"><span class="keyword">switch</span> pn.Type &#123;</span><br><span class="line"><span class="keyword">case</span> pb.PhoneType_PHONE_TYPE_HOME:</span><br><span class="line">log.Println(<span class="string">&quot;Home Number&quot;</span>, pn.Number)</span><br><span class="line"><span class="keyword">case</span> pb.PhoneType_PHONE_TYPE_WORK:</span><br><span class="line">log.Println(<span class="string">&quot;Work Number&quot;</span>, pn.Number)</span><br><span class="line"><span class="keyword">case</span> pb.PhoneType_PHONE_TYPE_MOBILE:</span><br><span class="line">log.Println(<span class="string">&quot;Cell Number&quot;</span>, pn.Number)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="ç·´ç¿’äºŒ"><a class="header-anchor" href="#ç·´ç¿’äºŒ"> </a>ç·´ç¿’äºŒ</h1><p>ç·´ç¿’é¡Œç›®: å»ºç«‹ä¸€å€‹å¯ä»¥å› Hello World çš„  gRPC Service</p><ul><li><p>å®‰è£ protocol compiler plugins</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</span><br><span class="line">go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</span><br></pre></td></tr></table></figure></li><li><p>å»ºç«‹ <code>helloWorld.proto</code></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> helloWorld;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./helloWorldpb&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello(HelloReqeust) <span class="keyword">returns</span> (HelloResponse)</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloResponse</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReqeust</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åŸ·è¡Œ <code> protoc --go_out=. --go-grpc_out=. helloworld.proto</code>ï¼Œæœƒç”¢ç”Ÿå…©å€‹æª”æ¡ˆ</p><ul><li>*<strong>.pb.go*</strong> åŒ…å«ç”¨æ–¼ protobuf æ¶ˆæ¯çš„åºåˆ—åŒ–/ååºåˆ—åŒ–çš„ç¨‹å¼</li><li>*<strong>_grpc.pb.go*</strong> åŒ…å« gRPC æœå‹™å™¨å’Œå®¢æˆ¶ç«¯çš„ç¨‹å¼</li></ul></li><li><p>å»ºç«‹ <code>server/server.go</code>ï¼Œå»ºç«‹ gRPC Server éœ€è¦å®Œæˆå…©ä»¶äº‹æƒ…</p><ul><li>å¯¦ä½œå®šç¾©åœ¨ proto æª”ä¸­çš„ service interface</li><li>å•Ÿå‹• gRPC serverï¼Œè¨­å®š service</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">pb <span class="string">&quot;go-grpc/helloWorldpb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">port = flag.Int(<span class="string">&quot;port&quot;</span>, <span class="number">50051</span>, <span class="string">&quot;The server port&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¦ä½œ Greeter gRPC</span></span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span> &#123;</span><br><span class="line">pb.UnimplementedGreeterServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> SayHello(ctx context.Context, in *pb.HelloReqeust) (*pb.HelloResponse, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;pb.HelloResponse&#123;Message: <span class="string">&quot;Hello World &quot;</span> + in.GetName()&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;    </span><br><span class="line">flag.Parse()</span><br><span class="line">    <span class="comment">// service port è¨­å®š</span></span><br><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, fmt.Sprintf(<span class="string">&quot;:%d&quot;</span>, *port))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to listen: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// å»ºç«‹ä¸€å€‹ç©ºçš„ gRPC Server</span></span><br><span class="line">s := grpc.NewServer()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¨»å†Š Greeter Service</span></span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br><span class="line">log.Printf(<span class="string">&quot;server listening at %v&quot;</span>, lis.Addr())</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å•Ÿå‹• gRPC Server</span></span><br><span class="line"><span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to serve: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>å»ºç«‹ <code>client/client.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">pb <span class="string">&quot;go-grpc/helloWorldpb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">defaultName = <span class="string">&quot;world&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">addr = flag.String(<span class="string">&quot;addr&quot;</span>, <span class="string">&quot;localhost:50051&quot;</span>, <span class="string">&quot;the address to connect to&quot;</span>)</span><br><span class="line">name = flag.String(<span class="string">&quot;name&quot;</span>, defaultName, <span class="string">&quot;Name to greet&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line"><span class="comment">// å»ºç«‹ gRPC é€£ç·š</span></span><br><span class="line">conn, err := grpc.Dial(*addr, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;did not connect: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å»ºç«‹ Client</span></span><br><span class="line">c := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Contact the server and print out its response.</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line">    <span class="comment">// å‘¼å« gRPC Service æ–¹æ³•</span></span><br><span class="line">r, err := c.SayHello(ctx, &amp;pb.HelloReqeust&#123;Name: *name&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;could not greet: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">&quot;Greeting: %s&quot;</span>, r.GetMessage())</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h1 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h1><ul><li><a href="https://protobuf.dev/getting-started/gotutorial">Go Tutorials - 1</a></li><li><a href="https://grpc.io/docs/languages/go/quickstart/">Go Tutorials -  2</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;äº†è§£ &lt;code&gt;proto&lt;/code&gt; çš„åŸºæœ¬èªæ³•å¾Œï¼Œå°±å¯ä»¥ä¾†ç”¨ä¸€å€‹ç¨‹å¼èªè¨€å¯¦ä½œ gRPC æœå‹™äº†ï¼Œæœ¬ç¯‡å°±ç”¨ Golang ä¾†ä½œç¯„ä¾‹å§ï¼Œç·´ç¿’å…§å®¹æ˜¯æ ¹æ“šå®˜æ–¹æ–‡ä»¶æ‰€æä¾›çš„æ•™å­¸å…§å®¹ï¼Œç´°ç¯€å¯ä»¥åˆ°&lt;a href=&quot;https://grpc.io/docs/languages/go/quickstart/&quot;&gt;é€™é‚Š&lt;/a&gt;é–±è®€ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="gRPC" scheme="http://blog.kevinyang.net/categories/gRPC/"/>
    
    
    <category term="gRPC" scheme="http://blog.kevinyang.net/tags/gRPC/"/>
    
  </entry>
  
  <entry>
    <title>[gRPC] é‡æ–°å­¸ç¿’ gRPC ç³»åˆ— - 1</title>
    <link href="http://blog.kevinyang.net/2023/12/29/backto-grpc-note1/"/>
    <id>http://blog.kevinyang.net/2023/12/29/backto-grpc-note1/</id>
    <published>2023-12-29T23:31:34.000Z</published>
    <updated>2023-12-30T10:00:10.171Z</updated>
    
    <content type="html"><![CDATA[<p>è·é›¢ä¸Šä¸€æ¬¡ç¢° gRPC å·²ç¶“æ˜¯ 4 å¹´å‰çš„äº‹æƒ…äº†ï¼Œç¾åœ¨åˆæœ‰æ©Ÿæœƒæ¥è§¸åˆ° gRPCï¼Œè¶é€™æ¬¡æ©Ÿæœƒé‡æ–°å°‡ gRPC ç›¸é—œçš„æ±è¥¿äº†è§£ä¸€æ¬¡</p><p>ä»€éº¼æ˜¯ gPRCï¼Œæ ¹æ“šå®˜ç¶²çš„èªªæ˜</p><blockquote><h2 id="A-high-performance-open-source-universal-RPC-framework"><a class="header-anchor" href="#A-high-performance-open-source-universal-RPC-framework"> </a>A high performance, open source universal RPC framework</h2></blockquote><p>ç‚ºä»€éº¼é¸æ“‡ gPRC å‘¢</p><blockquote><p>gRPC is a modern open source high performance Remote Procedure Call (RPC) framework that can run in any environment. It can efficiently connect services in and across data centers with pluggable support for load balancing, tracing, health checking and authentication. It is also applicable in last mile of distributed computing to connect devices, mobile applications and browsers to backend services.</p></blockquote><p>é€™è¡¨ç¤º gRPC æ˜¯ä¸€å€‹å¯ä»¥åœ¨å„ç¨®èªè¨€/ç’°å¢ƒä¸­ï¼Œåšåˆ°é«˜æ•ˆä¸”æ“´å……æ€§ä½³çš„æ¡†æ¶ï¼Œååˆ†æœ‰è¶£ã€‚ç¹¼çºŒç ”è®€ä¸‹å»</p><span id="more"></span><h1 id="Introduction"><a class="header-anchor" href="#Introduction"> </a>Introduction</h1><p><img src="image-20231230081207638.png" alt="image-20231230081207638"></p><p>é€™å¼µåœ–èªªæ˜äº† gRPC Server èˆ‡ Client é–“çš„æºé€šæ¨¡å¼ï¼ŒåŸºæ–¼ Proto çš„å®šç¾©ï¼Œä»¥ Protocol Buffer æ ¼å¼ä¾†é€²è¡Œé›™æ–¹çš„æºé€šã€‚</p><h2 id="protocol-Buffers"><a class="header-anchor" href="#protocol-Buffers"> </a>protocol Buffers</h2><p>gRPC éœ€å®šç¾© <code>.proto</code> çš„æ–‡ä»¶ï¼Œå†é€éå·¥å…·å°±å¯ä»¥ç”¢ç”Ÿå°æ‡‰èªè¨€çš„ç¨‹å¼ç¢¼ï¼Œäº†è§£ <code>proto</code> çš„èªæ³•æ˜¯å¿…é ˆçš„</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The greeter service definition.</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user&#x27;s name.</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>line 1: å®£å‘Š proto èªæ³•ç‰ˆæœ¬ï¼Œå¦‚æœä¸å®£å‘Šï¼Œé è¨­æœƒä½¿ç”¨ <code>proto2</code> èªæ³•</li><li>å®£å‘Š proto èªæ³•ç‰ˆæœ¬æœ‰äº›é™åˆ¶ï¼Œ1) å¿…é ˆæ˜¯ç¬¬ä¸€è¡Œ 2) ä¸å¯ä»¥æœ‰è¨»è§£èªªæ˜</li><li>line 4 - 7: å®šç¾© gRPC Service æœ‰å“ªäº›æ–¹æ³•å¯ä»¥ä½¿ç”¨ï¼Œæ¥å—çš„åƒæ•¸æ ¼å¼åŠå›å‚³æ ¼åˆ†åˆ¥ç‚ºä»€éº¼, PascalCase å‘½åæ³•</li><li>line 10 - 17 æ˜¯å®šç¾© <code>message</code> æ ¼å¼ï¼Œå¯ä»¥æƒ³æˆæ˜¯åœ¨å®šç¾© data model</li></ul><h3 id="Message-Type"><a class="header-anchor" href="#Message-Type"> </a>Message Type</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SearchRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> query = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int32</span> page_number = <span class="number">2</span>;</span><br><span class="line">  <span class="type">int32</span> results_per_page = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>SearchRequest</code> æœ‰å®šç¾©ä¸‰å€‹æ¬„ä½ï¼Œåˆ†åˆ¥ç‚º string <code>query</code>, å…©å€‹ integers (<code>page_number</code>, <code>results_per_page</code>)ï¼Œä½¿ç”¨ <a href="https://protobuf.dev/programming-guides/proto3/#scalar">scalar types</a></p></li><li><p>å¾Œé¢çš„æ•¸å­—å®šç¾©ï¼Œå¯ä½¿ç”¨ç¯„åœç‚º 1 åˆ° 536,870,911ï¼Œä¸èƒ½ä½¿ç”¨çš„æ•¸å­—å€é–“é™åˆ¶æœ‰</p><ol><li>ç³»çµ±é è¨­çš„ä¿ç•™å€æ®µ 19,000 åˆ° 19,999</li><li>è¢« Extension è¦ç¯„çš„ç¯„åœ (<a href="https://protobuf.dev/programming-guides/extension_declarations/">Link</a>)</li></ol></li><li><p>ä¸€å€‹ message å®šç¾©å…§çš„æ•¸å­—ä¸èƒ½é‡è¤‡</p></li><li><p>ä¸€æ—¦ message æœ‰è¢«ä½¿ç”¨ï¼Œå°±ä¸èƒ½æ›´æ”¹æ•¸å­—</p></li><li><p>æ•¸å­—ä¿®æ”¹çš„è¡Œç‚ºæ„æ€ï¼Œç­‰åŒæ¬„ä½è¢«åˆªé™¤</p></li><li><p>ç‚ºäº† message sizeï¼Œæ•ˆèƒ½è€ƒé‡ï¼Œæ•¸å­—æ‡‰å¾ 1 é–‹å§‹ä½¿ç”¨ï¼Œsize è¦å‰‡ç‚º 1 åˆ° 15 æœƒä½¿ç”¨ 1 byteï¼Œè€Œ 16 åˆ° 2047 æœƒå ç”¨ 2 bytesã€‚(Ref: <a href="https://protobuf.dev/programming-guides/encoding/#structure">Message Structure</a>)</p></li><li><p>message å¯ä»¥å®šç¾©åœ¨å–®ä¸€ <code>proto</code> æª”æ¡ˆæˆ–å¤šå€‹ï¼Œä½†æœƒå»ºè­°ä¸€å€‹ <code>proto</code> æª”æ¡ˆå…§çš„ message å®šç¾©ä¸æ‡‰è©²å¤ªå¤š</p></li><li><p>è¨»è§£ syntax :  <code>//</code> æˆ–æ˜¯ <code>/*....*/</code></p></li><li><p>å¦‚æœè¦åˆªé™¤æ¬„ä½ï¼Œéœ€è¦ <code>reserve</code> åŸæœ¬æ¬„ä½ä½¿ç”¨çš„æ•¸å­—ï¼Œå·²é¿å…æœªä¾†è¢«èª¤ç”¨</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Foo</span> &#123;</span><br><span class="line">  reserved <span class="number">2</span>, <span class="number">15</span>, <span class="number">9</span> to <span class="number">11</span>;</span><br><span class="line">  reserved <span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯å®šç¾©åŠä½¿ç”¨ <code>Enum</code> å‹åˆ¥</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum </span><span class="title class_">Corpus</span> &#123;</span><br><span class="line">  CORPUS_UNSPECIFIED = <span class="number">0</span>;</span><br><span class="line">  CORPUS_UNIVERSAL = <span class="number">1</span>;</span><br><span class="line">  CORPUS_WEB = <span class="number">2</span>;</span><br><span class="line">  CORPUS_IMAGES = <span class="number">3</span>;</span><br><span class="line">  CORPUS_LOCAL = <span class="number">4</span>;</span><br><span class="line">  CORPUS_NEWS = <span class="number">5</span>;</span><br><span class="line">  CORPUS_PRODUCTS = <span class="number">6</span>;</span><br><span class="line">  CORPUS_VIDEO = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SearchRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> query = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int32</span> page_number = <span class="number">2</span>;</span><br><span class="line">  <span class="type">int32</span> results_per_page = <span class="number">3</span>;</span><br><span class="line">  Corpus corpus = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Enum å®šç¾©æ™‚å¿…é ˆè¦æœ‰ 0ï¼Œå› ç‚º Enum å‹åˆ¥çš„é è¨­å€¼æ˜¯ 0</li></ul></li><li><p>å¦‚æœ Enum  å…§æœ‰å‡ºç¾å€¼é‡è¤‡çš„éœ€æ±‚ï¼Œé€™æ™‚å€™éœ€è¦è¨­å®š <code>allow_alias = true</code></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum </span><span class="title class_">EnumAllowingAlias</span> &#123;</span><br><span class="line">  <span class="keyword">option</span> allow_alias = <span class="literal">true</span>;</span><br><span class="line">  EAA_UNSPECIFIED = <span class="number">0</span>;</span><br><span class="line">  EAA_STARTED = <span class="number">1</span>;</span><br><span class="line">  EAA_RUNNING = <span class="number">1</span>;</span><br><span class="line">  EAA_FINISHED = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">EnumNotAllowingAlias</span> &#123;</span><br><span class="line">  ENAA_UNSPECIFIED = <span class="number">0</span>;</span><br><span class="line">  ENAA_STARTED = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// ENAA_RUNNING = 1;  // Uncommenting this line will cause a warning message.</span></span><br><span class="line">  ENAA_FINISHED = <span class="number">2</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>æœ‰ Nested Types</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">SearchResponse</span> &#123;</span><br><span class="line">  <span class="keyword">message </span><span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="type">string</span> url = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> title = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">repeated</span> <span class="type">string</span> snippets = <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">repeated</span> Result results = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SomeOtherMessage</span> &#123;</span><br><span class="line">  SearchResponse.Result result = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="åƒè€ƒç¶²ç«™"><a class="header-anchor" href="#åƒè€ƒç¶²ç«™"> </a>åƒè€ƒç¶²ç«™</h1><ul><li><a href="https://grpc.io/">gPRC</a></li><li><a href="https://protobuf.dev/programming-guides/proto3/">Protocal Language Guide (proto 3)</a></li><li><a href="https://protobuf.dev/programming-guides/style/">Protocol Buffers Documentation - Style Guide</a></li><li><a href="https://protobuf.dev/programming-guides/dos-donts/">Proto Best Practices</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è·é›¢ä¸Šä¸€æ¬¡ç¢° gRPC å·²ç¶“æ˜¯ 4 å¹´å‰çš„äº‹æƒ…äº†ï¼Œç¾åœ¨åˆæœ‰æ©Ÿæœƒæ¥è§¸åˆ° gRPCï¼Œè¶é€™æ¬¡æ©Ÿæœƒé‡æ–°å°‡ gRPC ç›¸é—œçš„æ±è¥¿äº†è§£ä¸€æ¬¡&lt;/p&gt;
&lt;p&gt;ä»€éº¼æ˜¯ gPRCï¼Œæ ¹æ“šå®˜ç¶²çš„èªªæ˜&lt;/p&gt;
&lt;blockquote&gt;
&lt;h2 id=&quot;A-high-performance-open-source-universal-RPC-framework&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#A-high-performance-open-source-universal-RPC-framework&quot;&gt; &lt;/a&gt;A high performance, open source universal RPC framework&lt;/h2&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç‚ºä»€éº¼é¸æ“‡ gPRC å‘¢&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;gRPC is a modern open source high performance Remote Procedure Call (RPC) framework that can run in any environment. It can efficiently connect services in and across data centers with pluggable support for load balancing, tracing, health checking and authentication. It is also applicable in last mile of distributed computing to connect devices, mobile applications and browsers to backend services.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;é€™è¡¨ç¤º gRPC æ˜¯ä¸€å€‹å¯ä»¥åœ¨å„ç¨®èªè¨€/ç’°å¢ƒä¸­ï¼Œåšåˆ°é«˜æ•ˆä¸”æ“´å……æ€§ä½³çš„æ¡†æ¶ï¼Œååˆ†æœ‰è¶£ã€‚ç¹¼çºŒç ”è®€ä¸‹å»&lt;/p&gt;</summary>
    
    
    
    <category term="gRPC" scheme="http://blog.kevinyang.net/categories/gRPC/"/>
    
    
    <category term="gRPC" scheme="http://blog.kevinyang.net/tags/gRPC/"/>
    
  </entry>
  
  <entry>
    <title>[Angular] Angular 17 RC æ¶å…ˆè©¦ç”¨</title>
    <link href="http://blog.kevinyang.net/2023/10/29/angular-v17-small-peek/"/>
    <id>http://blog.kevinyang.net/2023/10/29/angular-v17-small-peek/</id>
    <published>2023-10-29T02:06:57.000Z</published>
    <updated>2023-12-30T10:00:10.171Z</updated>
    
    <content type="html"><![CDATA[<p>Angular 17 å¿«ä¸Šç·šäº†ï¼Œå·²ç¶“çœ‹åˆ° RC ç‰ˆé‡‹å‡ºï¼Œç•¶ç„¶è¦å…ˆç©çœ‹çœ‹ï¼Œé€™ä¸€ç‰ˆè®“äººèˆˆå¥®çš„ä¸€å®šæ˜¯æ–°çš„ flow syntaxï¼Œé™¤æ­¤ä¹‹å¤–é‚„æœ‰ä»€éº¼æœ‰è¶£çš„æ±è¥¿å—? é€™ç¯‡æœƒå¿«é€Ÿç­†è¨˜ä¸€ä¸‹</p><span id="more"></span><p>Angular v17 å¹¾å€‹ Highlight é‡é»</p><ol><li>æ–°å°ˆæ¡ˆé è¨­ä½¿ç”¨ Standalones API</li><li>å»ºç«‹æ–°å°ˆæ¡ˆæ™‚ï¼Œå¯ä»¥é¸æ“‡å•Ÿå‹• Server-side Rendering (SSR)</li><li>new flow syntax (<a href="https://github.com/angular/angular/discussions/51241">RFC é€£çµ</a>)</li></ol><h2 id="Standalone-by-Default"><a class="header-anchor" href="#Standalone-by-Default"> </a>Standalone by Default</h2><p>ç›¸ä¿¡ç¬¬ä¸€é»æ‡‰è©²ä¸ç”¨å¤šèªªä»€éº¼ï¼Œå¦‚æœæœ‰é–‹å§‹å¯« standalone component çš„æœ‹å‹ï¼Œå¤§æ¦‚éƒ½æœƒè¦ºå¾—é–‹ç™¼é«”é©—é‚„ä¸éŒ¯ï¼Œå°‘äº†ä¸€äº›å¤šé¤˜çš„äº‹æƒ…è¦åšï¼Œåœ¨ Angular 17 å»ºç«‹æ–°å°ˆæ¡ˆæ™‚å°±ä¸éœ€è¦å†å¤šåŠ  <code>--standalone</code> çš„åƒæ•¸ï¼Œé è¨­å°±æœƒä½¿ç”¨é–‹å•Ÿ standalone çš„æ¨¡å¼ğŸ˜</p><p><img src="image-20231029101543861.png" alt="image-20231029101543861"></p><p>å¦‚ä½•å¾ <code>ngModule</code> æ¬åˆ° <code>standalone</code>ï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹æä¾›çš„<a href="https://angular.io/guide/standalone-migration">æ¬å®¶æ‰‹å†Š</a></p><h2 id="SSR"><a class="header-anchor" href="#SSR"> </a>SSR</h2><p>éå¾€æœ‰å¯«é Angular SSR çš„æœ‹å‹å°±çŸ¥é“é‚£å€‹æ­¥é©Ÿæœ‰å¤šéº¼ç¹ç‘£ï¼Œç¾åœ¨åªè¦åœ¨å»ºç«‹å°ˆæ¡ˆæ™‚ï¼Œé¸æ“‡å•Ÿç”¨ SSR åŠŸèƒ½æ™‚ï¼ŒAngular CLI å°±æœƒè‡ªå‹•å¹«æˆ‘å€‘åŠ å…¥ SSR æ‰€éœ€çš„ç›¸é—œæª”æ¡ˆï¼Œä¹Ÿå¯ä»¥å¾ <code>angular.json</code> å…§åšè¨­å®š</p><p>Angular hydration åœ¨ v17 ä¹Ÿæ˜¯é è¨­å•Ÿå‹•ï¼Œ Hydration ç›¸é—œè³‡è¨Šå¯ä»¥åƒè€ƒé€™ç¯‡<a href="https://angular.io/guide/hydration">æ–‡ä»¶</a></p><h2 id="Flow-Syntax"><a class="header-anchor" href="#Flow-Syntax"> </a>Flow Syntax</h2><p>é€™æ–°åŠŸèƒ½æ‡‰è©²ä¸ç”¨å¤šèªªäº†å§ï¼Œåœ¨ preview éšæ®µå°±å·²ç¶“æœ‰ä¸å°‘å¤§ç¥åœ¨åšå˜—è©¦ï¼Œè‡ªå·±ä¹Ÿæœ‰ç©ä¸€ä¸‹ï¼ŒçœŸçš„å¾ˆæœŸå¾…ï¼Œé›–ç„¶éå¾€ç¿’æ…£ä½¿ç”¨ directive ä¾†æ§åˆ¶ç•«é¢çš„äººï¼Œæˆ‘ç›¸ä¿¡æ–°çš„å¯«æ³•æœƒè®“ template æ›´å®¹æ˜“é–±è®€å’Œç®¡ç†ï¼Œä¹Ÿå¾ˆæœŸå¾… <code>@defer</code> çš„å¨åŠ›ã€‚</p><p>é€™é‚Šä¹Ÿæä¾›å¹¾ç¯‡æ–‡ç« çµ¦å¤§å®¶</p><ol><li><a href="https://blog.angular.io/meet-angulars-new-control-flow-a02c6eee7843">Meet Angularâ€™s New Control Flow</a></li><li><a href="https://www.youtube.com/watch?v=77tKyAOFO4o">YouTube: Iâ€™ve been using the new Angular control flow syntax for templates (itâ€™s good)</a></li><li><a href="https://netbasal.com/a-comprehensive-guide-to-angulars-defer-block-468c74048df4">A Comprehensive Guide to Angularâ€™s Defer Block</a></li></ol><h2 id="Final-Thought"><a class="header-anchor" href="#Final-Thought"> </a>Final Thought</h2><p>Angular Team å¾ v16 å¾Œå°±é™¸çºŒæä¾›å¾ˆå¤šè®“äººé©šè±”çš„æ–°åŠŸèƒ½ï¼ŒåŒæ™‚ä¹Ÿç‚º Angular è³¦äºˆæ–°èƒ½é‡ï¼ŒçœŸå¿ƒæœŸå¾…æ¥ä¸‹ä¾†çš„ç™¼å±•ï¼Œä¾‹å¦‚ standalone component, zone.js optional ç­‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Angular 17 å¿«ä¸Šç·šäº†ï¼Œå·²ç¶“çœ‹åˆ° RC ç‰ˆé‡‹å‡ºï¼Œç•¶ç„¶è¦å…ˆç©çœ‹çœ‹ï¼Œé€™ä¸€ç‰ˆè®“äººèˆˆå¥®çš„ä¸€å®šæ˜¯æ–°çš„ flow syntaxï¼Œé™¤æ­¤ä¹‹å¤–é‚„æœ‰ä»€éº¼æœ‰è¶£çš„æ±è¥¿å—? é€™ç¯‡æœƒå¿«é€Ÿç­†è¨˜ä¸€ä¸‹&lt;/p&gt;</summary>
    
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/categories/Angular/"/>
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title>[Go] VSCode å…§çš„ Test Coverage è¨­å®šå°æŠ€å·§</title>
    <link href="http://blog.kevinyang.net/2023/10/15/golang-test-coverage-tips/"/>
    <id>http://blog.kevinyang.net/2023/10/15/golang-test-coverage-tips/</id>
    <published>2023-10-15T03:43:40.000Z</published>
    <updated>2023-12-30T10:00:10.171Z</updated>
    
    <content type="html"><![CDATA[<p>VSCode æ‡‰è©²æ˜¯å¾ˆå¤šäººçš„ä¸»é–‹ç™¼å·¥å…·ï¼Œå°¤å…¶åœ¨é€™å€‹ä¸€å€‹äººè¦èº«å…¼å¤šèªè¨€é–‹ç™¼æ™‚ï¼ŒVSCode çœŸçš„æ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡ï¼Œè€Œ Go åœ¨ VSCode ä¸Šçš„é–‹ç™¼é«”é©—ï¼Œæ­é… <a href="https://marketplace.visualstudio.com/items?itemName=golang.Go">Go Exntesion</a> å¾Œï¼ŒçœŸçš„æ²’ä»€éº¼å¥½æŒ‘å‰”çš„ï¼Œä½†é‚„æ˜¯æœ‰äº›è¨­å®šéœ€è¦åšèª¿æ•´ï¼Œé€™ç¯‡æœƒç­†è¨˜ä¸€äº›è¿‘æœŸé‡å°æ¸¬è©¦éƒ¨åˆ†æ‰€åšçš„è¨­å®šèª¿æ•´ã€‚</p><span id="more"></span><h2 id="èª¿æ•´-Coverage-çš„é¡¯ç¤ºæ–¹å¼"><a class="header-anchor" href="#èª¿æ•´-Coverage-çš„é¡¯ç¤ºæ–¹å¼"> </a>èª¿æ•´ Coverage çš„é¡¯ç¤ºæ–¹å¼</h2><ol><li><p>é–‹å•Ÿ Coverage çš„é¡¯ç¤ºï¼Œå…ˆè¬›æ•ˆæœ<img src="image-20231015115046331.png" alt="image-20231015115046331"></p><p>å¾ç•«é¢çš„å·¦é‚Šå°±å¯ä»¥çŸ¥é“æœ‰å“ªäº›ç¨‹å¼å°šæœªè¢«è¦†è“‹åˆ°ï¼Œåœ¨æ’°å¯« test case æ™‚æ˜¯å¾ˆç›´è¦ºçš„ï¼Œè¨­å®šæ–¹å¼å¦‚ä¸‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;go.coverOnSave&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;go.coverageDecorator&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gutter&quot;</span><span class="punctuation">,</span> <span class="comment">// é è¨­æ˜¯ hightlight</span></span><br><span class="line">    <span class="attr">&quot;coveredHighlightColor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(64,128,128,0.5)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uncoveredHighlightColor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(128,64,64,0.25)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;coveredGutterStyle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blockgreen&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uncoveredGutterStyle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blockred&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li><code>coverOnSave</code>: è¨­å®šç‚º <code>true</code> æ™‚ï¼Œåœ¨ save æª”æ¡ˆæ™‚æœƒåŸ·è¡Œ <code>go test -coverprofile</code></li><li><code>go.coverageDecorator.type</code> æœ‰å…©ç¨®æ¨¡å¼ï¼Œ<code>highlight</code> å’Œ <code>gutter</code>ï¼Œè‡ªå·±æ˜¯æ¯”è¼ƒåæ„› <code>gutter</code> çš„æ¨¡å¼ï¼Œå„ä½å¯ä»¥è‡ªå·±ç©çœ‹çœ‹</li></ul><h2 id="é¡å¤–ç™¼ç¾"><a class="header-anchor" href="#é¡å¤–ç™¼ç¾"> </a>é¡å¤–ç™¼ç¾</h2><p>åŸä¾† Go extension å…§æœ‰æ”¯æ´ generate unit test  çš„åŠŸèƒ½ï¼Œé€™æ¨£é‚„æœ‰ä»€éº¼ç†ç”±ä¸å¯«æ¸¬è©¦å‘¢</p><p><img src="image-20231015123047230.png" alt="image-20231015123047230"></p><p>æˆ–æ˜¯ç”¨ command Palette æ–¹å¼åŸ·è¡Œ</p><p><img src="image-20231015123120869.png" alt="image-20231015123120869"></p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;VSCode æ‡‰è©²æ˜¯å¾ˆå¤šäººçš„ä¸»é–‹ç™¼å·¥å…·ï¼Œå°¤å…¶åœ¨é€™å€‹ä¸€å€‹äººè¦èº«å…¼å¤šèªè¨€é–‹ç™¼æ™‚ï¼ŒVSCode çœŸçš„æ˜¯å€‹ä¸éŒ¯çš„é¸æ“‡ï¼Œè€Œ Go åœ¨ VSCode ä¸Šçš„é–‹ç™¼é«”é©—ï¼Œæ­é… &lt;a href=&quot;https://marketplace.visualstudio.com/items?itemName=golang.Go&quot;&gt;Go Exntesion&lt;/a&gt; å¾Œï¼ŒçœŸçš„æ²’ä»€éº¼å¥½æŒ‘å‰”çš„ï¼Œä½†é‚„æ˜¯æœ‰äº›è¨­å®šéœ€è¦åšèª¿æ•´ï¼Œé€™ç¯‡æœƒç­†è¨˜ä¸€äº›è¿‘æœŸé‡å°æ¸¬è©¦éƒ¨åˆ†æ‰€åšçš„è¨­å®šèª¿æ•´ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Go" scheme="http://blog.kevinyang.net/categories/Go/"/>
    
    
    <category term="Go" scheme="http://blog.kevinyang.net/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>[Go] time package</title>
    <link href="http://blog.kevinyang.net/2023/10/08/golang-note-time-package/"/>
    <id>http://blog.kevinyang.net/2023/10/08/golang-note-time-package/</id>
    <published>2023-10-08T08:25:27.000Z</published>
    <updated>2023-12-30T10:00:10.171Z</updated>
    
    <content type="html"><![CDATA[<p>Go çš„ time packageï¼Œä¸»è¦æä¾› time ç›¸é—œçš„åŠŸèƒ½ï¼Œé€™ç¯‡ç­†è¨˜æ•´ç†ä¸€äº›å¸¸ç”¨çš„ function</p><span id="more"></span><p>å¼•ç”¨æ–¹å¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;time&quot;</span></span><br></pre></td></tr></table></figure><h2 id="å¸¸ç”¨æ–¹æ³•"><a class="header-anchor" href="#å¸¸ç”¨æ–¹æ³•"> </a>å¸¸ç”¨æ–¹æ³•</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">time.Now() <span class="comment">// ç›®å‰æ™‚é–“ (with æ™‚å€è³‡è¨Š)</span></span><br><span class="line">time.Date(<span class="number">2023</span>,<span class="number">10</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,&lt;location&gt;) <span class="comment">// å»ºç«‹æ—¥æœŸ</span></span><br><span class="line">time.Now().Unix() <span class="comment">// timestamp</span></span><br><span class="line">time.Unix(<span class="number">1595569527</span>, <span class="number">0</span>) <span class="comment">// timestamp è½‰æ›å› time</span></span><br><span class="line">time.Now().Format(<span class="string">&quot;2006/1/2&quot;</span>) <span class="comment">// æ™‚é–“è¼¸å‡ºæ ¼å¼è¨­å®š, é€²æ­¥èªªæ˜å¦‚ä¸‹</span></span><br><span class="line">time.Now().Weekday() <span class="comment">// é¡¯ç¤ºç›®å‰å‘¨å¹¾ Sunday, Monday,...</span></span><br><span class="line"></span><br><span class="line">time.LoadLocation(<span class="string">&quot;Asia/Taipei&quot;</span>) <span class="comment">// å–å¾—æ™‚å€è³‡è¨Šï¼Œåœ¨å»ºç«‹ time.Date æ™‚æœƒç”¨åˆ°</span></span><br><span class="line">time.LoadLocation(<span class="string">&quot;Local&quot;</span>) <span class="comment">// å–å¾—æœ¬åœ°æ™‚å€</span></span><br><span class="line"></span><br><span class="line">time.Now().Add(<span class="number">6</span> * time.Hour) <span class="comment">// åŠ  6 å°æ™‚</span></span><br><span class="line">time.now().AddDate(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>) <span class="comment">// åŠ ä¸€å¹´</span></span><br><span class="line"></span><br><span class="line">time.Now().Truncate(time.Minute) <span class="comment">// å–åˆ°å¹´æœˆæ—¥æ™‚åˆ†ï¼Œç§’ç‚º 0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>time Format å°æ‡‰çš„æ•¸å­—</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æœˆä»½ 1,01,Jan,January</span><br><span class="line">æ—¥ã€€ 2,02,_2</span><br><span class="line">æ™‚ã€€ 3,03,15,PM,pm,AM,am</span><br><span class="line">åˆ†ã€€ 4,04</span><br><span class="line">ç§’ã€€ 5,05</span><br><span class="line">å¹´ã€€ 06,2006</span><br><span class="line">æ™‚å€ <span class="string">-07</span>,<span class="string">-0700</span>,Z0700,Z07:00,<span class="string">-07</span>:00,MST</span><br><span class="line">å‘¨å¹¾ Mon,Monday</span><br></pre></td></tr></table></figure></li><li><p><code>time.Add</code> è£œå……èªªæ˜</p><p><code>time.Add(&lt;duration&gt;)</code>, duration çš„å–®ä½, Go æœ‰æä¾›ä»¥ä¸‹å¹¾ç¨®</p><ol><li><code>time.Second</code></li><li><code>time.Minute</code></li><li><code>time.Hour</code></li></ol><p><code>time.Add()</code> æœƒå›å‚³ <code>time.Time</code> çš„å‹åˆ¥ï¼Œè¡¨ç¤ºå¯ä»¥ä¸²æ¥ä¸‹å»ï¼Œä¾‹å¦‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time.Now().AddDate(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>).Add(<span class="number">-1</span> * time.Nanosecond)</span><br></pre></td></tr></table></figure></li><li><p><code>time.AddDate</code> è£œå……èªªæ˜ï¼Œfunction æ¥å—ä¸‰å€‹æ•¸å­—ï¼Œåˆ†åˆ¥ä»£è¡¨ å¹´ï¼Œæœˆï¼Œæ—¥</p></li></ul><h2 id="å…¶ä»–-API"><a class="header-anchor" href="#å…¶ä»–-API"> </a>å…¶ä»– API</h2><ul><li><p>æ¯”è¼ƒæ™‚é–“</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">now := time.Now()</span><br><span class="line">oneDayAgo := now.AddDate(<span class="number">0</span>, <span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">isOneDayAgoBeforeNow := oneDayAgo.Before(now) <span class="comment">// true</span></span><br><span class="line">isOneDayAgoAfterNow := oneDayAgo.After(now) <span class="comment">// false</span></span><br></pre></td></tr></table></figure></li><li><p>è¨ˆæ™‚å™¨</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time.After(duration)</span><br></pre></td></tr></table></figure><p>æ¯å¤šå°‘æ™‚é–“åŸ·è¡Œä¸€æ¬¡</p></li><li><p>è¨ˆç®—æ™‚é–“é•·åº¦</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start := time.Now()</span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">fmt.Println(time.Since(start))</span><br></pre></td></tr></table></figure></li><li><p>è¨ˆç®—æ™‚é–“å·®</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start := time.Now()</span><br><span class="line">mockDate := time.Date(<span class="number">2023</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, start.Location())</span><br><span class="line">fmt.Println(start, mockDate.Sub(start))</span><br></pre></td></tr></table></figure><p><img src="image-20231008172503519.png" alt="image-20231008172503519"></p></li></ul><h2 id="Time-Duration-Struct-æ–¹æ³•"><a class="header-anchor" href="#Time-Duration-Struct-æ–¹æ³•"> </a>Time/Duration Struct æ–¹æ³•</h2><h3 id="Time"><a class="header-anchor" href="#Time"> </a>Time</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Add(d Duration) Time</span><br><span class="line">AddDate(yars <span class="type">int</span> ,months <span class="type">int</span>, days <span class="type">int</span>) Time</span><br><span class="line">After(u Time) <span class="type">bool</span></span><br><span class="line">Before(u  Time) <span class="type">bool</span></span><br><span class="line">Date() (year <span class="type">int</span>, month Month, day <span class="type">int</span>)</span><br><span class="line">Month() Month</span><br><span class="line">Day() <span class="type">int</span></span><br><span class="line">Hour() <span class="type">int</span></span><br><span class="line">Minute() <span class="type">int</span></span><br><span class="line">Second() <span class="type">int</span></span><br><span class="line">Year() <span class="type">int</span> </span><br><span class="line">Weekday() Weekday </span><br><span class="line">YearDay() <span class="type">int</span> </span><br><span class="line">ISOWeek() (year, week <span class="type">int</span>)</span><br><span class="line">Naosecond() <span class="type">int</span> </span><br><span class="line">Zone() (name <span class="type">string</span>, offset <span class="type">int</span>)</span><br><span class="line">Equal(u Time) <span class="type">bool</span> </span><br><span class="line">Round(Duration d)</span><br><span class="line">Truncate(Duration d)</span><br><span class="line">Format(layout <span class="type">string</span>) <span class="type">string</span></span><br><span class="line">Sub(t Time) </span><br><span class="line">UTC() Time </span><br><span class="line">Unix() <span class="type">int64</span> </span><br><span class="line">UnixNano() <span class="type">int64</span> </span><br></pre></td></tr></table></figure><h3 id="Duration"><a class="header-anchor" href="#Duration"> </a>Duration</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Hours()</span><br><span class="line">Minutes()</span><br><span class="line">Seconds()</span><br><span class="line">Milliseconds()</span><br><span class="line">Microseconds()</span><br><span class="line">Nanoseconds()</span><br><span class="line">String()</span><br><span class="line">Round(d)</span><br><span class="line">Truncate(d)</span><br><span class="line">FixedZone()</span><br><span class="line">LoadLocation(name <span class="type">string</span>)</span><br><span class="line">LoadLocation(<span class="string">&quot;Local&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="ç·´ç¿’é¡Œ"><a class="header-anchor" href="#ç·´ç¿’é¡Œ"> </a>ç·´ç¿’é¡Œ</h2><p>å¯«ä¸€å€‹ function å–å¾—ä¸€å¤©çš„é–‹å§‹èˆ‡çµæŸæ™‚é–“ï¼Œé¡ä¼¼ date-fns çš„ <code>startOfDay</code> å’Œ <code>endOfDay</code> çµåˆ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DateRange</span><span class="params">(t time.Time)</span></span> (beginOfDate time.Time, endOfDate time.Time) &#123;</span><br><span class="line">year, month, day := t.Date()</span><br><span class="line">beginOfDate = time.Date(year, month, day, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, t.Location())</span><br><span class="line">endOfDate = beginOfDate.AddDate(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>).Add(<span class="number">-1</span> * time.Nanosecond)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> beginOfDate, endOfDate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">now := time.Now()</span><br><span class="line">startOfDay, endOfDay := DateRange(now)</span><br><span class="line">fmt.Println(startOfDay, endOfDay)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="image-20231008173942719.png" alt="image-20231008173942719"></p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://pkg.go.dev/time">Go time package Documentation</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Go çš„ time packageï¼Œä¸»è¦æä¾› time ç›¸é—œçš„åŠŸèƒ½ï¼Œé€™ç¯‡ç­†è¨˜æ•´ç†ä¸€äº›å¸¸ç”¨çš„ function&lt;/p&gt;</summary>
    
    
    
    <category term="Go" scheme="http://blog.kevinyang.net/categories/Go/"/>
    
    
    <category term="Go" scheme="http://blog.kevinyang.net/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>[Angular] å®˜æ–¹æ–‡ä»¶çš„ HttpTestingController ç¯„ä¾‹é‡åˆ° jest æ™‚ï¼Œçµæœä¸æ˜¯æƒ³åƒçš„é‚£æ¨£ï¼Œå°å¿ƒ</title>
    <link href="http://blog.kevinyang.net/2023/10/06/jest-with-httpTestingController/"/>
    <id>http://blog.kevinyang.net/2023/10/06/jest-with-httpTestingController/</id>
    <published>2023-10-06T12:07:29.000Z</published>
    <updated>2023-12-30T10:00:10.171Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨å¯« http service æ¸¬è©¦æ™‚ï¼Œç„¡æ„é–“æ’åˆ°é€™å€‹å•é¡Œï¼Œåˆ†äº«é€™å€‹å°é›·çµ¦å¤§å®¶ï¼Œé¿å…æ­»çš„ä¸æ˜ä¸ç™½ï¼Œ</p><p>é€™ç¯‡ <a href="https://angular.io/guide/http-test-requests">HTTP client - Test requests</a> å…§èªªæ˜å¦‚ä½•ä½¿ç”¨ <code>HttpTestingController</code> é€²è¡Œ http request çš„æ¸¬è©¦ï¼Œè€Œå› ç‚ºå¾ŒæœŸçš„å°ˆæ¡ˆæˆ‘éƒ½æ˜¯ä½¿ç”¨ Nx ä¾†å»ºç«‹ï¼ŒNx å»ºç«‹çš„å°ˆæ¡ˆæ˜¯ä½¿ç”¨  Jest ä¾†è·‘ Unit Test. ä¸çŸ¥é“æ˜¯å¹¸é‹é‚„æ˜¯æ€æ¨£ï¼Œç«Ÿç„¶é‡åˆ°è¶…ä¹é æœŸçš„çµæœ</p><span id="more"></span><p>æƒ…å¢ƒæ˜¯é€™æ¨£çš„ï¼Œæ¸¬è©¦ä¸€å€‹ server å‘¼å«  API å›å‚³çš„çµæœæ˜¯å¦ç¬¦åˆé æœŸï¼Œå¯«æ³•æ˜¯</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">callApi</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">get</span>(<span class="string">&#x27;/data&#x27;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">    <span class="title function_">catchError</span>(<span class="function">() =&gt;</span> <span class="title function_">of</span>([])),</span><br><span class="line">    <span class="title function_">map</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> [x])</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¸¬è©¦ç¨‹å¼ç¢¼ç‚º</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;test api&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> mockData = &#123; <span class="attr">name</span>: <span class="string">&#x27;Kevin&#x27;</span> &#125;;</span><br><span class="line">  service.<span class="title function_">callApi</span>().<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">expect</span>(result).<span class="title function_">toEqual</span>([]);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> req = httpTestingController.<span class="title function_">expectOne</span>(<span class="string">&#x27;/data&#x27;</span>);</span><br><span class="line">  req.<span class="title function_">flush</span>(mockData);</span><br><span class="line"></span><br><span class="line">  httpTestingController.<span class="title function_">verify</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°çš„æ¸¬è©¦é æœŸçµæœæœƒæ˜¯ fail çš„ï¼Œå› ç‚º line: 5 çš„çµæœç†ç•¶ç‚º <code>[mockData]</code>ï¼Œä½†å¯¦éš›è·‘å®Œæ¸¬è©¦çš„çµæœå»æ˜¯ passed</p><p><img src="image-20231006202133288.png" alt="image-20231006202133288"></p><p>é€™æ™‚å€™ç¬¬ä¸€å€‹æƒ³æ³•æœƒæ˜¯éåŒæ­¥çš„é—œä¿‚ï¼Œå¯èƒ½è¦ç”¨åˆ° callback çš„æ–¹å¼ï¼Œæ‰€ä»¥èª¿æ•´äº† test case ï¼Œèª¿æ•´å¾Œå¦‚ä¸‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;test api&#x27;</span>, <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> mockData = &#123; <span class="attr">name</span>: <span class="string">&#x27;Kevin&#x27;</span> &#125;;</span><br><span class="line">   service.<span class="title function_">callApi</span>().<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">     <span class="attr">next</span>: <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="title function_">expect</span>(result).<span class="title function_">toEqual</span>([]);</span><br><span class="line">       <span class="title function_">done</span>();</span><br><span class="line">     &#125;,</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">const</span> req = httpTestingController.<span class="title function_">expectOne</span>(<span class="string">&#x27;/data&#x27;</span>);</span><br><span class="line">   req.<span class="title function_">flush</span>(mockData);</span><br><span class="line"></span><br><span class="line">   httpTestingController.<span class="title function_">verify</span>();</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><p>ç¢ºå¯¦ä¹Ÿè®“ test failed äº†</p><p><img src="image-20231006202257967.png" alt="image-20231006202257967"></p><p>ä½†æ˜¯æ¥è‘—å™´äº†å¦å¤–ä¸€å€‹éŒ¯èª¤è¨Šæ¯, ç«Ÿç„¶èªª <code>done()</code> å¿…é ˆè¦å‘¼å«åˆ°ï¼Œtimeout.</p><p><img src="image-20231006202352969.png" alt="image-20231006202352969"></p><p>ç¶“éä¸€æ®µæ™‚é–“çš„ç ”ç©¶ï¼Œç™¼ç¾åŸä¾†æ˜¯é€™å€‹åŸå› </p><blockquote><p>If <code>done()</code> is never called, the test will fail (with timeout error), which is what you want to happen.</p><p>If the <code>expect</code> statement fails, it throws an error and <code>done()</code> is not called. If we want to see in the test log why it failed, we have to wrap <code>expect</code> in a <code>try</code> block and pass the error in the <code>catch</code> block to <code>done</code>. Otherwise, we end up with an opaque timeout error that doesnâ€™t show what value was received by <code>expect(data)</code>.</p></blockquote><p>åœ¨ jest å…§å¦‚æœ expect çš„çµæœä¸ç¬¦åˆé æœŸï¼Œæœƒå™´ exceptionï¼Œæ‰€ä»¥ç•¶ä½¿ç”¨ <code>done</code> callback æ™‚ï¼Œéœ€è¦ç”¨ try catch åŒ…èµ·ä¾†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title function_">it</span>(<span class="string">&#x27;test api&#x27;</span>, <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> mockData = &#123; <span class="attr">name</span>: <span class="string">&#x27;Kevin&#x27;</span> &#125;;</span><br><span class="line">    service.<span class="title function_">callApi</span>().<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">      <span class="attr">next</span>: <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="title function_">expect</span>(result).<span class="title function_">toEqual</span>([]);</span><br><span class="line">          <span class="title function_">done</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="title function_">done</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> req = httpTestingController.<span class="title function_">expectOne</span>(<span class="string">&#x27;/data&#x27;</span>);</span><br><span class="line">    req.<span class="title function_">flush</span>(mockData);</span><br><span class="line"></span><br><span class="line">    httpTestingController.<span class="title function_">verify</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>é€™æ¨£æ”¹å¯«å®Œï¼Œtimeout çš„éŒ¯èª¤è¨Šæ¯å°±æ²’æœ‰å†å‡ºç¾äº†ã€‚çœ‹ä¾†éå¾€æ²’æœ‰ç‰¹åˆ¥ç•™æ„åˆ°é€™å¡Šï¼ŒçœŸçš„æ˜¯å¤ªä¸å°å¿ƒäº†ã€‚æ‰€ä»¥å¯«é€™ç¯‡ç­†è¨˜åˆ†äº«çµ¦å¤§å®¶</p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://jestjs.io/docs/asynchronous#callbacks">https://jestjs.io/docs/asynchronous#callbacks</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»Šå¤©åœ¨å¯« http service æ¸¬è©¦æ™‚ï¼Œç„¡æ„é–“æ’åˆ°é€™å€‹å•é¡Œï¼Œåˆ†äº«é€™å€‹å°é›·çµ¦å¤§å®¶ï¼Œé¿å…æ­»çš„ä¸æ˜ä¸ç™½ï¼Œ&lt;/p&gt;
&lt;p&gt;é€™ç¯‡ &lt;a href=&quot;https://angular.io/guide/http-test-requests&quot;&gt;HTTP client - Test requests&lt;/a&gt; å…§èªªæ˜å¦‚ä½•ä½¿ç”¨ &lt;code&gt;HttpTestingController&lt;/code&gt; é€²è¡Œ http request çš„æ¸¬è©¦ï¼Œè€Œå› ç‚ºå¾ŒæœŸçš„å°ˆæ¡ˆæˆ‘éƒ½æ˜¯ä½¿ç”¨ Nx ä¾†å»ºç«‹ï¼ŒNx å»ºç«‹çš„å°ˆæ¡ˆæ˜¯ä½¿ç”¨  Jest ä¾†è·‘ Unit Test. ä¸çŸ¥é“æ˜¯å¹¸é‹é‚„æ˜¯æ€æ¨£ï¼Œç«Ÿç„¶é‡åˆ°è¶…ä¹é æœŸçš„çµæœ&lt;/p&gt;</summary>
    
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/categories/Angular/"/>
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title>[VSCode] Rest Client Extension</title>
    <link href="http://blog.kevinyang.net/2023/09/02/vscode-rest-client-note/"/>
    <id>http://blog.kevinyang.net/2023/09/02/vscode-rest-client-note/</id>
    <published>2023-09-02T14:30:17.000Z</published>
    <updated>2023-12-30T10:00:10.167Z</updated>
    
    <content type="html"><![CDATA[<p>é™¤äº† Postmanï¼Œåœ¨ VS Code å…§é‚„æœ‰å…¶ä»–é¡ä¼¼çš„å¥—ä»¶å¯ä»¥é¸æ“‡ï¼Œä¾‹å¦‚æœ¬ç¯‡ç­†è¨˜çš„ä¸»è§’ <code>Rest Client</code></p><span id="more"></span><p><img src="image-20230902223304534.png" alt="image-20230902223304534"></p><p>å¯ä»¥å¾ VS Code çš„ extension market å…§æœå°‹ä¸¦å®‰è£ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿå¾ˆç°¡å–®ï¼Œåªè¦æª”åçš„çµæœæ˜¯ <code>.http</code> æˆ–æ˜¯ <code>.rest</code> éƒ½æ˜¯ <code>Rest Client</code> å¯ä»¥æ”¯æ´çš„æª”æ¡ˆé¡å‹ï¼Œå…ˆç”¨ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ä½œå±•ç¤º</p><p><img src="image-20230902223629295.png" alt="image-20230902223629295"></p><p>çœŸçš„å¾ˆç°¡å–®ä½¿ç”¨ï¼Œä½†ç•¶ç„¶ä¸åªæœ‰é€™æ¨£ï¼Œé€™ç¯‡ç­†è¨˜æœƒè¨˜éŒ„æˆ‘åœ¨ä½¿ç”¨ä¸Šçš„ä¸€äº›å¿ƒå¾—æˆ–æŠ€å·§</p><h2 id="ç­†è¨˜å¿ƒå¾—"><a class="header-anchor" href="#ç­†è¨˜å¿ƒå¾—"> </a>ç­†è¨˜å¿ƒå¾—</h2><ol><li><p><code>Content-Type</code> è¨­å®š: åœ¨åš POST æˆ–æ˜¯ PUT æ™‚æœƒå‚³ JSON æ ¼å¼ç‚º body å…§å®¹ï¼Œé€™æ™‚å€™å°±éœ€è¦è¨­å®š  <code>Content-Type</code>ï¼Œè¨­å®šæ–¹å¼å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST https://jsonplaceholder.typicode.com/todos</span><br><span class="line">Content-Type: application/json</span><br></pre></td></tr></table></figure></li><li><p>å¯ä½¿ç”¨ <code>###</code> ä¾†åˆ†éš” Request å…§å®¹</p></li><li><p><code>#</code> æˆ–æ˜¯ <code>//</code> å¯ç”¨ä¾†å¯«è¨»è§£<img src="image-20230902225112808.png" alt="image-20230902225112808"></p></li><li><p>è‡ªå®šç¾©è®Šæ•¸</p><ol><li><p>Environment variables å¯å®šç¾©åœ¨ VS Code setting å…§ï¼Œé€™ç¨®è®Šæ•¸å¯ä»¥è·¨æª”æ¡ˆä½¿ç”¨</p></li><li><p>File variables: å®šç¾©åœ¨ <code>.http</code> æª”æ¡ˆå…§</p></li><li><p>Request variables: å°‡ Request çš„å…§å®¹å­˜åœ¨ <code>Request variable</code> å…§ï¼Œä¾›åŒä¸€å€‹æª”æ¡ˆå…§çš„å…¶ä»– request ä½¿ç”¨ï¼Œ<code># @name &lt;&lt;request name&gt;&gt;</code>  æˆ–æ˜¯ <code>// @name &lt;&lt;request name&gt;&gt;</code> å®šç¾© request variable</p></li><li><p>é€é <code># @prompt &#123;var1&#125; &#123;description&#125;</code> æˆ–æ˜¯ <code>// @prompt &#123;var1&#125; &#123;description&#125;</code> å®šç¾©ï¼Œå¯è®“ä½¿ç”¨è€…è¼¸å…¥è®Šæ•¸å€¼<img src="image-20230902231230878.png" alt="image-20230902231230878"></p></li><li><p>é€é <code>&#123;&#123; variable &#125;&#125;</code> ä¾†ä½¿ç”¨ variable</p></li><li><p>ç¯„ä¾‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// File variable</span><br><span class="line">@baseUrl = https://example.com/api </span><br><span class="line"></span><br><span class="line">// Request variable</span><br><span class="line"># @name login</span><br><span class="line">POST &#123;&#123;baseUrl&#125;&#125;/api/login HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">name=foo&amp;password=bar</span><br><span class="line"></span><br><span class="line">// ä½¿ç”¨ Request variable</span><br><span class="line">@authToken = &#123;&#123;login.response.headers.X-AuthToken&#125;&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>è¨­å®š Response Preview å…§å®¹ï¼Œåœ¨ VS Code è¨­å®šæª”å…§ï¼Œå¯ä»¥è¨­å®š <code>previewOption</code></p><table><thead><tr><th>Option</th><th>Description</th></tr></thead><tbody><tr><td>full</td><td>Default. Full Response is previewed</td></tr><tr><td>headers</td><td>Only response header</td></tr><tr><td>body</td><td>Only response body</td></tr><tr><td>exchange</td><td>Preview the whole HTTP exchange</td></tr></tbody></table><p><img src="image-20230902232818215.png" alt="image-20230902232818215"></p></li><li><p>åœ¨ Markdown å…§ä¹Ÿå¯ä»¥è¢«ä½¿ç”¨ï¼Œç•¶ä½¿ç”¨ code block æ™‚ï¼Œåªè¦æ¨™è¨»ç‚º <code>http</code> æˆ–æ˜¯ <code>rest</code> æ™‚ï¼ŒREST Client å¥—ä»¶ä¹Ÿèƒ½èªå¾—ä¸¦å¯ä»¥è¢«åŸ·è¡Œï¼Œè¦ç•™æ„çš„æ˜¯ï¼Œè©²å‹•ä½œæ²’æ³•å† preview çš„ç•«é¢ä¸ŠåŸ·è¡Œï¼Œå¿…é ˆæ˜¯åœ¨ç·¨è¼¯ <code>md</code> æª”æ™‚ã€‚è®Šæ•¸è¨­å®šåœ¨ä¸åŒçš„ code block ä¸€æ¨£å¯ä»¥è¢«åƒåˆ°ï¼Œåªè¦æ˜¯åœ¨åŒä¸€ä»½ markdown æª”æ¡ˆå…§å³å¯</p><p><img src="image-20230903103750927.png" alt="image-20230903103750927"></p></li></ol><h2 id="Reference"><a class="header-anchor" href="#Reference"> </a>Reference</h2><ul><li><a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client">VSCode Extension: Rest Client</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;é™¤äº† Postmanï¼Œåœ¨ VS Code å…§é‚„æœ‰å…¶ä»–é¡ä¼¼çš„å¥—ä»¶å¯ä»¥é¸æ“‡ï¼Œä¾‹å¦‚æœ¬ç¯‡ç­†è¨˜çš„ä¸»è§’ &lt;code&gt;Rest Client&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="VSCode" scheme="http://blog.kevinyang.net/categories/VSCode/"/>
    
    
    <category term="VSCode" scheme="http://blog.kevinyang.net/tags/VSCode/"/>
    
  </entry>
  
  <entry>
    <title>[Grafana] Faro Web SDK å­¸ç¿’ç­†è¨˜</title>
    <link href="http://blog.kevinyang.net/2023/07/16/faro-web-sdk-study/"/>
    <id>http://blog.kevinyang.net/2023/07/16/faro-web-sdk-study/</id>
    <published>2023-07-16T02:25:17.000Z</published>
    <updated>2023-12-30T10:00:10.167Z</updated>
    
    <content type="html"><![CDATA[<p>Grafana æä¾›äº†è¨±å¤šå·¥å…·è®“ç¶­é‹åœ˜éšŠèƒ½å¾ˆæ¸…æ¥šçš„çŸ¥é“ç³»çµ±çš„ç›¸é—œç‹€æ…‹ï¼Œé‡å°ç¶²é ç›¸é—œæ•ˆèƒ½çš„ç›£æ§ï¼Œä¹Ÿæœ‰æä¾›ç›¸é—œçš„ solutionï¼Œå°±æ˜¯ <a href="https://grafana.com/oss/faro/">Faro</a></p><p><img src="https://grafana.com/static/assets/img/grafana-faro-oss-dashboard-thm.jpg" alt="grafana faro"></p><p>Grafana Faro çš„é‹ä½œæ–¹å¼å¦‚ä¸‹åœ–ï¼Œ</p><p><img src="https://grafana.com/static/assets/img/diagrams/grafana-oss-faro-diagram.svg" alt="how does grafana faro work"></p><p>å‰ç«¯é–‹ç™¼å¯ä»¥é€éæä¾›çš„ SDK å°‡ç›¸é—œè³‡è¨Šå‚³åˆ°å¾Œé¢çš„ Agent/Collect ï¼Œå°±å®Œæˆäº†ã€‚åªæ˜¯ SDK é›–ç„¶ç°¡å–®å¥—ç”¨ï¼Œè£¡é¢æœ‰å¾ˆå¤šç´°ç¯€è¨­å®šæ˜¯éœ€è¦æ·±å…¥ç ”ç©¶çš„ï¼Œé€™ç¯‡å°±æ˜¯é€™äº›è¨­å®šçš„å­¸ç¿’ç­†è¨˜</p><span id="more"></span><h2 id="Faro-Web-SDK"><a class="header-anchor" href="#Faro-Web-SDK"> </a>Faro Web SDK</h2><p><code>@grafana/faro-web-sdk</code> provides instrumentations, metas and transports for use in web applicationsï¼Œå®‰è£ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p><ol><li><p>å®‰è£ <code>faro-web-sdk</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @grafana/faro-web-sdk</span><br></pre></td></tr></table></figure></li><li><p>initialize</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; initializeFaro &#125; <span class="keyword">from</span> <span class="string">&#x27;@grafana/faro-web-sdk&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> faro = <span class="title function_">initializeFaro</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&#x27;https://collector-host:12345/collect&#x27;</span>,</span><br><span class="line">  <span class="attr">apiKey</span>: <span class="string">&#x27;secret&#x27;</span>,</span><br><span class="line">  <span class="attr">app</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;frontend&#x27;</span>,</span><br><span class="line">    <span class="attr">version</span>: <span class="string">&#x27;1.0.0&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol><li><code>url</code>: Grafana Agent çš„ä½ç½®</li><li><code>apiKey</code>: å°æ‡‰åˆ° Grafana Agent çš„ <code>integrations.app_agent_receiver_configs</code> ä¸‹çš„ <code>server.api_key</code> è¨­å®š</li><li><code>app</code>:  Web Application çš„ meta è³‡è¨Šï¼Œæœƒç”¨æ–¼ Grafana Dashboard ä¸Š</li></ol></li><li><p>ç•¶é€™æ¨£è¨­å®šå®Œæˆå¾Œï¼Œé–‹å•Ÿç¶²é æ™‚ï¼Œåœ¨ network çš„åœ°æ–¹å°±æœƒçœ‹åˆ° SDK post ç›¸é—œè³‡è¨Šåˆ°è¨­å®šçš„ agent ä½ç½®</p></li></ol><h3 id="åŸºæœ¬ç”¨æ³•"><a class="header-anchor" href="#åŸºæœ¬ç”¨æ³•"> </a>åŸºæœ¬ç”¨æ³•</h3><p>ç•¶é‡åˆ°éœ€è¦æ‰‹å‹•æ¨é€è³‡è¨Šæ™‚ï¼ŒSDK ä¹Ÿæœ‰æä¾›å°æ‡‰çš„ API æ¥å£</p><ol><li><p>æ‰‹å‹•æ¨é€ log</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// send a log message</span></span><br><span class="line"><span class="comment">// by default info, warn and error levels are captured.</span></span><br><span class="line"><span class="comment">// trace, debug and log are not</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;Hello world&#x27;</span>, <span class="number">123</span>);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line">faro.<span class="property">api</span>.<span class="title function_">pushLog</span>([<span class="string">&#x27;Hello world&#x27;</span>, <span class="number">123</span>], &#123; <span class="attr">level</span>: <span class="title class_">LogLevel</span>.<span class="property">Debug</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// log with context</span></span><br><span class="line">faro.<span class="property">api</span>.<span class="title function_">pushLog</span>([<span class="string">&#x27;Sending update&#x27;</span>], &#123;</span><br><span class="line">  <span class="attr">context</span>: &#123;</span><br><span class="line">    <span class="attr">payload</span>: thePayload,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">level</span>: <span class="title class_">LogLevel</span>.<span class="property">TRACE</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>æ‰‹å‹•é€ Exception</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faro.<span class="property">api</span>.<span class="title function_">pushError</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;everything went horribly wrong&#x27;</span>));</span><br></pre></td></tr></table></figure></li><li><p>æ‰‹å‹•é€ Event</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faro.<span class="property">api</span>.<span class="title function_">pushEvent</span>(<span class="string">&#x27;navigation&#x27;</span>, &#123; <span class="attr">url</span>: <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> &#125;);</span><br></pre></td></tr></table></figure></li><li><p>æ‰‹å‹•é€ <code>meaurement</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">faro.<span class="property">api</span>.<span class="title function_">pushMeasurement</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;cart-transaction&#x27;</span>,</span><br><span class="line">  <span class="attr">values</span>: &#123;</span><br><span class="line">    <span class="attr">delay</span>: <span class="number">122</span>,</span><br><span class="line">    <span class="attr">duration</span>: <span class="number">4000</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>pause/resume Faro</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pause faro, preventing events from being sent</span></span><br><span class="line">faro.<span class="title function_">pause</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// resume sending events</span></span><br><span class="line">faro.<span class="title function_">unpause</span>();</span><br></pre></td></tr></table></figure></li></ol><h3 id="å­¸ç¿’ç­†è¨˜"><a class="header-anchor" href="#å­¸ç¿’ç­†è¨˜"> </a>å­¸ç¿’ç­†è¨˜</h3><ol><li><p>Faro SDK é è¨­æœƒå¿½ç•¥çŸ­æ™‚é–“å…§ç›¸åŒè¨Šæ¯çš„äº‹ä»¶ï¼Œä¸æœƒæ¯ä¸€ç­†éƒ½å¾€å¾Œé¢é€ï¼Œå¦‚æœæƒ³è¦æ”¹è®Šé€™è¡Œç‚ºï¼Œå¯ä»¥è¨­å®š <code>dedupe: false</code> (<code>dedupe</code>: A flag for toggling deduplication filter)</p></li><li><p>é è¨­æ˜¯æ¡ batch sending çš„æ¨¡å¼ï¼Œæ¯ 250 ms æˆ–æ˜¯æ¯ 50 ç­†é€ä¸€æ¬¡ï¼Œé€™äº›æ•¸å€¼ä¹Ÿå¯ä»¥è¨­å®š</p><p><img src="image-20230716114843343.png" alt="image-20230716114843343"></p></li><li><p>ä¸Šä¸€æ®µæåˆ°çš„æ‰‹å‹•é€è³‡è¨Šåˆ°å¾Œé¢çš„ APIï¼Œéƒ½æœ‰é¡å¤–çš„åƒæ•¸å¯ä»¥è¨­å®šï¼Œç´°ç¯€å¯ä»¥åƒé–±<a href="https://github.com/grafana/faro-web-sdk/tree/main/packages/core#api">é€™é‚Š</a></p></li><li><p>å¾ˆå¤š SDK çš„ä½¿ç”¨ç´°ç¯€èªªæ˜éƒ½å¯«åœ¨ <code>faro-core</code> çš„åœ°æ–¹ï¼Œ<a href="https://github.com/grafana/faro-web-sdk/blob/main/packages/core/README.md">README</a> æœ‰æ­¤å»</p></li><li><p>é è¨­æœ‰æä¾› <code>faro-react</code>ï¼Œå…¶ä»– framework å¦‚æœæƒ³è¦å¯¦ä½œé¡ä¼¼çš„æ•ˆæœï¼Œå¯ä»¥åƒè€ƒ react çš„ç‰ˆæœ¬ï¼ŒåŒ…å«çš„é …ç›®æœ‰</p><ol><li>Error Boundary - Provides additional stacktrace for errors</li><li>Component Profiler - Capture every re-render of a component, the un/mounting time etc.</li><li>Router (v4-v6) integration - Send events for all route changes</li><li>SSR support</li></ol><p>ä»¥ Angular ä¾†èªªï¼Œæ‡‰è©²ä¹Ÿå¯ä»¥åšåˆ° 1~3 é»ï¼Œä½†æˆ‘é‚„æ²’æœ‰è‡ªå·±å‹•æ‰‹å¯¦ä½œéï¼Œå…ˆæš«å®šå¯ä»¥å¥½äº†</p></li></ol><h2 id="å°çµ"><a class="header-anchor" href="#å°çµ"> </a>å°çµ</h2><p>Faro æä¾›çš„æ˜¯ <code>RUM</code> (Real User Monitoring) çš„ç›¸é—œè³‡è¨Šï¼Œé™¤äº† Grafanaï¼ŒKibana å’Œ Sentry éƒ½æœ‰æä¾›é¡ä¼¼çš„åŠŸèƒ½ï¼Œåªæ˜¯å› ç‚ºè‡ªå®¶çš„ Monitor stack æ˜¯ Grafana ç‚ºä¸»ï¼Œæ‰€ä»¥é¸æ“‡ Faro åªæ˜¯ç‚ºäº†è®“ä½¿ç”¨çš„å·¥ç¨‹å¸«ä¸ç”¨åœ¨å·¥å…·ä¸­åˆ‡ä¾†åˆ‡å»</p><p>å‰ç«¯æ•ˆèƒ½èª¿æ•™æ°´å¾ˆæ·±ï¼Œæ”¶é›†åˆ°çš„é€™äº›è³‡è¨Šä¸¦ä¸æœƒæœ‰ Web åœ¨ç”¢ç”Ÿç•«é¢çš„ç›¸é—œè³‡è¨Šï¼Œé‚£äº›éœ€è¦å›åˆ°ç€è¦½å™¨ä¸Šåšåˆ†æï¼ŒèƒŒå¾Œçš„ web vita API å¯ä»¥åƒè€ƒé€™ä¸€å€‹å¥—ä»¶ <a href="https://www.npmjs.com/package/web-vitals">web-vitals</a></p><h2 id="Reference"><a class="header-anchor" href="#Reference"> </a>Reference</h2><ul><li><a href="https://github.com/grafana/faro-web-sdk">Faro Web SDK</a></li><li><a href="https://web.dev/vitals/">Web Vitals</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Grafana æä¾›äº†è¨±å¤šå·¥å…·è®“ç¶­é‹åœ˜éšŠèƒ½å¾ˆæ¸…æ¥šçš„çŸ¥é“ç³»çµ±çš„ç›¸é—œç‹€æ…‹ï¼Œé‡å°ç¶²é ç›¸é—œæ•ˆèƒ½çš„ç›£æ§ï¼Œä¹Ÿæœ‰æä¾›ç›¸é—œçš„ solutionï¼Œå°±æ˜¯ &lt;a href=&quot;https://grafana.com/oss/faro/&quot;&gt;Faro&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://grafana.com/static/assets/img/grafana-faro-oss-dashboard-thm.jpg&quot; alt=&quot;grafana faro&quot;&gt;&lt;/p&gt;
&lt;p&gt;Grafana Faro çš„é‹ä½œæ–¹å¼å¦‚ä¸‹åœ–ï¼Œ&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://grafana.com/static/assets/img/diagrams/grafana-oss-faro-diagram.svg&quot; alt=&quot;how does grafana faro work&quot;&gt;&lt;/p&gt;
&lt;p&gt;å‰ç«¯é–‹ç™¼å¯ä»¥é€éæä¾›çš„ SDK å°‡ç›¸é—œè³‡è¨Šå‚³åˆ°å¾Œé¢çš„ Agent/Collect ï¼Œå°±å®Œæˆäº†ã€‚åªæ˜¯ SDK é›–ç„¶ç°¡å–®å¥—ç”¨ï¼Œè£¡é¢æœ‰å¾ˆå¤šç´°ç¯€è¨­å®šæ˜¯éœ€è¦æ·±å…¥ç ”ç©¶çš„ï¼Œé€™ç¯‡å°±æ˜¯é€™äº›è¨­å®šçš„å­¸ç¿’ç­†è¨˜&lt;/p&gt;</summary>
    
    
    
    <category term="Grafana" scheme="http://blog.kevinyang.net/categories/Grafana/"/>
    
    
    <category term="Grafana" scheme="http://blog.kevinyang.net/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>[è®€æ›¸ç­†è¨˜][é–±è®€ä¸­] ç¶²ç«™å¯é æ€§å·¥ç¨‹å·¥ä½œæ‰‹å†Šï½œå°å…¥SREçš„å¯¦ç”¨æ–¹æ³•</title>
    <link href="http://blog.kevinyang.net/2023/06/24/books-The-Site-Reliability-Workbook/"/>
    <id>http://blog.kevinyang.net/2023/06/24/books-The-Site-Reliability-Workbook/</id>
    <published>2023-06-24T08:08:07.000Z</published>
    <updated>2023-12-30T10:00:10.167Z</updated>
    
    <content type="html"><![CDATA[<p>SRE çœŸçš„éœ€è¦å¤§é‡çš„é–±è®€è·Ÿå¯¦åšï¼Œç´¯ç©ç¶“é©—æ‰å¯ä»¥å¾—åˆ° SRE çš„ç²¾é«“ï¼Œåªå¥½èªçœŸ K æ›¸äº†</p><p>é€™ç¯‡ç‚º <code>ç¶²ç«™å¯é æ€§å·¥ç¨‹å·¥ä½œæ‰‹å†Šï½œå°å…¥SREçš„å¯¦ç”¨æ–¹æ³•</code> é€™æœ¬æ›¸çš„è®€æ›¸ç­†è¨˜ï¼Œç·šä¸Šé–±è®€ç‰ˆè·Ÿç¿»è­¯æ›¸çš„é€£çµå¦‚ä¸‹</p><ul><li>åŸæ–‡æ›¸: <a href="https://sre.google/workbook/table-of-contents/">The Site Reliability Workbook</a></li><li>ç¿»è­¯æ›¸: <a href="https://www.tenlong.com.tw/products/9789865026011">ç¶²ç«™å¯é æ€§å·¥ç¨‹å·¥ä½œæ‰‹å†Šï½œå°å…¥SREçš„å¯¦ç”¨æ–¹æ³• (The Site Reliability Workbook)</a></li></ul><p>è®€æ›¸ç­†è¨˜è·Ÿå¯¦å‹™ä¸Šé‡åˆ°çš„ç¶“é©—éƒ½æœƒæ•´ç†ä¸€èµ·</p><span id="more"></span><h2 id="å¯¦æ–½-SLO"><a class="header-anchor" href="#å¯¦æ–½-SLO"> </a>å¯¦æ–½ SLO</h2><ul><li>æ²’æœ‰ SLO å°±æ²’æœ‰ SRE</li><li>SLI æ˜¯ä¸€ç¨®æŒ‡æ¨™ï¼Œé‘‘åˆ¥æœå‹™æ°´æº–</li><li>åº¦é‡çš„æ¯”ä¾‹ç•¶ä½œ CLI, ä¾‹å¦‚: è‰¯å¥½äº‹ä»¶çš„æ•¸é‡é™¤ä»¥äº‹ä»¶ç¸½æ•¸</li><li>SLI å› ç‚ºæ˜¯æ¯”ä¾‹ï¼æ‰€ä»¥æ•¸å€¼ç¯„åœæœƒæ˜¯ 0 ~ 100%</li><li>SLO æ˜¯ç›®æ¨™ç™¾åˆ†æ¯”, çŠ¯éŒ¯é ç®—æ˜¯ 100% - SLO</li><li>åˆ¶è¨‚ SLI æ™‚ï¼Œå¯ä»¥ç”¨è¦æ ¼å’Œå¯¦åšå…©å€‹å±¤é¢åˆ¶è¨‚<ul><li>è¦æ ¼: è¦ºå¾—å°ä½¿ç”¨è€…é‡è¦çš„æœå‹™ç”¢å‡ºä¹‹è©•ä¼°ï¼Œæ˜¯å„è‡ªç¨ç«‹ä¸å—é‡æ¸¬æ–¹å¼å½±éŸ¿ã€‚ä¾‹å¦‚: è¨ªå•é¦–é  100 ms å…§èƒ½è¼‰å…¥çš„æ¯”ä¾‹</li><li>å¯¦åš: SLI è¦æ ¼æ¸¬é‡æ–¹æ³•</li></ul></li><li>SLO éœ€é¸æ“‡é©ç•¶çš„æ™‚çª—</li><li>SLO æ˜¯æœå‹™ external userï¼Œæ˜¯èˆ‡åˆ©å®³é—œä¿‚äººé–“çš„å”è­°ï¼ŒSLO éœ€è¦è¢«æ–‡ä»¶åŒ–ä¸”å…¬é–‹</li><li>å»ºç«‹ error budget æ”¿ç­– &amp; dashboard</li><li>å»ºç«‹ SLO éµå¾åº¦å ±å‘Š (Dashboard)</li><li>SLO ç›®æ¨™æŒçºŒæ”¹é€², å¯ç”¨ SLO æ±ºç­– metrics ä¾†åˆ¤æ–·æ¥ä¸‹ä¾†è¦èª¿æ•´çš„æ–¹å‘</li></ul><p>åƒè€ƒæ–‡ä»¶:</p><ul><li><a href="https://sre.google/workbook/slo-document/">Example SLO Document</a></li><li><a href="https://sre.google/workbook/error-budget-policy/">Example Error Budget Policy</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;SRE çœŸçš„éœ€è¦å¤§é‡çš„é–±è®€è·Ÿå¯¦åšï¼Œç´¯ç©ç¶“é©—æ‰å¯ä»¥å¾—åˆ° SRE çš„ç²¾é«“ï¼Œåªå¥½èªçœŸ K æ›¸äº†&lt;/p&gt;
&lt;p&gt;é€™ç¯‡ç‚º &lt;code&gt;ç¶²ç«™å¯é æ€§å·¥ç¨‹å·¥ä½œæ‰‹å†Šï½œå°å…¥SREçš„å¯¦ç”¨æ–¹æ³•&lt;/code&gt; é€™æœ¬æ›¸çš„è®€æ›¸ç­†è¨˜ï¼Œç·šä¸Šé–±è®€ç‰ˆè·Ÿç¿»è­¯æ›¸çš„é€£çµå¦‚ä¸‹&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŸæ–‡æ›¸: &lt;a href=&quot;https://sre.google/workbook/table-of-contents/&quot;&gt;The Site Reliability Workbook&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ç¿»è­¯æ›¸: &lt;a href=&quot;https://www.tenlong.com.tw/products/9789865026011&quot;&gt;ç¶²ç«™å¯é æ€§å·¥ç¨‹å·¥ä½œæ‰‹å†Šï½œå°å…¥SREçš„å¯¦ç”¨æ–¹æ³• (The Site Reliability Workbook)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è®€æ›¸ç­†è¨˜è·Ÿå¯¦å‹™ä¸Šé‡åˆ°çš„ç¶“é©—éƒ½æœƒæ•´ç†ä¸€èµ·&lt;/p&gt;</summary>
    
    
    
    <category term="Reading" scheme="http://blog.kevinyang.net/categories/Reading/"/>
    
    
    <category term="Reading" scheme="http://blog.kevinyang.net/tags/Reading/"/>
    
  </entry>
  
  <entry>
    <title>[Ansible] å­¸ç¿’ Ansible ä¹‹è·¯ - Ansible playbook</title>
    <link href="http://blog.kevinyang.net/2023/05/07/study-ansible-02/"/>
    <id>http://blog.kevinyang.net/2023/05/07/study-ansible-02/</id>
    <published>2023-05-07T02:22:29.000Z</published>
    <updated>2023-12-30T10:00:10.167Z</updated>
    
    <content type="html"><![CDATA[<p>Ansible playbook å¯ä»¥è®“æˆ‘å€‘ç”¨åŠ‡æœ¬çš„æ–¹å¼ä¾†ç®¡ç†æƒ³å° managed node åŸ·è¡Œçš„å‹•ä½œï¼ŒAnsible playbook æ˜¯ä½¿ç”¨ YAML çš„æ ¼å¼ä¾†ç·¨å¯«ï¼Œç•¶ç„¶ Ansible ä¹Ÿæœ‰æä¾›å°æ‡‰çš„æª¢æŸ¥å·¥å…·ä¾†æª¢æŸ¥ playbook æ˜¯å¦æœ‰æ­£ç¢ºç·¨å¯«ã€‚</p><p>é€™ä¸€ç¯‡ä¾†å­¸ç¿’å¦‚ä½•å¯« Ansible playbook</p><span id="more"></span><h2 id="Playbook"><a class="header-anchor" href="#Playbook"> </a>Playbook</h2><p>å»ºç«‹ä¸€å€‹ç©ºçš„ playbook å¾ˆç°¡å–®ï¼Œåªè¦å»ºç«‹ä¸€å€‹ <code>&lt;xxxx&gt;.yml</code> æª”å°±ç®—æ˜¯å®Œæˆä¸€å€‹ playbook çš„å»ºç«‹ã€‚å…§å®¹æ‰æ˜¯é‡é»ï¼Œä¸»è¦æœƒæœ‰å¹¾å€‹å…ƒç´ </p><p><img src="image-20230507105006665.png" alt="image-20230507105006665"></p><ol><li><p>åŠ‡æœ¬åç¨±</p></li><li><p>åŸ·è¡Œå°è±¡: é€™æœƒè·Ÿ Inventory è¨­å®šæª”æœ‰é—œ</p><ul><li>Inventory å¯ä»¥åœ¨åŸ·è¡Œ playbook æ™‚æŒ‡å®šï¼Œé€™è£¡æä¾›ä¸€å€‹ç¯„æœ¬</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[local]</span></span><br><span class="line">server1 <span class="attr">ansible_ssh_host</span>=<span class="number">127.0</span>.<span class="number">0.1</span> ansible_ssh_port=<span class="number">32769</span> ansible_ssh_pass=docker</span><br></pre></td></tr></table></figure><ul><li>line 1: <code>[local]</code> æ˜¯ inventory group åç¨±ï¼Œä¹Ÿæ˜¯ hosts æŒ‡å®šçš„ç›®æ¨™ï¼Œå¯ä»¥ä¾è‡ªå·±çš„å–œå¥½ç·¨å¯«ï¼Œå¾Œé¢ä¹Ÿæœƒæœ‰ä¸€ç¯‡ç ”ç©¶å¦‚ä½•å¯« inventory æª”æ¡ˆ</li></ul></li><li><p>ä»»å‹™åˆ—è¡¨: æœƒåŒ…å«ä¸€ç³»åˆ—è¦åŸ·è¡Œçš„å‹•ä½œï¼Œé€šå¸¸æœƒä½¿ç”¨ Ansible æ‰€æä¾›çš„ module ä¾†åŸ·è¡Œ</p><ol><li><code>command</code> æ˜¯ Ansible å…§å»ºçš„ moduleï¼Œå¯ä»¥å° hosts ä¸‹æŒ‡ä»¤</li><li><code>register</code> ä¹Ÿæ˜¯ Ansible å…§å»ºçš„ moduleï¼Œå¯ä»¥å°‡å›å‚³è¨Šæ¯è¨˜éŒ„åœ¨è®Šæ•¸å…§ï¼Œé€™é‚Šå°±æ˜¯æœƒå„²å­˜åœ¨ <code>result</code> é€™ä¸€å€‹è®Šæ•¸</li><li>è¦å°‡è®Šæ•¸è¼¸å‡ºåˆ° console ä¸Šï¼Œéœ€è¦ä½¿ç”¨ <code>Jinja2</code> çš„æ¨£æœ¬åŠŸèƒ½ï¼Œä½¿ç”¨ <code>&#123;&#123; &#125;&#125;</code> çš„æ–¹å¼è¼¸å‡º</li></ol></li></ol><h2 id="åŸ·è¡Œ-playbook"><a class="header-anchor" href="#åŸ·è¡Œ-playbook"> </a>åŸ·è¡Œ playbook</h2><p>åœ¨ WSL çš„ç’°å¢ƒå…§ï¼Œåˆ‡æ›åˆ° playbook æª”æ¡ˆæ‰€åœ¨å¾—è³‡æ–™å¤¾ï¼ŒåŸ·è¡Œé€™æ®µæŒ‡ä»¤ï¼Œéœ€ä¾å¯¦éš›çš„ç‹€æ³ä½œäº›èª¿æ•´ï¼ŒåŸºæœ¬æŒ‡ä»¤çµæ§‹æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i &lt;inventory æª”æ¡ˆ&gt; &lt;playbook æª”æ¡ˆå&gt;</span><br></pre></td></tr></table></figure><p>ç¯„ä¾‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i hosts hello_world.yml </span><br></pre></td></tr></table></figure><p>å¦‚æœè¨­å®šéƒ½æ­£ç¢ºçš„è©±ï¼Œå¯é æœŸæœƒå¾—åˆ°é€™æ¨£çš„åŸ·è¡Œçµæœ</p><p><img src="image-20230507110200351.png" alt="image-20230507110200351"></p><h2 id="å°çµ"><a class="header-anchor" href="#å°çµ"> </a>å°çµ</h2><p>æ’°å¯« Ansible playbook æœ¬èº«ä¸é›£ï¼Œä¸€æ—¦çŸ¥é“æˆ‘å€‘æƒ³è¦è‡ªå‹•åŒ–çš„è¡Œç‚ºæœ‰ä»€éº¼ï¼Œç›¸é—œæµç¨‹éœ€è¦æ€éº¼å®‰æ’ï¼Œæ¥ä¸‹ä¾†å°±æ˜¯æ‰¾å°æ‡‰çš„ Ansible module æˆ–æ˜¯ç¶²è·¯ä¸Šæœ‰çš„åƒè€ƒç¯„ä¾‹ï¼Œæœ€å¾Œå°±æ˜¯æ•´ç†åœ¨ playbook åŠ‡æœ¬å…§ã€‚ç•¶ç„¶æ›´é€²éšçš„ç®¡ç†è¾¦æ³•æˆ–æ˜¯ playbook çš„æª”æ¡ˆçµæ§‹æ‡‰è©²è¦æ€éº¼è¦åŠƒï¼Œå°±ç•™çµ¦å„ä½å»ç ”ç©¶äº†ã€‚</p><h2 id="è£œå……"><a class="header-anchor" href="#è£œå……"> </a>è£œå……</h2><p>Ansible æœ‰æä¾› <code>ansible-lint</code> çš„å·¥å…·ï¼Œå¯æª¢æŸ¥ playbook  çš„æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼Œè©²å·¥å…·çš„ GitHub Repo <a href="https://github.com/ansible/ansible-lint">ç”±æ­¤å»</a>ï¼Œ<a href="https://ansible-lint.readthedocs.io/">Ansible Lint Documentation</a></p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html#playbook-syntax">Playbook Syntax</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Ansible playbook å¯ä»¥è®“æˆ‘å€‘ç”¨åŠ‡æœ¬çš„æ–¹å¼ä¾†ç®¡ç†æƒ³å° managed node åŸ·è¡Œçš„å‹•ä½œï¼ŒAnsible playbook æ˜¯ä½¿ç”¨ YAML çš„æ ¼å¼ä¾†ç·¨å¯«ï¼Œç•¶ç„¶ Ansible ä¹Ÿæœ‰æä¾›å°æ‡‰çš„æª¢æŸ¥å·¥å…·ä¾†æª¢æŸ¥ playbook æ˜¯å¦æœ‰æ­£ç¢ºç·¨å¯«ã€‚&lt;/p&gt;
&lt;p&gt;é€™ä¸€ç¯‡ä¾†å­¸ç¿’å¦‚ä½•å¯« Ansible playbook&lt;/p&gt;</summary>
    
    
    
    <category term="Ansible" scheme="http://blog.kevinyang.net/categories/Ansible/"/>
    
    
    <category term="Ansible" scheme="http://blog.kevinyang.net/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>[Ansible] å­¸ç¿’ Ansible ä¹‹è·¯ - ç’°å¢ƒæº–å‚™ç¯‡</title>
    <link href="http://blog.kevinyang.net/2023/05/06/study-ansible-01/"/>
    <id>http://blog.kevinyang.net/2023/05/06/study-ansible-01/</id>
    <published>2023-05-06T07:51:06.000Z</published>
    <updated>2023-12-30T10:00:10.167Z</updated>
    
    <content type="html"><![CDATA[<p>åŸºæ–¼ç¨®ç¨®åŸå› ï¼Œå¿…é ˆå­¸ç¿’ Ansibleï¼Œé€™å·²ç¶“è„«é›¢ä¹‹å‰ç¿’æ…£çš„é ˜åŸŸï¼Œæ‰€ä»¥å°±ç”¨ä¸€å€‹æ–°æ‰‹çš„å¿ƒå­¸ç¿’é€™ä¸€å€‹å·¥å…·ï¼Œè½èªªæ˜¯å¾ˆå²å®³çš„å·¥å…·</p><span id="more"></span><h2 id="Ansible-åŸºæœ¬ä»‹ç´¹"><a class="header-anchor" href="#Ansible-åŸºæœ¬ä»‹ç´¹"> </a>Ansible åŸºæœ¬ä»‹ç´¹</h2><p><img src="image-20230506160349398.png" alt="image-20230506160349398"></p><ul><li><strong>Control node</strong>: A system on which Ansible is installed. You run Ansible commands such as <code>ansible</code> or <code>ansible-inventory</code> on a control node.</li><li><strong>Managed node</strong>: A remote system, or host, that Ansible controls.</li><li><strong>Inventory</strong>: A list of managed nodes that are logically organized. You create an inventory on the control node to describe host deployments to Ansible.</li></ul><h2 id="æº–å‚™ç·´ç¿’ç’°å¢ƒ"><a class="header-anchor" href="#æº–å‚™ç·´ç¿’ç’°å¢ƒ"> </a>æº–å‚™ç·´ç¿’ç’°å¢ƒ</h2><h3 id="Control-Node"><a class="header-anchor" href="#Control-Node"> </a>Control Node</h3><p>å¾ˆä¸å¹¸çš„æ˜¯ Windows æœ¬èº«æ˜¯ç„¡æ³•æ”¯æ´ Ansible control node çš„åŠŸèƒ½ï¼Œåªèƒ½é€é WSL2 ä¾†åŸ·è¡Œ</p><p>é€²å…¥ WSL å¾Œï¼ŒåŸ·è¡Œä¸‹åˆ—æŒ‡ä»¤å³å¯å®Œæˆå®‰è£ <code>Ansible</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install python3-pip git libffi-dev libssl-dev sshpass -y</span><br><span class="line">pip install --user ansible pywinrm</span><br></pre></td></tr></table></figure><p>å®‰è£æˆåŠŸå¾Œï¼ŒåŸ·è¡Œ <code>ansible --version</code> æ‡‰å¯çœ‹åˆ°é¡ä¼¼çš„è¨Šæ¯</p><p><img src="image-20230506161545861.png" alt="image-20230506161545861"></p><p>é€™æ¨£å°±è¡¨ç¤ºå®‰è£æˆåŠŸã€‚è‡³æ–¼å…¶ä»–ä½œæ¥­ç³»çµ±çš„å®‰è£æ–¹å¼ï¼Œå¯ä»¥åƒè€ƒ <a href="https://docs.ansible.com/ansible/latest/installation_guide/index.html">Installation Guide</a></p><h3 id="Manage-Node"><a class="header-anchor" href="#Manage-Node"> </a>Manage Node</h3><p>è¦ç·´ç¿’ Ansible ç•¶ç„¶ä¹Ÿè¦æº–å‚™ä¸€å€‹å¯ä»¥è¢«æ¸¬è©¦éƒ¨ç½²çš„ç’°å¢ƒï¼Œå› ç‚º Docker æ˜¯å¤§å®¶çš„å¥½æœ‹å‹ï¼Œæ‰€ä»¥å°±æº–å‚™ä¸€å€‹ä¾†ç•¶ managed node å§</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull chusiang/ansible-managed-node:ubuntu-20.04</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name server1 -d -P chusiang/ansible-managed-node:ubuntu-20.04</span><br></pre></td></tr></table></figure><p>å•Ÿå‹•å¾Œæ‡‰å¯çœ‹åˆ° <code>server1</code> SSH port ç¶å®šçš„ç‹€æ…‹</p><p><img src="image-20230506163843326.png" alt="image-20230506163843326"></p><h3 id="å»ºç«‹-Ansible-è¨­å®šæª”ç­‰"><a class="header-anchor" href="#å»ºç«‹-Ansible-è¨­å®šæª”ç­‰"> </a>å»ºç«‹ Ansible è¨­å®šæª”ç­‰</h3><p>æ¥ä¸‹ä¾†æˆ‘å€‘å°±å¯å¯«ç¬¬ä¸€æ¬¡ Ansible è¨­å®šæª”åŠ Inventory æª”</p><ol><li>å»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ï¼Œä¸¦åœ¨è©²è³‡æ–™å¤¾ä¸‹æ–°å¢ä¸€å€‹ <code>ansible.cfg</code> çš„æª”æ¡ˆï¼Œæª”æ¡ˆå…§å®¹å¦‚ä¸‹</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">inventory = hosts</span><br><span class="line">remote_user = docker</span><br><span class="line">host_key_checking = False</span><br></pre></td></tr></table></figure><ol start="2"><li>æ–°å¢ inventory æª”ï¼Œæª”åç‚º <code>hosts</code></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server1  ansible_ssh_host=127.0.0.1  ansible_ssh_port=32768 ansible_ssh_pass=docker</span><br><span class="line"></span><br><span class="line">[local]</span><br><span class="line">server1</span><br></pre></td></tr></table></figure><ul><li><code>ansible_ssh_host</code>ï¼šè«‹è¨­ç‚ºæœ¬æ©Ÿçš„ IPã€‚</li><li><code>ansible_ssh_port</code>ï¼šè«‹è¨­ç‚º <code>docker ps</code> æ™‚å–å¾—çš„ SSH portã€‚</li><li><code>ansible_ssh_pass</code>ï¼šå› æ²’æœ‰é€£ç·šç”¨çš„ SSH é‡‘é‘°ï¼Œæ•…ç›´æ¥ä½¿ç”¨å¯†ç¢¼çš„æ–¹å¼é€²è¡Œé€£ç·šï¼Œ</li></ul><p><img src="image-20230506172318766.png" alt="image-20230506172318766"></p><h3 id="ç’°å¢ƒé©—è­‰"><a class="header-anchor" href="#ç’°å¢ƒé©—è­‰"> </a>ç’°å¢ƒé©—è­‰</h3><p>ç•¶ä¸Šè¿°å‹•ä½œå®Œæˆå¾Œï¼Œè©²è³‡æ–™å¤¾æ‡‰è©²æœƒçœ‹åˆ°é€™å…©å€‹æª”æ¡ˆï¼Œæ¥ä¸‹ä¾†å°±å¯ä»¥åŸ·è¡Œç¬¬ä¸€æ¬¡ ansible çš„æŒ‡ä»¤äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m ping</span><br></pre></td></tr></table></figure><p>å¦‚æœè¨­å®šæ­£ç¢ºï¼Œæ‡‰å¯çœ‹åˆ°é€™æ¨£çš„çµæœå›å‚³</p><p><img src="image-20230506172447298.png" alt="image-20230506172447298"></p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://ithelp.ithome.com.tw/articles/10185111">05. æ€éº¼ç”¨ Docker ç·´ç¿’ Ansibleï¼Ÿ</a></li><li><a href="https://github.com/chusiang/ansible-managed-node.dockerfile/tree/master/ubuntu-20.04">Dockerfile</a></li><li><a href="https://docs.ansible.com/ansible/latest/installation_guide/index.html">Ansible Install Guide</a></li><li><a href="https://docs.ansible.com/ansible/latest/os_guide/windows_faq.html#windows-faq-ansible">Can Ansible run on Windows</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åŸºæ–¼ç¨®ç¨®åŸå› ï¼Œå¿…é ˆå­¸ç¿’ Ansibleï¼Œé€™å·²ç¶“è„«é›¢ä¹‹å‰ç¿’æ…£çš„é ˜åŸŸï¼Œæ‰€ä»¥å°±ç”¨ä¸€å€‹æ–°æ‰‹çš„å¿ƒå­¸ç¿’é€™ä¸€å€‹å·¥å…·ï¼Œè½èªªæ˜¯å¾ˆå²å®³çš„å·¥å…·&lt;/p&gt;</summary>
    
    
    
    <category term="Ansible" scheme="http://blog.kevinyang.net/categories/Ansible/"/>
    
    
    <category term="Ansible" scheme="http://blog.kevinyang.net/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>[Angular] Signals å˜—é®®</title>
    <link href="http://blog.kevinyang.net/2023/03/11/angular-signals/"/>
    <id>http://blog.kevinyang.net/2023/03/11/angular-signals/</id>
    <published>2023-03-11T01:45:03.000Z</published>
    <updated>2023-12-30T10:00:10.163Z</updated>
    
    <content type="html"><![CDATA[<p>Angular å˜—è©¦åœ¨ä¸‹ä¸€ä¸–ä»£ä¸­åŠ å…¥æ–°çš„ reactive æ©Ÿåˆ¶ï¼Œè©¦åœ–æ‰¾åˆ°å–ä»£ zone.js çš„æ–¹å¼ï¼Œå› æ­¤å¼•é€²äº† <code>signals</code> ä¾†è©¦è©¦çœ‹æ˜¯å¦èƒ½æˆç‚ºä¸‹ä¸€ä»£ change detection çš„é¸æ“‡ã€‚æƒ³è¦å˜—è©¦çš„æœ‹å‹å¯ä»¥å®‰è£ <code>angular cli v16</code> çš„ç‰ˆæœ¬</p><span id="more"></span><h2 id="ä»€éº¼æ˜¯-Signals"><a class="header-anchor" href="#ä»€éº¼æ˜¯-Signals"> </a>ä»€éº¼æ˜¯ Signals</h2><p>Signals ä¸æ˜¯ Angular team å‰µé€ å‡ºä¾†çš„ libraryï¼Œè€Œæ˜¯å¼•ç”¨å…¶ä»– framework å…§æ‰€æœ‰ä½¿ç”¨çš„ä¸€å€‹æ©Ÿåˆ¶ï¼Œå¦‚æœæ²’è¨˜éŒ¯æ‡‰è©²æ˜¯ä¾†è‡ª <a href="https://www.solidjs.com/tutorial/introduction_signals">SolidJS</a></p><blockquote><p><em>Signals</em> are the cornerstone of reactivity in Solid. They contain values that change over time; when you change a signalâ€™s value, it automatically updates anything that uses it.</p></blockquote><p>èªªæ˜¯é€™æ¨£å­èªªï¼ŒAngular Team æ˜¯è‡ªå·±å¯¦åšæ•´å€‹ Signal æ©Ÿåˆ¶ï¼Œç›¸é—œçš„ç¨‹å¼ç¢¼é€£çµæˆ‘æœƒé™„åœ¨ä¸‹é¢</p><h2 id="å¦‚ä½•åœ¨-Angular-å…§ä½¿ç”¨-Signals"><a class="header-anchor" href="#å¦‚ä½•åœ¨-Angular-å…§ä½¿ç”¨-Signals"> </a>å¦‚ä½•åœ¨ Angular å…§ä½¿ç”¨ Signals</h2><h3 id="å»ºç«‹-signal-ç‰©ä»¶"><a class="header-anchor" href="#å»ºç«‹-signal-ç‰©ä»¶"> </a>å»ºç«‹ signal ç‰©ä»¶</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, signal &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;....&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">  count = <span class="title function_">signal</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>signal</code> ä»‹é¢</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> signal&lt;T&gt;(<span class="attr">initialValue</span>: T, equal?: <span class="title class_">ValueEqualityFn</span>&lt;T&gt;): <span class="title class_">SettableSignal</span>&lt;T&gt;</span><br></pre></td></tr></table></figure><h3 id="é¡¯ç¤º"><a class="header-anchor" href="#é¡¯ç¤º"> </a>é¡¯ç¤º</h3><p>è¦å–å¾— signal ç‰©ä»¶å€¼çš„æ–¹å¼å¾ˆç›´æ¥ï¼Œç›´æ¥ç•¶ function ä½¿ç”¨å³å¯ï¼Œæ¥çºŒä¸Šé¢çš„ç¯„ä¾‹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; count() &#125;&#125; </span><br></pre></td></tr></table></figure><p>é€™æ¨£å°±å¯ä»¥åœ¨ html ä¸Šé¡¯ç¤º count çš„å€¼äº†ï¼Œæˆ–è¨±æœƒå•ä¸è¦åœ¨ html render æ™‚å¯« function call å—ï¼Œæœƒæœ‰æ•ˆèƒ½å•é¡Œï¼Œé€™è£¡é€™æ¨£ä½¿ç”¨æ˜¯æ²’æœ‰å•é¡Œçš„ (ä¹‹å‰æœ‰è½ angular team èªªç‚ºä»€éº¼ä¸æœƒæœ‰å•é¡Œï¼Œä½†æˆ‘å¿˜è¨˜ç†ç”±äº†)</p><h3 id="æ›´æ–°"><a class="header-anchor" href="#æ›´æ–°"> </a>æ›´æ–°</h3><p>ç•¶å»ºç«‹ä¸€å€‹ signal ç‰©ä»¶å¾Œï¼Œæ›´æ–°å€¼å¾—æ–¹å¼æœ‰ä¸‰ç¨®ï¼Œ<code>set</code> ã€<code>update</code>  å’Œ <code>mutate</code></p><ul><li><p>set: Directly set the signal to a new value, and notify any dependents.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">set</span>(<span class="attr">value</span>: T): <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure></li><li><p>update: Update the value of the signal based on its current value, and notify any dependents.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">update</span>(<span class="attr">updateFn</span>: <span class="function">(<span class="params">value: T</span>) =&gt;</span> T): <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure></li><li><p>mutate: Update the current value by mutating it in-place, and notify any dependents.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">mutate</span>(<span class="attr">mutatorFn</span>: <span class="function">(<span class="params">value: T</span>) =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç¯„ä¾‹"><a class="header-anchor" href="#ç¯„ä¾‹"> </a>ç¯„ä¾‹</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CommonModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, signal &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    Count: &#123;&#123; count() &#125;&#125;</span></span><br><span class="line"><span class="string">    &lt;button (click)=&quot;increase()&quot;&gt;+&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;button (click)=&quot;reset()&quot;&gt;reset&lt;/button&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>],</span><br><span class="line">  <span class="attr">standalone</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">CommonModule</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">  count = <span class="title function_">signal</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">reset</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">count</span>.<span class="title function_">set</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">increase</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">count</span>.<span class="title function_">update</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> ++c);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="é€²éšç”¨æ³•"><a class="header-anchor" href="#é€²éšç”¨æ³•"> </a>é€²éšç”¨æ³•</h2><p>é–‹é ­æœ‰æåˆ° signals æ˜¯ä¸€å€‹ reactive libraryï¼Œç•¶ç„¶ä¸æœƒåªæœ‰é€™ç¨®å–®ä¸€å€¼çš„ä½¿ç”¨æƒ…å¢ƒï¼Œä¸€å®šæœƒæœ‰éŒ¯ç¶œè¤‡é›œçš„ä½¿ç”¨æƒ…å¢ƒï¼Œé€™æ™‚å€™æœƒæ€éº¼ä½¿ç”¨å‘¢</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span>, signal, computed &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line"> ...</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;p&gt;Count: &#123;&#123; count() &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;Double: &#123;&#123; double() &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">  count = <span class="title function_">signal</span>(<span class="number">0</span>);</span><br><span class="line">  double = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">count</span>() * <span class="number">2</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>computed</code> å¯ä»¥è®“æˆ‘å€‘èˆ‡å…¶ä»– signal ä½œäº’å‹•çµåˆï¼Œç•¶ computed å…§çš„ signal å€¼æ”¹è®Šæ™‚ï¼Œæ­¤ computed çµæœä¹Ÿæœƒè·Ÿè‘—æ”¹è®Šï¼Œä½¿ç”¨ä¸Šç®—ç›´è¦º</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">declare</span> <span class="keyword">function</span> computed&lt;T&gt;(<span class="attr">computation</span>: <span class="function">() =&gt;</span> T, equal?: <span class="title class_">ValueEqualityFn</span>&lt;T&gt;): <span class="title class_">Signal</span>&lt;T&gt;;</span><br></pre></td></tr></table></figure><p>é™¤äº† computedï¼Œé‚„æœ‰ä¸€å€‹æ˜¯ <code>effect</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">declare</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">effectFn: () =&gt; <span class="built_in">void</span></span>): <span class="title class_">Effect</span>;</span><br></pre></td></tr></table></figure><p>é ˆç•™æ„çš„æ˜¯å…©è€…å›å‚³çš„ç‰©ä»¶æ˜¯ä¸ä¸€æ¨£çš„ï¼Œ<code>computed</code> æœƒå›å‚³ä¸€å€‹æ–°çš„ <code>Signal</code> ç‰©ä»¶ï¼Œä½† <code>effect</code> æ˜¯å›å‚³ä¸€å€‹ <code>Effect</code> ç‰©ä»¶ï¼Œé€™ Effect å‹åˆ¥çš„ç‰©ä»¶å¯ä»¥å…è¨±æˆ‘å€‘åœç”¨ <code>effect</code> ï¼Œé¡ä¼¼ Observable.subscribe æœƒå›å‚³ subscription çš„æ¦‚å¿µ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="title function_">count</span>());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€™é‚Šè¦ç•™æ„çš„æ˜¯ <code>effect</code> å®£å‘Šçš„åœ°æ–¹è·Ÿ <code>inject()</code> æ˜¯ä¸€æ¨£çš„ï¼Œåªèƒ½åœ¨ constructor å®£å‘Šï¼Œä¸ç„¶æœƒå™´éŒ¯èª¤è¨Šæ¯çµ¦ä½ çœ‹</p><p><img src="image-20230407225822130.png" alt="image-20230407225822130"></p><h2 id="RxJS-æ€éº¼è¾¦"><a class="header-anchor" href="#RxJS-æ€éº¼è¾¦"> </a>RxJS æ€éº¼è¾¦?</h2><p>Signal çš„ä½¿ç”¨æ–¹å¼èˆ‡ RxJS å…¶å¯¦æœ‰å¾ˆå¤§éƒ¨åˆ†æ˜¯é‡ç–Šçš„ï¼Œä½† RxJS æœ‰å¾ˆå¥½ç”¨çš„ operatorsï¼Œé€™æ™‚å€™è©²æ€éº¼è¾¦å‘¢? æ˜¯å¦æœ‰æ–¹æ³•èƒ½çµåˆå…©è€…ã€‚åœ¨ GitHub ä¸Šé¢æœ‰ä¸€å€‹ PR å°±æ˜¯è¦è§£æ±ºé€™å€‹å•é¡Œï¼ŒAngular team æä¾›å…©å€‹ functionï¼Œ<code>toSignal</code> å’Œ <code>toObservable</code>ï¼Œé€™éé€™å…©å€‹ function  å¯ä»¥å°‡ Observable å’Œ Signal ç‰©ä»¶åšå½¼æ­¤è½‰æ›ï¼Œæˆ‘æ˜¯è¦ºå¾—é€™æ¨£å°±å¯ä¿ç•™ç›¸ç•¶çš„å½ˆæ€§äº†ï¼Œç•¶ç„¶ä¹Ÿè¦ç­‰å¯¦éš›ä½¿ç”¨åœ¨ç”¢å“æ‰èƒ½çŸ¥é“æœƒæœ‰é‚£äº›å‘</p><p>[Update] <a href="https://github.com/angular/angular/releases/tag/16.0.0-next.6">Angular  v16.0.0-next.6</a> å¯¦åšäº† <code>fromObservable</code> å’Œ <code>fromSignal</code> å…©å€‹æ–¹æ³•ï¼Œæƒ³ç©çš„æœ‹å‹å¯ä»¥æ›´æ–°åˆ°æ–°ç‰ˆ</p><p>é™„ä¸Šç¯„ä¾‹ç¨‹å¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// toObservable</span></span><br><span class="line">count = signal&lt;<span class="built_in">number</span>[]&gt;([]);</span><br><span class="line">double = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">count</span>().<span class="property">length</span> * <span class="number">2</span>);</span><br><span class="line">triple$ = <span class="title function_">toObservable</span>(<span class="variable language_">this</span>.<span class="property">count</span>).<span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> value.<span class="property">length</span> * <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// toSignal</span></span><br><span class="line">counter$ = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>(<span class="number">0</span>);</span><br><span class="line">counter = <span class="title function_">toSignal</span>(<span class="variable language_">this</span>.<span class="property">counter$</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®£å‘Šçš„ä½ç½®è·Ÿ <code>effect</code> æ˜¯ä¸€æ¨£çš„ï¼Œä¸ç„¶ä¹Ÿæœƒå™´éŒ¯èª¤è¨Šæ¯çµ¦ä½ äº«ç”¨</p><p><img src="image-20230415111504566.png" alt="image-20230415111504566"></p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://github.com/angular/angular/discussions/49090">[Watch This Space] Angular Reactivity with Signals</a></li><li><a href="https://dev.to/this-is-angular/angular-signals-everything-you-need-to-know-2b7g">Angular &amp; signals. Everything you need to know.</a></li><li><a href="https://github.com/angular/angular/tree/main/packages/core/src/signals">Source Code - Signal</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Angular å˜—è©¦åœ¨ä¸‹ä¸€ä¸–ä»£ä¸­åŠ å…¥æ–°çš„ reactive æ©Ÿåˆ¶ï¼Œè©¦åœ–æ‰¾åˆ°å–ä»£ zone.js çš„æ–¹å¼ï¼Œå› æ­¤å¼•é€²äº† &lt;code&gt;signals&lt;/code&gt; ä¾†è©¦è©¦çœ‹æ˜¯å¦èƒ½æˆç‚ºä¸‹ä¸€ä»£ change detection çš„é¸æ“‡ã€‚æƒ³è¦å˜—è©¦çš„æœ‹å‹å¯ä»¥å®‰è£ &lt;code&gt;angular cli v16&lt;/code&gt; çš„ç‰ˆæœ¬&lt;/p&gt;</summary>
    
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/categories/Angular/"/>
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/tags/Angular/"/>
    
  </entry>
  
  <entry>
    <title>[Discord] Bot æ–°æ‰‹ä¸Šè·¯</title>
    <link href="http://blog.kevinyang.net/2022/11/20/discord-bot/"/>
    <id>http://blog.kevinyang.net/2022/11/20/discord-bot/</id>
    <published>2022-11-20T02:44:46.000Z</published>
    <updated>2023-12-30T10:00:10.163Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æ¥äº†é—œæ–¼ Bot é–‹ç™¼ç›¸é—œçš„æ¥­å‹™ï¼Œè¶ä¼‘æ¯æ™‚é–“ç©ä¸€ä¸‹ Discord Bot çš„é–‹ç™¼é«”é©—ï¼Œå°‡éç¨‹è¨˜éŒ„ä¸€ä¸‹ï¼Œæä¸å¥½å¾Œé¢é‚„ç”¨çš„åˆ°ã€‚</p><p>åœ¨é€™ä¹‹å‰é‚„æ˜¯å¿«é€Ÿä»‹ç´¹ä¸€ä¸‹ Discordã€‚Discordæ˜¯ä¸€æ¬¾å°ˆç‚ºç¤¾ç¾¤è¨­è¨ˆçš„å…è²»ç¶²è·¯å³æ™‚é€šè©±è»Ÿé«”èˆ‡æ•¸ä½ç™¼è¡Œå¹³å°ï¼Œåœ¨æ—©æœŸå¾ˆå¸¸è¢«éŠæˆ²ç©å®¶æ‹¿ä¾†åšç·šä¸Šé€£ç·šæ™‚çš„é€šè¨Šè»Ÿé«”ï¼Œç¾åœ¨æ˜¯å¾ˆå¤šç”¢å“ã€ç¤¾ç¾¤ç­‰éƒ½æœƒåˆ©ç”¨ Discord ä¾†ç¶“ç‡Ÿç¤¾ç¾¤ã€‚</p><span id="more"></span><p>æ—¢ç„¶æ˜¯å¹³å°ï¼Œæœ¬èº«åˆæä¾› Bot é–‹ç™¼çš„èƒ½åŠ›ï¼Œå°±è¦å¥½å¥½çš„æ¢ç´¢ä¸€ä¸‹åˆ°åº• Bot åœ¨ Discord èƒ½åšåˆ°ä»€éº¼äº‹æƒ…</p><h2 id="å»ºç«‹ç¬¬ä¸€å€‹-Bot"><a class="header-anchor" href="#å»ºç«‹ç¬¬ä¸€å€‹-Bot"> </a>å»ºç«‹ç¬¬ä¸€å€‹ Bot</h2><p>åœ¨å»ºç«‹ç¬¬ä¸€å€‹ Bot ä¹‹å‰ï¼Œå‡è¨­ä½ æ˜¯ç´”æ–°æ‰‹æ²’æœ‰é–‹é Discord å¸³è™Ÿï¼Œå¯ä»¥é€éé€™ç¯‡<a href="https://support.discord.com/hc/en-us/articles/360033931551-Getting-Started">èªªæ˜</a>å»ºç«‹è‡ªå·±çš„ Discord å¸³è™Ÿã€‚</p><h3 id="Create-Application"><a class="header-anchor" href="#Create-Application"> </a>Create Application</h3><p>é€²å…¥ <a href="https://discord.com/developers/applications">Developer Portal</a> ä¸¦ç™»å…¥æ‡‰å¯çœ‹åˆ°é€™å€‹ç•«é¢</p><p><img src="image-20221120110706291.png" alt="image-20221120110706291"></p><p>é»é¸å³ä¸Šè§’çš„ <code>New Application</code> æœƒè·³å‡ºå»ºç«‹ Application çš„è©¢å•è¦–çª—ï¼Œè¼¸å…¥ä½ æƒ³çš„åå­—ï¼Œæ‰“å‹¾ agree Terms of services å¾Œï¼ŒæŒ‰ä¸‹ <code>Create</code> å³å®Œæˆç¬¬ä¸€å€‹ Application çš„å»ºç«‹</p><p><img src="image-20221120110903558.png" alt="image-20221120110903558"></p><p>å»ºç«‹å®Œæˆå¾Œåœ¨ <code>Applications</code> çš„åˆ—è¡¨ä¸Šå°±å¯çœ‹åˆ°å‰›å‰›å»ºç«‹çš„ applicationï¼Œé»é€²å»æœƒçœ‹åˆ°ç­‰ç­‰é–‹ç™¼æ™‚æ‰€éœ€è¦çš„è³‡è¨Šï¼Œé¡ä¼¼  Application ID å’Œ Endpoint URL ã€‚</p><h3 id="Config-Bot"><a class="header-anchor" href="#Config-Bot"> </a>Config Bot</h3><p>å› ç‚ºæˆ‘å€‘è¦å»ºç«‹ Botï¼Œæ‰€ä»¥é‚„è¦å¤šåšä¸€å€‹æ­¥é©Ÿ</p><p><img src="image-20221120111248877.png" alt="image-20221120111248877"></p><p><img src="image-20221120111311212.png" alt="image-20221120111311212"></p><p>å®Œæˆé€™æ­¥é©Ÿå¾Œï¼Œæœƒçœ‹åˆ°ä¸€äº›å¯ä»¥è¨­å®šçš„é …ç›®ï¼Œå…¶ä¸­ Token æœƒæ˜¯å¾…æœƒé–‹ç™¼æ™‚éœ€è¦çš„è³‡è¨Šï¼Œæ™šé»å†å›ä¾†é€™é‚Šå»ºç«‹æ–° Token</p><p>Bot éœ€è¦å–å¾—ä½¿ç”¨æ¬Šé™åŠæˆæ¬Šç¯„åœï¼ŒDiscord ä¹Ÿå¾ˆå¥½å¿ƒçš„çµ¦äº†å»ºç«‹æ–¹å¼ï¼Œä¸€æ¨£åœ¨ Application çš„ç•«é¢è£¡ï¼Œå·¦é‚Šé¸å–®çš„<code>OAuth2</code> ä¸‹çš„ <code>URL Generator</code>ï¼Œé€™é é¢ä¸Šï¼Œæˆ‘å€‘éœ€è¦è¨­å®šå¹¾æ¨£æ±è¥¿</p><ul><li>SCOPES: <code>bot</code> ã€<code>applications.commands</code></li><li>BOT PERMISSIONS: <code>Send Messages</code> å’Œ <code>Use Slash Commands</code></li></ul><p><img src="image-20221120112233735.png" alt="image-20221120112233735"></p><p>æ­¤ç•«é¢çš„æœ€å¾Œé¢æœƒæœ‰ä¸€å€‹ <code>GENERATED URL</code> ï¼Œè¤‡è£½ä¸¦è²¼åˆ°ç€è¦½å™¨ä¸Šï¼Œæœƒé–‹å•Ÿä¸€å€‹è¨­å®šç•«é¢ï¼Œè©¢å•é€™ä¸€å€‹ Bot æƒ³è¦åŠ åˆ°å“ªä¸€å€‹ä¼ºæœå™¨ä¸­ï¼Œå°±è·Ÿè‘—æ­¥é©Ÿä¸€æ­¥ä¸€æ­¥å®Œæˆå³å¯</p><h2 id="é–‹ç™¼-Bot"><a class="header-anchor" href="#é–‹ç™¼-Bot"> </a>é–‹ç™¼ Bot</h2><p>é›–ç„¶å®˜æ–¹æœ‰æä¾›ä¸€å€‹ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼Œä½†æˆ‘é‚„æ˜¯æƒ³å¾é ­åšä¸€æ¬¡ï¼Œéç¨‹ä¸­é‚„æ˜¯æœƒåƒè€ƒ <a href="https://github.com/discord/discord-example-app">example code</a></p><ol><li><p>å»ºç«‹ä¸€å€‹ node express å°ˆæ¡ˆï¼Œæˆ‘é€™é‚Šä½¿ç”¨ NX ä¾†å¹«å¿™å»ºç«‹ workspace</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-nx-workspace --preset=express</span><br></pre></td></tr></table></figure><p><img src="image-20221120114918739.png" alt="image-20221120114918739"></p></li><li><p>ç¾åœ¨æˆ‘å€‘æœ‰ä¸€å€‹å¯ä»¥ç”¨çš„ express app å¯ä»¥é‹ä½œï¼Œä½†ç‚ºäº†è®“ Discord Server å¯ä»¥å°‡è¨Šæ¯æ‰“åˆ°æˆ‘å€‘çš„ Appï¼Œéœ€è¦é€é <code>ngrok</code> çš„å”åŠ©</p><ol><li>å•Ÿå‹• express app on port 3333</li><li>å•Ÿå‹• ngrok ä¸¦ç›£è½ port 3333ï¼Œæ­£ç¢ºå•Ÿå‹•å¾Œæœƒå–å¾—ä¸€å€‹å°å¤–ç¶²å€ï¼Œé€™å€‹ç¶²å€æˆ‘å€‘è¦å›å¡«åˆ° Discord Application çš„ <code>INTERACTIONS ENDPOINT URL</code> ä¸­ï¼Œç•¶é€™æ¨£è¨­å®šå®Œæˆå¾Œï¼ŒDiscord Server å°±æœƒå°‡ç›¸é—œçš„è¨Šæ¯ä»¥ webhook çš„æ–¹å¼æ‰“çµ¦æˆ‘å€‘</li><li>ä½†é€™è£¡æœƒç™¼ç¾ç„¡æ³•æ­£ç¢ºå„²å­˜ï¼ŒåŸå› æ˜¯æˆ‘å€‘é‚„æ²’æœ‰å¯¦åšå°æ‡‰çš„ Endpoint çµ¦ discord server åšé©—è­‰ï¼Œä¸‹é¢æœƒå®Œæˆç¬¬ä¸€éšæ®µçš„åŠŸèƒ½</li></ol></li><li><p>å‡è¨­å¡«å…¥çš„ç¶²å€æ˜¯ <code>https://xxxxxx.ngrok.io/interactions</code>ï¼Œexpress é€™é‚Šéœ€è¦å¯¦åšä¸€å€‹å°æ‡‰çš„<code>POST</code> æ–¹æ³•</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/interactions&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šä¸€æ­¥é©Ÿæ™‚é€²è¡Œè¨­å®šå„²å­˜æ™‚ï¼Œæœƒå‡ºç¾é€™å€‹éŒ¯èª¤è¨Šæ¯</p><p><img src="image-20221120121208822.png" alt="image-20221120121208822"></p><p>è¦æ’é™¤é€™å€‹éŒ¯èª¤ï¼Œéœ€è¦å¯¦åšä¸€å€‹ <code>PING-PONG</code> çš„å›æ‡‰ï¼Œå¯¦åšç¨‹å¼ç¢¼å¦‚ä¸‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InteractionResponseType</span>, <span class="title class_">InteractionType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;discord-interactions&#x27;</span>;</span><br><span class="line">...</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/interactions&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="keyword">type</span>, id, data &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Handle verification requests</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="title class_">InteractionType</span>.<span class="property">PING</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123; <span class="attr">type</span>: <span class="title class_">InteractionResponseType</span>.<span class="property">PONG</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>æœ‰å¤šå®‰è£ä¸€å€‹å¥—ä»¶ <code>discord-interactions</code></li></ul></li><li><p>é€™æ™‚å€™å›å» discord application é é¢æŒ‰å„²å­˜æ™‚é‚„æ˜¯æœƒå¤±æ•—ï¼Œè€Œä¸” express é€™é‚Šä¹Ÿæœƒå™´ <code>req.body</code> æ˜¯ undefined çš„éŒ¯èª¤ï¼Œé‚„å°‘ä¸€å€‹é©—è­‰ request çš„åŠŸèƒ½</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>(&#123; <span class="attr">verify</span>: <span class="title class_">VerifyDiscordRequest</span>(process.<span class="property">env</span>.<span class="property">PUBLIC_KEY</span>) &#125;));</span><br></pre></td></tr></table></figure><ul><li><code>PUBLIC_KEY</code> å¯ä»¥å¾ Discord Application Detail é é¢ä¸­å–å¾—ï¼Œæ”¾ç½® <code>.env</code> æª”æ¡ˆå…§å³å¯</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; verifyKey &#125; <span class="keyword">from</span> <span class="string">&#x27;discord-interactions&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">VerifyDiscordRequest</span>(<span class="params">clientKey</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">req, res, buf, encoding</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> signature = req.<span class="title function_">get</span>(<span class="string">&#x27;X-Signature-Ed25519&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> timestamp = req.<span class="title function_">get</span>(<span class="string">&#x27;X-Signature-Timestamp&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isValidRequest = <span class="title function_">verifyKey</span>(buf, signature, timestamp, clientKey);</span><br><span class="line">    <span class="keyword">if</span> (!isValidRequest) &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">send</span>(<span class="string">&#x27;Bad request signature&#x27;</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Bad request signature&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€™æ®µåŠŸèƒ½è£œä¸Šå»å¾Œï¼ŒDiscord Application è¨­å®šé é¢æ‡‰å¯æ­£ç¢ºçš„å„²å­˜äº†</p></li></ol><h3 id="è¨»å†Š-Command"><a class="header-anchor" href="#è¨»å†Š-Command"> </a>è¨»å†Š Command</h3><p>ä¸Šé¢å·²ç¶“å®Œæˆæœ€åŸºæœ¬èˆ‡ discord äº’å‹•çš„ Endpointï¼Œæ¥ä¸‹ä¾†å°±æ˜¯è¦æ˜¯è™•ç† Command çš„éƒ¨åˆ†ï¼Œæˆ‘å€‘æœŸæœ›æ˜¯ User åœ¨ Discord é »é“ä¸­ä½¿ç”¨ Bot ä¾†ä¸‹æŒ‡ä»¤ï¼Œç”¨ä¸€å€‹ <code>test</code> ä½œç‚ºæŒ‡ä»¤è¡Œç‚ºé©—è­‰ã€‚ä½¿ç”¨å‰è¦å…ˆè¨»å†Šï¼Œé€™é‚Šæœ‰é»ç¹ç‘£ï¼Œæ‹†æ­¥é©Ÿèªªæ˜</p><ol><li><p>å–å¾— APP_ID: è³‡è¨Šå¯ä»¥å¾ Discord Application Detail é é¢ä¸Šå–å¾—</p></li><li><p>GUILD_ID: é€™éƒ¨åˆ†ç¨å¾®éº»ç…©é»</p><ol><li><p>é¦–å…ˆé–‹å•Ÿ Discord ç¶²é ç‰ˆä¸¦åˆ‡åˆ°æœ‰ Bot çš„ Channel</p></li><li><p>ç¶²å€å¤§æ¦‚æœƒé•·é€™æ¨£</p><p><img src="image-20221120132856679.png" alt="image-20221120132856679"></p><p>Channels å¾Œé¢çš„ç¬¬ä¸€çµ„æ•¸å­—å°±æ˜¯æˆ‘å€‘è¦çš„ GUILD_ID äº†</p></li></ol></li><li><p>è©¢å• Channel æ˜¯å¦æœ‰è¨»å†Šé Commandsï¼Œå¦‚æœæ²’æœ‰å°±è¨»å†Š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">HasGuildCommands</span>(<span class="params">appId, guildId, commands</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (guildId === <span class="string">&#x27;&#x27;</span> || appId === <span class="string">&#x27;&#x27;</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  commands.<span class="title function_">forEach</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> <span class="title class_">HasGuildCommand</span>(appId, guildId, c));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">HasGuildCommand</span>(<span class="params">appId, guildId, command</span>) &#123;</span><br><span class="line">  <span class="comment">// API endpoint to get and post guild commands</span></span><br><span class="line">  <span class="keyword">const</span> endpoint = <span class="string">`applications/<span class="subst">$&#123;appId&#125;</span>/guilds/<span class="subst">$&#123;guildId&#125;</span>/commands`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">DiscordRequest</span>(endpoint, &#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span> &#125;);</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> res.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">      <span class="keyword">const</span> installedNames = data.<span class="title function_">map</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> c[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">      <span class="comment">// This is just matching on the name, so it&#x27;s not good for updates</span></span><br><span class="line">      <span class="keyword">if</span> (!installedNames.<span class="title function_">includes</span>(command[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Installing &quot;<span class="subst">$&#123;command[<span class="string">&#x27;name&#x27;</span>]&#125;</span>&quot;`</span>);</span><br><span class="line">        <span class="title class_">InstallGuildCommand</span>(appId, guildId, command);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`&quot;<span class="subst">$&#123;command[<span class="string">&#x27;name&#x27;</span>]&#125;</span>&quot; command already installed`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Installs a command</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">InstallGuildCommand</span>(<span class="params">appId, guildId, command</span>) &#123;</span><br><span class="line">  <span class="comment">// API endpoint to get and post guild commands</span></span><br><span class="line">  <span class="keyword">const</span> endpoint = <span class="string">`applications/<span class="subst">$&#123;appId&#125;</span>/guilds/<span class="subst">$&#123;guildId&#125;</span>/commands`</span>;</span><br><span class="line">  <span class="comment">// install command</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">DiscordRequest</span>(endpoint, &#123; <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>, <span class="attr">body</span>: command &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Command å®£å‘Š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">TEST_COMMAND</span> = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;Basic guild command&#x27;</span>,</span><br><span class="line">  <span class="attr">type</span>: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>ç•¶ express å•Ÿå‹•æ™‚åŸ·è¡Œ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="title class_">HasGuildCommands</span>(process.<span class="property">env</span>.<span class="property">APP_ID</span>, process.<span class="property">env</span>.<span class="property">GUILD_ID</span>, [<span class="variable constant_">TEST_COMMAND</span>]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ol><p>é€™æ®µæœ‰å¯¦åšä¸€å€‹ <code>DiscordRequest</code> functionï¼Œå…§å®¹å¦‚ä¸‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fetch <span class="keyword">from</span> <span class="string">&#x27;node-fetch&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">DiscordRequest</span>(<span class="params">endpoint, options</span>) &#123;</span><br><span class="line">  <span class="comment">// append endpoint to root API URL</span></span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">&#x27;https://discord.com/api/v10/&#x27;</span> + endpoint;</span><br><span class="line">  <span class="comment">// Stringify payloads</span></span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">body</span>) options.<span class="property">body</span> = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(options.<span class="property">body</span>);</span><br><span class="line">  <span class="comment">// Use node-fetch to make requests</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="title class_">Authorization</span>: <span class="string">`Bot <span class="subst">$&#123;process.env.DISCORD_TOKEN&#125;</span>`</span>,</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json; charset=UTF-8&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;User-Agent&#x27;</span>:</span><br><span class="line">        <span class="string">&#x27;DiscordBot (https://github.com/discord/discord-example-app, 1.0.0)&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    ...options,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// throw API errors</span></span><br><span class="line">  <span class="keyword">if</span> (!res.<span class="property">ok</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> res.<span class="title function_">json</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">status</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// return original response</span></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>éœ€è¦å®‰è£ <code>node-fetch</code> å¥—ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install node-fetch@^2.6.6</span><br></pre></td></tr></table></figure></li><li><p>DISCORD_TOKEN: ä¾†è‡ª Bot é é¢çš„ Token</p><p><img src="image-20221120133514279.png" alt="image-20221120133514279"></p></li></ul><p>é‡æ–°å•Ÿå‹• express appï¼Œæ‡‰è©²å¯ä»¥çœ‹åˆ° Command è¢«æˆåŠŸè¨»å†Šçš„è¨Šæ¯ï¼Œé‡æ–°å•Ÿå‹•ä¸€æ¬¡ appï¼Œä¹Ÿå¯ä»¥çœ‹åˆ° Command å·²ç¶“è¢«è¨»å†Šçš„è¨Šæ¯ã€‚å›åˆ° Channel ä¸­è¼¸å…¥ /test å°±èƒ½çœ‹åˆ°è¢«è¨»å†Šçš„æŒ‡ä»¤äº†</p><p><img src="image-20221120135115034.png" alt="image-20221120135115034"></p><h3 id="è™•ç†-Command"><a class="header-anchor" href="#è™•ç†-Command"> </a>è™•ç† Command</h3><p>ä¸Šä¸€éšæ®µæŠŠ Command è¨»å†ŠæˆåŠŸäº†ï¼Œexpress app (Bot Service) é€™é‚Šä¹Ÿè¦å¯¦åšå°æ‡‰çš„é‚è¼¯</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">type</span> === <span class="title class_">InteractionType</span>.<span class="property">APPLICATION_COMMAND</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = data;</span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">&#x27;test&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// Send a message into the channel where command was triggered from</span></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">InteractionResponseType</span>.<span class="property">CHANNEL_MESSAGE_WITH_SOURCE</span>,</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="comment">// Fetches a random emoji to send from a helper function</span></span><br><span class="line">        <span class="attr">content</span>: <span class="string">&#x27;hello world !&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸ·è¡Œçµæœ</p><p><img src="image-20221120135415958.png" alt="image-20221120135415958"></p><h2 id="å°çµ"><a class="header-anchor" href="#å°çµ"> </a>å°çµ</h2><p>åˆæœŸè¦è¨­å®š Bot åœ¨ Discord ä¸Šé¢è·‘éœ€è¦ä¸€äº›è¨­å®šï¼Œåœ¨å¯«é€™ç¯‡ç­†è¨˜æ™‚ï¼Œæ¯”è¼ƒæœƒå¡ä½çš„é»æ˜¯æµç¨‹é¢ï¼ŒDiscord åœ¨ç›¸é—œçš„è¨­å®šä¸Šå…¶å¯¦é‚„ç®—ç°¡å–®ï¼Œç¬¬ä¸€é—œæ‰“é€šå¾Œï¼Œå¾Œé¢æœƒæ¯”è¼ƒé †ä¸€é»ã€‚æ‰€ä»¥ç¨å¾®è¤‡é›œçš„äº’å‹•è¡Œç‚ºå°±ç•™åœ¨ä¸‹ä¸€ç¯‡ç­†è¨˜äº†</p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://support.discord.com/hc/en-us/articles/360033931551-Getting-Started">Discord Getting Start</a></li><li><a href="https://discord.com/developers/docs/intro">Discord Developer Portal</a></li><li><a href="https://discord.com/developers/docs/getting-started">Discord é–‹ç™¼ APP QuickStart</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘æ¥äº†é—œæ–¼ Bot é–‹ç™¼ç›¸é—œçš„æ¥­å‹™ï¼Œè¶ä¼‘æ¯æ™‚é–“ç©ä¸€ä¸‹ Discord Bot çš„é–‹ç™¼é«”é©—ï¼Œå°‡éç¨‹è¨˜éŒ„ä¸€ä¸‹ï¼Œæä¸å¥½å¾Œé¢é‚„ç”¨çš„åˆ°ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨é€™ä¹‹å‰é‚„æ˜¯å¿«é€Ÿä»‹ç´¹ä¸€ä¸‹ Discordã€‚Discordæ˜¯ä¸€æ¬¾å°ˆç‚ºç¤¾ç¾¤è¨­è¨ˆçš„å…è²»ç¶²è·¯å³æ™‚é€šè©±è»Ÿé«”èˆ‡æ•¸ä½ç™¼è¡Œå¹³å°ï¼Œåœ¨æ—©æœŸå¾ˆå¸¸è¢«éŠæˆ²ç©å®¶æ‹¿ä¾†åšç·šä¸Šé€£ç·šæ™‚çš„é€šè¨Šè»Ÿé«”ï¼Œç¾åœ¨æ˜¯å¾ˆå¤šç”¢å“ã€ç¤¾ç¾¤ç­‰éƒ½æœƒåˆ©ç”¨ Discord ä¾†ç¶“ç‡Ÿç¤¾ç¾¤ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="BOT" scheme="http://blog.kevinyang.net/categories/BOT/"/>
    
    
    <category term="BOT" scheme="http://blog.kevinyang.net/tags/BOT/"/>
    
    <category term="Discord" scheme="http://blog.kevinyang.net/tags/Discord/"/>
    
  </entry>
  
  <entry>
    <title>[Dapr] ä½¿ç”¨ Dapr é–‹ç™¼ - Hello World</title>
    <link href="http://blog.kevinyang.net/2022/11/05/study-dapr-2/"/>
    <id>http://blog.kevinyang.net/2022/11/05/study-dapr-2/</id>
    <published>2022-11-05T03:08:05.000Z</published>
    <updated>2023-12-30T10:00:10.159Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡çŸ¥é“ Dapr æ˜¯ä»€éº¼å¾Œï¼Œå°±è¦é€²å…¥ Hello World çš„ä¸–ç•Œäº†ï¼Œè‘—æ‰‹å¯«çœ‹çœ‹ç¬¬ä¸€å€‹ Dapr æ‡‰ç”¨ç¨‹å¼</p><span id="more"></span><h2 id="ç’°å¢ƒå®‰è£"><a class="header-anchor" href="#ç’°å¢ƒå®‰è£"> </a>ç’°å¢ƒå®‰è£</h2><p>å¦‚æœæ²’æœ‰å®‰è£é <code>Dapr CLI</code> çš„ï¼Œå¯ä»¥å…ˆå®‰è£ï¼Œä»–å¯ä»¥ä»»æˆ‘å€‘åœ¨é–‹ç™¼ç’°å¢ƒä¸ŠåŸ·è¡Œã€å•Ÿå‹•ã€ç®¡ç†å’Œé™¤éŒ¯ Dapr instancesã€‚é›–ç„¶ä¸æ˜¯å¿…è¦ä½†å»ºè­°é–‹ç™¼ç’°å¢ƒè¦æ”¯æ´ Docker</p><p>æ­¥é©Ÿå¦‚ä¸‹</p><ol><li><p><a href="https://docs.dapr.io/getting-started/install-dapr-cli/">å®‰è£ Dapr CLI</a></p></li><li><p><a href="https://docs.dapr.io/getting-started/install-dapr-selfhost/">åˆå§‹åŒ– Dapr</a>ã€‚ æ­¤æ­¥é©Ÿæœƒå®‰è£æœ€æ–°çš„ Dapr äºŒé€²ä½æª”å’Œå®¹å™¨æ˜ å°„ï¼Œä»¥è¨­å®šæ‚¨çš„é–‹ç™¼ç’°å¢ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dapr init</span><br></pre></td></tr></table></figure><p><img src="image-20221105194553626.png" alt="image-20221105194553626"></p><p><img src="image-20221105194623033.png" alt="image-20221105194623033"></p><p>ç’°å¢ƒå¤šæº–å‚™äº†é€™ä¸‰å€‹ containersï¼Œé€™æ™‚å€™æˆ‘å€‘å°±å¯ä»¥æº–å‚™ä¾†é–‹ç™¼ç¬¬ä¸€å€‹ Dapr æ‡‰ç”¨ç¨‹å¼</p></li></ol><h2 id="ç¬¬ä¸€å€‹-Dapr-æ‡‰ç”¨ç¨‹å¼"><a class="header-anchor" href="#ç¬¬ä¸€å€‹-Dapr-æ‡‰ç”¨ç¨‹å¼"> </a>ç¬¬ä¸€å€‹ Dapr æ‡‰ç”¨ç¨‹å¼</h2><p>Dapr æœ‰æä¾›ä¸åŒèªè¨€çš„ SDKï¼Œæ–¹ä¾¿ä½¿ç”¨è€…èƒ½è‡ªç„¶ä¸”ç›´è¦ºçš„èˆ‡ Dapr åšäº’å‹•</p><p><img src="image-20221105194821719.png" alt="image-20221105194821719"></p><p>é€™è£¡çš„ç¯„ä¾‹æˆ‘ä½¿ç”¨ .net core console ä¾†ç·´ç¿’</p><ol><li><p>å»ºç«‹ä¸€å€‹ console ç¨‹å¼</p></li><li><p>å®‰è£ <code>Dapr.Client</code> å¥—ä»¶</p></li><li><p>åœ¨ <code>program.cs</code> è²¼ä¸Šé€™æ®µç¨‹å¼ç¢¼</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Dapr.Client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">string</span> storeName = <span class="string">&quot;statestore&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">string</span> key = <span class="string">&quot;counter&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> daprClient = <span class="keyword">new</span> DaprClientBuilder().Build();</span><br><span class="line"><span class="keyword">var</span> counter = <span class="keyword">await</span> daprClient.GetStateAsync&lt;<span class="built_in">int</span>&gt;(storeName, key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Counter = <span class="subst">&#123;counter++&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> daprClient.SaveStateAsync(storeName, key, counter);</span><br><span class="line">    <span class="keyword">await</span> Task.Delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>line 6: å»ºç«‹ dapr Client</li><li>line 7: å–å¾— <code>counter</code> state</li><li>line 13: å„²å­˜å€¼å› <code>counter</code> state</li></ul></li><li><p>è©¦è‘—ç”¨ <code>dapr</code> æŒ‡ä»¤ä¾†åŸ·è¡Œç¨‹å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dapr run --app-id DaprCounter dotnet run</span><br></pre></td></tr></table></figure><p>æœƒçœ‹åˆ°ç¨‹å¼æœƒè·‘èµ·ä¾†ï¼Œè€Œä¸”ä¹Ÿèƒ½çœ‹åˆ° Counter çš„å€¼è¢«æŒçºŒå¢åŠ ä¸Šå»ï¼Œè€Œä¸”ç•¶é‡å•Ÿç¨‹å¼å¾Œï¼Œä¹Ÿæœƒä¿ç•™ä¸Šä¸€æ¬¡çš„çµæœç¹¼çºŒ  <img src="image-20221105200300957.png" alt="image-20221105200300957"></p><p><img src="image-20221105200334950.png" alt="image-20221105200334950"></p></li></ol><p>ä½¿ç”¨ <code>dapr run</code> æ™‚ï¼Œ<code>--app-id</code> å¾ˆé‡è¦ï¼Œstate management building block æ˜¯ä½¿ç”¨é€™å€‹ç‚º prefix çš„å€¼ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡åŸ·è¡Œä¸æ˜¯ä½¿ç”¨åŒä¸€å€‹ <code>app-id</code> å‰‡æœƒè¢«è¦–ç‚ºä¸åŒçš„ç‹€æ…‹</p><p>é‚„è¨˜å¾—ä¸€é–‹å§‹åœ¨ <code>dapr init</code> æ™‚ï¼Œæœ‰å•Ÿå‹•å¹¾å€‹ containerï¼Œå…¶ä¸­ä¸€å€‹æ˜¯ <code>redis</code>ï¼Œé€™ä¹Ÿæ˜¯ dapr å„²å­˜ç‹€æ…‹çš„åœ°æ–¹ï¼Œåœ¨ä¸Šä¸€ç¯‡ä¹Ÿæœ‰æåˆ°æ¯ä¸€å€‹ building block å¾Œé¢çš„å…ƒä»¶æ˜¯å¯ä»¥è¢«æŠ½æ›çš„ï¼Œç›¸é—œè¨­å®šæª”æ˜¯é€é yaml ä¾†è¨­å®šï¼Œè¨­å®šæª”å„²å­˜ä½ç½®å¦‚ä¸‹</p><ul><li><p>mac/Linux: <code>$HOME/.dapr/components</code></p></li><li><p>windows: <code>%USERPROFILE%\.dapr\components</code></p><p><img src="image-20221105201130802.png" alt="image-20221105201130802"></p></li></ul><p>å¾åœ–ç‰‡ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸€å€‹ <code>statesotre.yaml</code> çš„æª”æ¡ˆï¼Œå…§å®¹æœƒæ˜¯é€™æ¨£</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">dapr.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Component</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">statestore</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">state.redis</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redisHost</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">localhost:6379</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redisPassword</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">actorStateStore</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">scopes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">DaprCounter</span></span><br></pre></td></tr></table></figure><ul><li>line 4: é€™è£¡çš„ name æœƒå°æ‡‰åˆ°ä¸Šé¢ç¨‹å¼ç¢¼çš„ line 3 <code>const string storeName = &quot;statestore&quot;;</code></li><li>line 15: å¯é€é <code>scopes</code> ä¾†é™å®šèƒ½å­˜å–æ­¤å…ƒä»¶çš„æ‡‰ç”¨ç¨‹å¼ (<code>app-id</code>)</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸Šä¸€ç¯‡çŸ¥é“ Dapr æ˜¯ä»€éº¼å¾Œï¼Œå°±è¦é€²å…¥ Hello World çš„ä¸–ç•Œäº†ï¼Œè‘—æ‰‹å¯«çœ‹çœ‹ç¬¬ä¸€å€‹ Dapr æ‡‰ç”¨ç¨‹å¼&lt;/p&gt;</summary>
    
    
    
    <category term="Dapr" scheme="http://blog.kevinyang.net/categories/Dapr/"/>
    
    
    <category term="Dapr" scheme="http://blog.kevinyang.net/tags/Dapr/"/>
    
  </entry>
  
  <entry>
    <title>[Dapr] What is Dapr?</title>
    <link href="http://blog.kevinyang.net/2022/11/05/study-dapr-1/"/>
    <id>http://blog.kevinyang.net/2022/11/05/study-dapr-1/</id>
    <published>2022-11-05T01:45:10.000Z</published>
    <updated>2023-12-30T10:00:10.155Z</updated>
    
    <content type="html"><![CDATA[<p>Dapr åœ¨ 2019 ç¬¬ä¸€æ¬¡å…¬é–‹æ™‚ï¼Œé‚£æ™‚å€™ç‰ˆæœ¬é‚„æ˜¯ 0.1 æ™‚ï¼Œå°±æœ‰ç•™æ„åˆ°ï¼Œæƒ³ä¸åˆ°å¹¾å¹´å¾Œï¼Œä¸åƒ…é€²å…¥ CNCF é‚„è®Šæˆå¾ˆå¤šäººæ¨è–¦çš„æ¡†æ¶ï¼Œæ‰€ä»¥é‡æ–°æ‹¾å›ç ”ç©¶ä¸€ä¸‹ Dapr çš„æ¶æ§‹åŠå¦‚ä½•ä½¿ç”¨åœ¨å·¥ä½œä¸Š</p><span id="more"></span><p>ç‚ºä»€éº¼æœƒå›ä¾†çœ‹ Daprï¼Œæœ€ä¸»è¦çš„åŸå› æ˜¯ç›®å‰çš„å·¥ä½œï¼Œç³»çµ±éƒ½æ˜¯ä»¥å¾®æœå‹™çš„å½¢å¼è·‘åœ¨è‡ªæ¶çš„ K8s ä¸Šï¼Œä¸€æ—¦åˆ°é”ä¸€å€‹è¦æ¨¡æ•´å€‹ç®¡ç†è·Ÿå¯¦åšä¸Šè¦è€ƒæ…®çš„äº‹æƒ…è®Šçš„ç›¸å°è¤‡é›œï¼Œè€Œ Dapr å¯ä»¥é™ä½é€™éƒ¨åˆ†çš„å·¥ä½œä¸¦ä»¥ä¸€è‡´çš„æ¨¡å¼å¥—ç”¨åœ¨ä¸åŒçš„èªè¨€è·ŸæŠ€è¡“æ¡†æ¶ä¸Š</p><h2 id="What-is-Dapr"><a class="header-anchor" href="#What-is-Dapr"> </a>What is Dapr</h2><p>å®˜ç¶²ä¸Šæ˜¯é€™æ¨£å­ä»‹ç´¹çš„</p><blockquote><p>APIs for building portable and reliable microservices</p><p>Leverage industry best practices and focus on your applicationâ€™s logic.</p></blockquote><p><img src="image-20221105101325259.png" alt="image-20221105101325259"></p><p>å¾åœ–ç‰‡ä¸Šå¯ä»¥çŸ¥é“  Dapr æ˜¯èµ° sidecar æ¨¡å¼ï¼Œä½†å¥½å®¶åœ¨ä»–åº•å±¤æ˜¯ä½¿ç”¨ go å¯¦åšï¼ŒåŸ·è¡Œèµ·ä¾†ä¹Ÿä¸æœƒå¤ªç¬¨é‡ï¼Œä¸¦æä¾›ç°¡åŒ–ä¸å°‘åŸç³»çµ±è¦è™•ç†çš„æ±è¥¿ã€‚è€Œä¸” Dapr sidecar ä¹‹é–“çš„æºé€šæ˜¯æ¡ç”¨ <code>gRPC</code> çš„æ¨¡å¼ä¾†é™ä½æ•´é«”çš„è² æ“”ï¼Œå°‡æ•ˆèƒ½å½±éŸ¿é™è‡³æœ€ä½</p><h2 id="Dapr-æ¶æ§‹"><a class="header-anchor" href="#Dapr-æ¶æ§‹"> </a>Dapr æ¶æ§‹</h2><p><img src="dapr-high-level.png" alt="Dapr at 20,000 feet"></p><p>å¾é€™å¼µåœ–å°šå¯çŸ¥é“ï¼ŒåŸæœ¬çš„æ‡‰ç”¨ç¨‹å¼å¯é€é HTTP æˆ– gRPC çš„æ–¹å¼èˆ‡ Dapr çš„å…ƒä»¶æºé€šï¼Œåœ¨é€™æ¨¡å¼ä¸‹ï¼Œæ‡‰ç”¨ç¨‹å¼é–“çš„äº’å‹•æœƒç”± <code>ä»£ç†äºº</code> Dapr ä¾†è™•ç†ï¼Œä¹‹å¾Œæˆ‘æœƒèªªæ˜ç‚ºä»€éº¼æˆ‘æœƒå°‡å…¶å®šç¾©æˆ <code>ä»£ç†äºº</code> çš„åŸå› </p><p>Dapr æä¾›å¹¾å€‹ç©æœ¨ä¾›æˆ‘å€‘ä½¿ç”¨ (å¦‚ä¸‹è¡¨)ï¼Œè®“æˆ‘å€‘æœ‰æŠ½æ›èƒŒå¾Œå°æ‡‰çš„æœå‹™ (æŠ½è±¡åŒ–)</p><table><thead><tr><th style="text-align:left">Building block</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left">State management</td><td style="text-align:left">Support contextual information for long running stateful services.</td></tr><tr><td style="text-align:left">Service invocation</td><td style="text-align:left">Invoke direct, secure service-to-service calls using platform agnostic protocols and well-known endpoints.</td></tr><tr><td style="text-align:left">Publish and subscribe</td><td style="text-align:left">Implement secure, scalable pub/sub messaging between services.</td></tr><tr><td style="text-align:left">Bindings</td><td style="text-align:left">Trigger code from events raised by external resources with bi-directional communication.</td></tr><tr><td style="text-align:left">Observability</td><td style="text-align:left">Monitor and measure message calls across networked services.</td></tr><tr><td style="text-align:left">Secrets</td><td style="text-align:left">Securely access external secret stores.</td></tr><tr><td style="text-align:left">Actors</td><td style="text-align:left">Encapsulate logic and data in reusable actor objects.</td></tr></tbody></table><p><img src="building-blocks-integration.png" alt="Dapr building blocks integration"></p><p>ä¸€é–‹å§‹æœ‰æåˆ° Dapr æ˜¯ä½¿ç”¨ <code>sidecar</code> æ¨¡å¼èˆ‡ application åšäº’å‹•ï¼Œæ‰€ä»¥æ¶æ§‹æœƒé•·çš„åƒé€™æ¨£</p><p><img src="sidecar-generic.png" alt="Sidecar architecture"></p><h2 id="Hosting-Environment"><a class="header-anchor" href="#Hosting-Environment"> </a>Hosting Environment</h2><p>Dapr çš„åŸ·è¡Œç’°å¢ƒæœ‰åˆ† <code>self-hosted</code> å’Œ <code>container</code> æ¨¡å¼</p><p><img src="self-hosted-dapr-sidecar.png" alt="Self-hosted sidecar architecture"></p><p><img src="kubernetes-hosted-dapr-sidecar.png" alt="Kubernetes-hosted sidecar architecture"></p><p>æ‰€ä»¥åœ¨æœ¬æ©Ÿé–‹ç™¼ç’°å¢ƒå¦‚æœæ²’æœ‰ docker ä¹Ÿé‚„æ˜¯å¯ä»¥é€é <code>self-hosted</code> çš„æ¨¡å¼é€²è¡Œé–‹ç™¼ï¼Œä¸æœƒå½±éŸ¿ä¹‹å¾Œçš„éƒ¨å±¬ï¼Œ<code>self-hosted</code> å¯é€é Dapr cli ä¾†å®Œæˆç›¸é—œçš„æ“ä½œ (<a href="https://docs.Dapr.io/getting-started/install-Dapr-cli/">Dapr CLI installer</a>)</p><h3 id="Service-Mesh-Dapr"><a class="header-anchor" href="#Service-Mesh-Dapr"> </a>Service  Mesh &amp; Dapr</h3><p>Service Mesh æ˜¯å¦å¤–ä¸€å€‹å‰å¤§çš„å‘ï¼Œå…¶è² è²¬ç¯„åœå…¶å¯¦å¾ˆå¤šï¼Œç§‘æ™®ä¸€ä¸‹</p><blockquote><p>æœå‹™ç¶²æ ¼æ˜¯ä¸€å€‹å¯è¨­å®šçš„åŸºç¤çµæ§‹å±¤ï¼Œå…§å»ºåŠŸèƒ½å¯è™•ç†æœå‹™å°æœå‹™é€šè¨Šã€å¾©åŸã€è² è¼‰å¹³è¡¡å’Œé™æ¸¬æ“·å–ã€‚ å®ƒæœƒå°‡é€™äº›è€ƒæ…®çš„è²¬ä»»ç§»å‡ºæœå‹™ï¼Œä¸¦ç§»å…¥æœå‹™ç¶²æ ¼å±¤ã€‚</p></blockquote><p>Dapr ä¹Ÿéµå¾ªä¸€æ¨£çš„æ¨¡å¼ï¼Œæ‰€ä»¥æ¥ä¸‹ä¾†çš„å•é¡Œæœƒæ˜¯ Dapr å¯ä»¥å–ä»£åŸæœ¬çš„ service mesh å—? å…¶å¯¦ Dapr å¯ä»¥èˆ‡åŸæœ‰çš„ Service Mesh å…±å­˜ï¼Œè² è²¬çš„æ¥­å‹™ç¯„åœæœƒä¸å¤ªä¸€æ¨£ï¼ŒDapr æä¾›ç³»çµ±æœå‹™ï¼Œservice mesh æä¾›æœå‹™é–“çš„ç¶²è·¯æºé€š</p><p><img src="dapr-and-service-mesh.png" alt="Dapr and Service Mesh together"></p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://learn.microsoft.com/en-us/dotnet/architecture/dapr-for-net-developers/">Dapr for .NET Developers</a></li><li><a href="https://docs.Dapr.io/getting-started/install-Dapr-cli/">Dapr CLI installer</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Dapr åœ¨ 2019 ç¬¬ä¸€æ¬¡å…¬é–‹æ™‚ï¼Œé‚£æ™‚å€™ç‰ˆæœ¬é‚„æ˜¯ 0.1 æ™‚ï¼Œå°±æœ‰ç•™æ„åˆ°ï¼Œæƒ³ä¸åˆ°å¹¾å¹´å¾Œï¼Œä¸åƒ…é€²å…¥ CNCF é‚„è®Šæˆå¾ˆå¤šäººæ¨è–¦çš„æ¡†æ¶ï¼Œæ‰€ä»¥é‡æ–°æ‹¾å›ç ”ç©¶ä¸€ä¸‹ Dapr çš„æ¶æ§‹åŠå¦‚ä½•ä½¿ç”¨åœ¨å·¥ä½œä¸Š&lt;/p&gt;</summary>
    
    
    
    <category term="Dapr" scheme="http://blog.kevinyang.net/categories/Dapr/"/>
    
    
    <category term="Dapr" scheme="http://blog.kevinyang.net/tags/Dapr/"/>
    
  </entry>
  
  <entry>
    <title>[OIDC] ç­è§£ OIDC çš„è¡¨å±¤</title>
    <link href="http://blog.kevinyang.net/2022/10/30/oidc-notes/"/>
    <id>http://blog.kevinyang.net/2022/10/30/oidc-notes/</id>
    <published>2022-10-30T00:21:43.000Z</published>
    <updated>2023-12-30T10:00:10.155Z</updated>
    
    <content type="html"><![CDATA[<p>Keycloak æä¾›äº†å¹¾ç¨® protocolsï¼ŒOpenID Connect (OIDC)ã€OAuth 2.0 and SAMLã€‚é›–ç„¶ OIDC &amp; OAuth 2.0 å·²å­˜åœ¨ä¸€æ®µæ™‚é–“ï¼Œä½†å› ç‚ºæ²’æœ‰ä½¿ç”¨å¯¦åšä¸Šçš„æƒ…å¢ƒï¼Œæ‰€ä»¥éƒ½æ²’æœ‰èŠ±æ™‚é–“å»ç­è§£èƒŒå¾Œçš„é‹ä½œåŸç†ï¼Œä¸€æ¨£åˆ©ç”¨é€±æœ«çš„æ™‚é–“ä¾†åšä¸€ä¸‹åŠŸèª²</p><span id="more"></span><p>æ ¹æ“šé–±è®€å¤šç¯‡æ–‡ä»¶ç­è§£ï¼ŒOIDC æ˜¯åŸºæ–¼ OAuth 2.0 ç™¼å±•å‡ºä¾†çš„ï¼Œçœ‹èµ·ä¾†å¾—å…ˆçœ‹ OAuth 2.0 æ˜¯ä»€éº¼</p><p><img src="image-20221030104933158.png" alt="image-20221030104933158"></p><h2 id="OAuth-2-0"><a class="header-anchor" href="#OAuth-2-0"> </a>OAuth 2.0</h2><p>OAuth 2.0 åŸºæœ¬ä¸Šè™•ç† Authorization çš„éƒ¨åˆ†ï¼Œç”¨ä¾†æ§åˆ¶æˆæ¬Š<strong>èª°</strong>èƒ½å­˜å–<strong>è³‡æº</strong>ï¼Œæœ‰å››å€‹åŸºæœ¬å…ƒç´ </p><ol><li><strong>authorization server</strong>: ç”¨ä¾†ç™¼ access token çš„ server</li><li><strong>resource owner</strong>: æœ‰æ¬Šé™èƒ½å­˜å–è³‡æ–™çš„ä½¿ç”¨è€…</li><li><strong>client</strong>: å°‡ access token å‚³çµ¦ç³»çµ±æœå‹™çš„æ‡‰ç”¨ç¨‹å¼</li><li><strong>resource server</strong>: æ¥å— access token ä¸¦é©—è­‰å…¶åˆæ³•æ€§</li></ol><p>å…¶ä»–åè©</p><ol><li><strong>authorization grant</strong>: æˆæ¬Šç¯„åœ</li><li><strong>access token</strong>: ç”± <code>authorization server</code> ç™¼å‡ºï¼Œæœƒåœ¨ç™¼è«‹æ±‚æ™‚é™„åŠ åœ¨é€²å»çµ¦ <code>resource server</code></li><li><strong>redirect URI</strong>: ç™»å…¥å¾Œè¦è½‰å›çš„è·¯å¾‘</li></ol><h3 id="æˆæ¬Šæµç¨‹"><a class="header-anchor" href="#æˆæ¬Šæµç¨‹"> </a>æˆæ¬Šæµç¨‹</h3><ol><li><p>Authorization Code</p><p><img src="image-20221030091611632.png" alt="image-20221030091611632"></p><p>é€™ç®—æ˜¯æ¯”è¼ƒå¸¸è¦‹çš„æ¨¡å¼ï¼Œç™»å…¥ç•«é¢æœƒç”± <code>authorization server</code> æä¾›ï¼Œé€é <code>redirect URI</code> çš„æ–¹å¼å¸¶è‘— <code>authorization code</code> å›åˆ° <code>client</code> ç«¯ä¾›å¾Œé¢ä½¿ç”¨</p><blockquote><p>é€™æµç¨‹ä¹Ÿæ˜¯ Keycloak JavaScript adapter é è¨­è¡Œç‚º</p></blockquote></li><li><p>Implicit</p><p><img src="image-20221030091931055.png" alt="image-20221030091931055"></p><p>ä½¿ç”¨å ´æ™¯æ˜¯ SPA æˆ–æ˜¯ç´”å‰ç«¯ç³»çµ±ï¼Œèˆ‡ <code>Authorization Code</code> æ¨¡å¼çš„å·®ç•°åœ¨æ–¼ <code>access token</code> çš„å–å¾—æ–¹å¼ï¼Œ</p><blockquote><p>é€™æ¨¡å¼æ¯”è¼ƒä¸å®‰å…¨ï¼Œã€Œé€é URI Fragment ä¾†å‚³ Access Token ï¼Œæ‰€ä»¥å¯èƒ½æœƒå¤–æ´©ã€</p></blockquote></li><li><p>Resource Owner Password Credentials</p><p><img src="image-20221030092328110.png" alt="image-20221030092328110"></p><p>é€™æ¯”è¼ƒåƒæ˜¯éå¾€çš„ server side ç¶²é æœå‹™</p></li><li><p>Client Credentials</p><p><img src="image-20221030092618674.png" alt="image-20221030092618674"></p><p>é©ç”¨å ´æ™¯: machine-to-machine (M2M) applications</p></li></ol><p>(åœ–ç‰‡å‡ºè‡ª: <a href="https://medium.com/%E9%BA%A5%E5%85%8B%E7%9A%84%E5%8D%8A%E8%B7%AF%E5%87%BA%E5%AE%B6%E7%AD%86%E8%A8%98/%E7%AD%86%E8%A8%98-%E8%AA%8D%E8%AD%98-oauth-2-0-%E4%B8%80%E6%AC%A1%E4%BA%86%E8%A7%A3%E5%90%84%E8%A7%92%E8%89%B2-%E5%90%84%E9%A1%9E%E5%9E%8B%E6%B5%81%E7%A8%8B%E7%9A%84%E5%B7%AE%E7%95%B0-c42da83a6015">[ç­†è¨˜] èªè­˜ OAuth 2.0ï¼šä¸€æ¬¡äº†è§£å„è§’è‰²ã€å„é¡å‹æµç¨‹çš„å·®ç•°</a>)</p><h2 id="OIDC"><a class="header-anchor" href="#OIDC"> </a>OIDC</h2><p>ç­è§£åŸºæœ¬ OAuth 2.0 å¾Œï¼Œé‚£ OIDC åˆæ˜¯ä»€éº¼ï¼Œä¸€é–‹å§‹æåˆ° <code>OIDC æ˜¯åŸºæ–¼ OAuth 2.0 ç™¼å±•å‡ºä¾†çš„</code></p><p>å…ˆæä¸€ä¸‹ <code>OAuth 2.0</code> åªæœ‰åš <code>Authorization</code> çš„éƒ¨åˆ†ï¼Œä¸¦æ²’æœ‰æ¶µè“‹<code>Authentication</code> çš„éƒ¨åˆ†ï¼Œé€™å…©è€…çš„å·®ç•°æ˜¯ä»€éº¼å‘¢?</p><ul><li>Authorization: æˆæ¬Šä½¿ç”¨ç¯„åœ</li><li>Authentication: ä½¿ç”¨è€…èªè­‰ï¼Œä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨åŠä½¿ç”¨è€…æ˜¯èª°ï¼Œéƒ½ç®—åœ¨èªè­‰çš„ç¯„åœå…§</li></ul><p><img src="image-20221030093943446.png" alt="image-20221030093943446"></p><p>(åœ–ç‰‡ä¾†æº: <a href="https://openid.net/connect/">https://openid.net/connect/</a>)</p><p>æ•´å€‹çš„æµç¨‹å¤§æ¦‚æœƒæ˜¯é€™æ¨£</p><p><img src="image-20221030094329195.png" alt="image-20221030094329195"></p><p>ä¸€äº›æœƒå‡ºç¾åœ¨ OIDC çš„åè©</p><ul><li><strong>End User</strong>: Human participant.</li><li><strong>Replying Party (RP)</strong>: OAuth 2.0 Client application requiring End-User Authentication and Claims from an OpenID Provider.</li><li><strong>OpenID Provider (OP)</strong>: OAuth 2.0 Authorization Server that is capable of Authenticating the End-User and providing Claims to a Relying Party about the Authentication event and the End-User.</li><li><strong>ID Token</strong>: <a href="https://openid.net/specs/openid-connect-core-1_0.html#JWT">JSON Web Token (JWT)</a> [JWT] that contains Claims about the Authentication event. It MAY contain other Claims.</li><li><strong>UserInfo Endpoint</strong>: Protected Resource that, when presented with an Access Token by the Client, returns authorized information about the End-User represented by the corresponding Authorization Grant. The UserInfo Endpoint URL MUST use the <code>https</code> scheme and MAY contain port, path, and query parameter components.</li></ul><h3 id="å¸¸è¦‹-flow"><a class="header-anchor" href="#å¸¸è¦‹-flow"> </a>å¸¸è¦‹ flow</h3><ol><li><strong>Authorization Code</strong></li><li><strong>Implicit</strong>: with Id_token</li><li><strong>Hybrid</strong>:  Authorization Code+ Implicit</li></ol><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://www.youtube.com/watch?v=996OiexHze0&amp;t=2s">OAuth 2.0 and OpenID Connect (in plain English)</a></li><li><a href="https://kimlin20011.medium.com/%E6%B7%B1%E5%85%A5%E6%B7%BA%E5%87%BA-openid-connect-%E4%B8%80-8701bbf00958">æ·±å…¥æ·ºå‡º OpenID Connect (ä¸€)</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Keycloak æä¾›äº†å¹¾ç¨® protocolsï¼ŒOpenID Connect (OIDC)ã€OAuth 2.0 and SAMLã€‚é›–ç„¶ OIDC &amp;amp; OAuth 2.0 å·²å­˜åœ¨ä¸€æ®µæ™‚é–“ï¼Œä½†å› ç‚ºæ²’æœ‰ä½¿ç”¨å¯¦åšä¸Šçš„æƒ…å¢ƒï¼Œæ‰€ä»¥éƒ½æ²’æœ‰èŠ±æ™‚é–“å»ç­è§£èƒŒå¾Œçš„é‹ä½œåŸç†ï¼Œä¸€æ¨£åˆ©ç”¨é€±æœ«çš„æ™‚é–“ä¾†åšä¸€ä¸‹åŠŸèª²&lt;/p&gt;</summary>
    
    
    
    <category term="Keycloak" scheme="http://blog.kevinyang.net/categories/Keycloak/"/>
    
    
    <category term="Keycloak" scheme="http://blog.kevinyang.net/tags/Keycloak/"/>
    
  </entry>
  
  <entry>
    <title>[Keycloak] WebAPI with Keycloak</title>
    <link href="http://blog.kevinyang.net/2022/10/23/keycloak-note-2/"/>
    <id>http://blog.kevinyang.net/2022/10/23/keycloak-note-2/</id>
    <published>2022-10-23T05:37:00.000Z</published>
    <updated>2023-12-30T10:00:10.151Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡ä»‹ç´¹äº†åŸºæœ¬ç’°å¢ƒè¨­å®šèˆ‡ Angular å‰ç«¯å¦‚ä½•å¥—ç”¨ Keycloakï¼Œä½†ä¸€å€‹å®Œæ•´çš„æµç¨‹æ‡‰è©²é‚„æœƒåŒ…å«å¾Œç«¯çš„ API é©—è­‰ï¼Œé€™ç¯‡æœƒç”¨ C# çš„ WebAPI ä¾†åšä¸€å€‹ç°¡å–®ç¯„ä¾‹</p><span id="more"></span><h2 id="New-Keycloak-Client"><a class="header-anchor" href="#New-Keycloak-Client"> </a>New Keycloak Client</h2><p>åœ¨ KeyCloak Admin Console å…§å¤šæ–°å¢ä¸€å€‹ Client ä¸¦æŠŠä¸€äº›è¨­å®šå…¨éƒ¨é—œæ‰ï¼Œåœ¨æœ€æ–°ç‰ˆçš„ä»‹é¢è£¡é¢å·²ç¶“æ‰¾ä¸åˆ°è¨­å®š <code>access type</code> çš„ä»‹é¢äº†ï¼ŒGoogle ä¸€ç•ªå¾Œç™¼ç¾åªè¦å°‡æ‰€æœ‰çš„ Authentication flow å…¨éƒ¨å–æ¶ˆæ‰ï¼Œå°±æ˜¯ä»¥å‰çš„ Bearer-only æ¨¡å¼</p><p>æ‰€è¬‚çš„ Bearer-only æ¨¡å¼: the application only allows bearer token requests</p><p><img src="image-20221023185121179.png" alt="image-20221023185121179"></p><p>è¨­å®šå®Œæˆå¾Œå¯ä»¥åˆ°åŒä¸€ç•«é¢çš„å³ä¸Šè§’å–é¡ setting json å…§å®¹</p><p><img src="image-20221023185454979.png" alt="image-20221023185454979"></p><p>å°‡å…§å®¹è¤‡è£½èµ·ä¾†ï¼Œç­‰ç­‰å»ºç«‹åœ¨ Core WebAPI å°ˆæ¡ˆçš„åœ°æ–¹ç”¨çš„åˆ°</p><h2 id="c-å°ˆæ¡ˆ"><a class="header-anchor" href="#c-å°ˆæ¡ˆ"> </a>c# å°ˆæ¡ˆ</h2><p>å…ˆæ–°å¢ä¸€å€‹ <a href="http://ASP.NET">ASP.NET</a> Core WebAPI çš„å°ˆæ¡ˆï¼Œä¸¦å®‰è£ <a href="https://www.nuget.org/packages/Keycloak.AuthServices.Authentication/1.2.1?_src=template">Keycloak.AuthServices.Authentication</a> å¥—ä»¶</p><p>å°‡ä¸Šå€‹æ­¥é©Ÿçš„ adapter config å…§å®¹æ–°å¢åˆ° <code>appsettings.json</code> æª”å…§ï¼Œé€™é‚Šæ˜¯ç¤ºç¯„ï¼ŒProduction ä½¿ç”¨æ™‚è«‹ä¾æ­£ç¢ºåšæ³•è¨­å®š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Logging&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;LogLevel&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;Default&quot;</span>: <span class="string">&quot;Information&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Microsoft.AspNetCore&quot;</span>: <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;AllowedHosts&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Keycloak&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;realm&quot;</span>: <span class="string">&quot;myrealm&quot;</span>,</span><br><span class="line">    <span class="string">&quot;auth-server-url&quot;</span>: <span class="string">&quot;http://localhost:8080/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ssl-required&quot;</span>: <span class="string">&quot;external&quot;</span>,</span><br><span class="line">    <span class="string">&quot;resource&quot;</span>: <span class="string">&quot;api-client&quot;</span>,</span><br><span class="line">    <span class="string">&quot;public-client&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;confidential-port&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ° <code>Program.cs</code> æª”æ¡ˆå…§æ–°å¢ Authentication çš„è¨­å®š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddKeycloakAuthentication(configuration, o =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    o.RequireHttpsMetadata = <span class="literal">false</span>;    </span><br><span class="line">    o.Audience = <span class="string">&quot;account&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¨˜å¾—åœ¨ <code>app.UseAuthorization()</code> çš„ä¸Šæ–¹åŠ å…¥ <code>app.UseAuthentication();</code></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.UseAuthentication();</span><br><span class="line">app.UseAuthorization();</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å®Œæˆè¨­å®šå¾Œï¼Œå°±å¯ä»¥åˆ° API çš„åœ°æ–¹åŠ ä¸Š <code>[Authorize]</code> çš„æ¨™ç±¤</p><p><img src="image-20221023185907306.png" alt="image-20221023185907306"></p><p>ä¸€æ—¦åŠ ä¸Šå»å¾Œï¼Œåªè¦è¦å‘¼å«é€™å€‹ API æ™‚ï¼Œå°±æœƒæª¢æŸ¥ request header å…§çš„ <strong>authorization</strong> çš„ <code>Bearer</code> å€¼æ˜¯å¦åˆæ³•æ­£ç¢º</p><h3 id="å¦‚æœé‡åˆ°-CORS-å•é¡Œ"><a class="header-anchor" href="#å¦‚æœé‡åˆ°-CORS-å•é¡Œ"> </a>å¦‚æœé‡åˆ° CORS å•é¡Œ</h3><p>å¦‚æœå¾ angular application å‘¼å« API æ™‚ï¼Œé€šå¸¸æœƒæ’ä¸Š CORS çš„å•é¡Œï¼Œé€™æ™‚å€™å°±å¾—åœ¨ <code>Program.cs</code> åŠ ä¸Š <code>Cors</code> çš„ç›¸é—œè¨­å®šï¼Œæ¸›å°‘å¤§å®¶ google çš„æ™‚é–“ï¼Œé€™é‚Šå°±é™„ä¸Šæœ€ä¸åš´è¬¹çš„è¨­å®š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddCors(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.AddPolicy(<span class="string">&quot;policy&quot;</span>,</span><br><span class="line">                    policy =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        policy.AllowAnyOrigin()</span><br><span class="line">                            .AllowAnyHeader()</span><br><span class="line">                            .AllowAnyMethod();</span><br><span class="line">                    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br><span class="line">app.UseCors(<span class="string">&quot;policy&quot;</span>);</span><br></pre></td></tr></table></figure><p>Controller çš„éƒ¨åˆ†ä¹Ÿéœ€è¦åŠ ä¸Š <code>[EnableCors]</code> çš„æ¨™ç±¤</p><h3 id="å¯¦éš›å‘¼å«çš„-Network-æˆªåœ–"><a class="header-anchor" href="#å¯¦éš›å‘¼å«çš„-Network-æˆªåœ–"> </a>å¯¦éš›å‘¼å«çš„ Network æˆªåœ–</h3><p><img src="image-20221023190406972.png" alt="image-20221023190406972"></p><p>åœ¨ Web çš„éƒ¨åˆ†æœƒå¤šåˆ¤æ–·è™•ç† Token éæœŸçš„å•é¡Œï¼Œå¦‚æœå¾Œè‡ºæœ‰è¨­å®šå¯è‡ªå‹• Refreshï¼Œé‚£éº¼åœ¨å‘¼å« API æ™‚å°±æœƒå»åš Token æ›´æ–°çš„å‹•ä½œï¼Œä¹‹å¾Œæ‰æœƒé€²è¡Œ API å‘¼å« (with authorization: Bearer xxxxxx)</p><p><img src="image-20221023190645948.png" alt="image-20221023190645948"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸Šä¸€ç¯‡ä»‹ç´¹äº†åŸºæœ¬ç’°å¢ƒè¨­å®šèˆ‡ Angular å‰ç«¯å¦‚ä½•å¥—ç”¨ Keycloakï¼Œä½†ä¸€å€‹å®Œæ•´çš„æµç¨‹æ‡‰è©²é‚„æœƒåŒ…å«å¾Œç«¯çš„ API é©—è­‰ï¼Œé€™ç¯‡æœƒç”¨ C# çš„ WebAPI ä¾†åšä¸€å€‹ç°¡å–®ç¯„ä¾‹&lt;/p&gt;</summary>
    
    
    
    <category term="Keycloak" scheme="http://blog.kevinyang.net/categories/Keycloak/"/>
    
    
    <category term="Keycloak" scheme="http://blog.kevinyang.net/tags/Keycloak/"/>
    
  </entry>
  
  <entry>
    <title>[Keycloak] ç’°å¢ƒæº–å‚™ &amp; åŸºæœ¬è¨­å®š</title>
    <link href="http://blog.kevinyang.net/2022/10/23/keycloak-note-1/"/>
    <id>http://blog.kevinyang.net/2022/10/23/keycloak-note-1/</id>
    <published>2022-10-23T02:05:13.000Z</published>
    <updated>2023-12-30T10:00:10.147Z</updated>
    
    <content type="html"><![CDATA[<p><code>Keycloak is an open source identity and access management solution</code>. ä»–èƒ½æä¾› SSO ç³»çµ±æœå‹™ï¼Œä¸€å€‹ç°¡å–®çš„é©—è­‰æ©Ÿåˆ¶å¯ä»¥å¿«é€Ÿè¢«å»ºç«‹å‡ºä¾†ï¼Œæ›´å¤šè³‡è¨Šå¯ä»¥åˆ°<a href="https://www.keycloak.org/">å®˜ç¶²</a>ä¸Šé–±è®€ï¼Œé‚£ç‚ºä»€éº¼è¦å¯«é€™ç¯‡ç­†è¨˜ï¼Œä¸»è¦æ˜¯æƒ³è¦ç­è§£é–‹ç™¼æ™‚ï¼Œå¦‚ä½•èˆ‡ Keycloak ä¸²æ¥ï¼Œæ‰€ä»¥è¦åœ¨æœ¬æ©Ÿä¸Šé¢å°‡è©²ç’°å¢ƒçµ¦æº–å‚™å‡ºä¾†ï¼Œä»¥ä¾›é–‹ç™¼ä½¿ç”¨ã€‚</p><span id="more"></span><h2 id="ç’°å¢ƒæ¶è¨­"><a class="header-anchor" href="#ç’°å¢ƒæ¶è¨­"> </a>ç’°å¢ƒæ¶è¨­</h2><p>å¥½å®¶åœ¨çš„æ˜¯åœ¨æœ¬æ©Ÿé›»è…¦ä¸Šé¢å•Ÿå‹•ä¸€å¥— Keycloak çš„å‹•ä½œå¾ˆç°¡å–®ï¼Œæ‹œ container æŠ€è¡“çš„é€²æ­¥ï¼Œåªè¦ä¸€è¡ŒæŒ‡ä»¤å°±å¯ä»¥å®Œæˆå®‰è£</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:19.0.3 start-dev</span><br></pre></td></tr></table></figure><ul><li>ç™»å…¥å¸³è™Ÿå¯†ç¢¼é è¨­ç‚º <code>admin</code> / <code>admin</code></li><li>ç™»å…¥ç¶²å€: <code>http://localhost:8080</code></li></ul><h2 id="Keycloak-å¾Œå°åŸºæœ¬æ“ä½œ"><a class="header-anchor" href="#Keycloak-å¾Œå°åŸºæœ¬æ“ä½œ"> </a>Keycloak å¾Œå°åŸºæœ¬æ“ä½œ</h2><p>é–‹å•Ÿ <code>http://localhost:8080</code> æœƒçœ‹åˆ°é€™å€‹ç•«é¢</p><p><img src="image-20221023102214910.png" alt="image-20221023102214910"></p><p>é€²å…¥ <code>Administration Console </code> æœƒå…ˆçœ‹åˆ°ç™»å…¥ç•«é¢ï¼Œå¸³è™Ÿå¯†ç¢¼å¦‚ä¸Šé¢èªªåˆ°çš„ <code>admin</code> / <code>admin</code>ï¼Œç™»å…¥å¸³å¾Œå¯†ç¢¼å¾Œæœƒçœ‹åˆ°ä¸€å †è¨­å®šé¸å–®ï¼Œæˆ‘å€‘çš„ä¸»è¦ç›®çš„æ˜¯è¦æ¸¬è©¦é–‹ç™¼æ™‚èƒ½ä¸²æ¥ Keycloak çš„ç™»å…¥åŠŸèƒ½ï¼Œæ‰€ä»¥æœƒåšä»¥ä¸‹å¹¾ä»¶äº‹æƒ…</p><h3 id="å»ºç«‹-realm"><a class="header-anchor" href="#å»ºç«‹-realm"> </a>å»ºç«‹ realm</h3><p>æ–¼å·¦ä¸Šè§’çš„ä¸‹æ‹‰é¸å–®ä¸­ï¼Œå¯ä»¥çœ‹åˆ° <code>Crate Realm</code>ï¼Œå¾é€™é‚Šé€²è¡Œå»ºç«‹ realm çš„å‹•ä½œ</p><p><img src="image-20221023103522222.png" alt="image-20221023103522222"></p><p>ä»€éº¼æ˜¯ <code>realm</code> ? <code>realm</code> æ˜¯ä¸€å€‹ workspace è®“ä½ å¯ä»¥ç®¡ç† usersã€applicationsã€roles and groups.</p><p><img src="image-20221023103719261.png" alt="image-20221023103719261"></p><p>è¼¸å…¥ä¸€å€‹åå­—å¾ŒæŒ‰ä¸‹ <code>Create</code> å³å¯å®Œæˆå»ºç«‹ï¼Œå»ºç«‹å®Œæˆå¾Œåœ¨å·¦ä¸Šè§’çš„ä¸‹æ‹‰é¸å–®ä¸­å°±å¯ä»¥çœ‹åˆ°å‰›å‰›æ‰€å»ºç«‹çš„ <code>realm</code></p><h3 id="å»ºç«‹-User"><a class="header-anchor" href="#å»ºç«‹-User"> </a>å»ºç«‹ User</h3><p>åˆ‡æ›åˆ°å‰›å‰›æ‰€æ–°å¢çš„ <code>realm</code> ï¼Œç„¶å¾Œé»é¸ <code>Users</code> ä¾†æº–å‚™å»ºç«‹ç¬¬ä¸€å€‹ User å¸³è™Ÿ</p><p><img src="image-20221023103904970.png" alt="image-20221023103904970"></p><p>é» <code>Create new user</code> å¾Œï¼Œè¼¸å…¥ä¸€äº›åŸºæœ¬è³‡è¨Šï¼ŒæŒ‰ä¸‹ <code>Create</code> å®Œæˆæ–°å¢ç¬¬ä¸€å€‹ä½¿ç”¨è€…</p><p><img src="image-20221023104129585.png" alt="image-20221023104129585"></p><p>æ–°å¢å®Œæˆå¾Œï¼Œéœ€è¦ä¾†è¨­å®šä¸€ä¸‹ç™»å…¥å¯†ç¢¼ï¼Œåœ¨ç•«é¢ä¸Šè¨­å®šå¯†ç¢¼çš„åœ°æ–¹åœ¨</p><p><img src="image-20221023104247821.png" alt="image-20221023104247821"></p><p><img src="image-20221023104307523.png" alt="image-20221023104307523"></p><p><img src="image-20221023104339043.png" alt="image-20221023104339043"></p><ul><li><code>Temporary</code> ï¼šä½¿ç”¨è€…æ–¼ç¬¬ä¸€æ¬¡ç™»å…¥æ™‚æ˜¯å¦è¦é‡æ–°è¨­å®šå¯†ç¢¼ï¼Œé è¨­æ˜¯ <code>On</code> è¡¨ç¤ºä½¿ç”¨è€…åœ¨ç¬¬ä¸€æ¬¡ç™»å…¥å¾Œæ˜¯éœ€è¦è®Šæ›´å¯†ç¢¼çš„</li></ul><p>é©—è­‰å‰›å‰›è¨­å®šçš„ User æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå¯ä»¥é€éé–‹å•Ÿ <a href="http://localhost:8080/realms/myrealm/account">Keycloak Account Console</a> çš„ç•«é¢ä¾†é€²è¡Œé©—è­‰ï¼Œå¦‚æœèƒ½æ­£ç¢ºçš„ç™»å…¥å°±ä»£è¡¨è¨­å®šæ­£ç¢º</p><h2 id="é–‹ç™¼-ä¸²æ¥"><a class="header-anchor" href="#é–‹ç™¼-ä¸²æ¥"> </a>é–‹ç™¼ &amp; ä¸²æ¥</h2><p>ä¸Šè¿°å®Œæˆå¾Œå°±å¯ä»¥ä¾†è©¦è‘—ä¸²çœ‹çœ‹äº†ï¼Œç•¶ç„¶é¦–ç™¼æ˜¯ Angular</p><h3 id="è¨­å®š-Client-on-Keycloak"><a class="header-anchor" href="#è¨­å®š-Client-on-Keycloak"> </a>è¨­å®š Client (on Keycloak)</h3><p>æˆ‘è¦ºå¾—é€™å¡Šæ˜¯æœ€å›°æƒ‘çš„åœ°æ–¹ï¼Œä¸€å€‹åœ°æ–¹æ²’è¨­å®šå¥½ï¼Œå‰ç«¯å°±æ²’æ³•æ­£å¸¸ä½¿ç”¨äº†</p><ol><li><p>å»ºç«‹ clients</p><p><img src="image-20221023115522307.png" alt="image-20221023115522307"></p></li><li><p>è¨­å®š Client IDï¼Œä¹‹å¾Œåœ¨ Angular è¨­å®šæ™‚éœ€è¦</p><p><img src="image-20221023115602969.png" alt="image-20221023115602969"></p></li><li><p><code>Capability Config</code> çš„é é¢å…ˆä¿æŒé è¨­å€¼</p><p><img src="image-20221023115647040.png" alt="image-20221023115647040"></p></li><li><p><code>Save</code> å®Œæˆæ–°å¢ Client</p></li><li><p>é€™æ™‚å€™æœƒè·³åˆ° Client çš„è©³ç´°é é¢ï¼Œé€™å€‹é é¢éœ€è¦å¤šè¨­å®šä¸€äº›ç¶²å€è³‡è¨Š</p><ol><li><strong>Valid redirect URIs</strong> æ–°å¢ <code>http://localhost:4200/*</code></li><li><strong>Valid post logout redirect URIs</strong> æ–°å¢ <code>http://localhost:4200/*</code></li><li><strong>Web origins</strong> æ–°å¢ <code>http://localhost:4200</code></li></ol><p>è¨­å®šå®Œæˆå¾ŒæŒ‰ä¸‹ <code>Save</code> å„²å­˜ç•°å‹•</p></li></ol><h3 id="Angular-å®‰è£-Keycloack-library"><a class="header-anchor" href="#Angular-å®‰è£-Keycloack-library"> </a>Angular å®‰è£ Keycloack library</h3><ol><li><p>å‡è¨­å·²ç¶“æœ‰ä¸€å€‹ Angular å°ˆæ¡ˆ</p></li><li><p>å®‰è£ library</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install keycloak-angular keycloak-js</span><br></pre></td></tr></table></figure></li><li><p>è¨­å®š initial config (<code>app.mdoule.ts</code>)</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">APP_INITIALIZER</span>, <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">KeycloakAngularModule</span>, <span class="title class_">KeycloakService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;keycloak-angular&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initializeKeycloak</span>(<span class="params">keycloak: KeycloakService</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span></span><br><span class="line">    keycloak.<span class="title function_">init</span>(&#123;</span><br><span class="line">      <span class="attr">config</span>: &#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080&#x27;</span>,</span><br><span class="line">        <span class="attr">realm</span>: <span class="string">&#x27;myrealm&#x27;</span>,</span><br><span class="line">        <span class="attr">clientId</span>: <span class="string">&#x27;ngclient&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">loadUserProfileAtStartUp</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">initOptions</span>: &#123;</span><br><span class="line">        <span class="attr">onLoad</span>: <span class="string">&#x27;check-sso&#x27;</span>,</span><br><span class="line">        <span class="attr">silentCheckSsoRedirectUri</span>:</span><br><span class="line">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">origin</span> + <span class="string">&#x27;/assets/silent-check-sso.html&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [<span class="title class_">AppComponent</span>],</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">BrowserModule</span>, <span class="title class_">KeycloakAngularModule</span>, <span class="title class_">RouterModule</span>.<span class="title function_">forRoot</span>([])],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">APP_INITIALIZER</span>,</span><br><span class="line">      <span class="attr">useFactory</span>: initializeKeycloak,</span><br><span class="line">      <span class="attr">multi</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">deps</span>: [<span class="title class_">KeycloakService</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure><ul><li><p>line 12: Keycloak server ä½ç½®</p></li><li><p>line 13: è¦å­˜å–å“ªä¸€å€‹ <code>realm</code></p></li><li><p>line 14: ä½¿ç”¨çš„ ClientID</p></li><li><p>line 20: <code>slient-check-sso.html</code> çš„å…§å®¹æ˜¯</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">      parent.postMessage(location.href, location.origin);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>line 16 ~ 21: å…¶ä»–é—œæ–¼é©—è­‰çš„è¨­å®šé …ç›®</p></li></ul><p>ç•¶ä¸Šè¿°è¨­å®šå®Œæˆå¾Œï¼ŒåŸºæœ¬ä¸Šæ•´å€‹ angular application å·²ç¶“è·Ÿ keycloak åšå¥½é€£æ¥äº†</p><p>ä»¥ä¸‹æœ‰ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼Œç”¨ä¾†å±•ç¤º login å‰å¾Œçš„æ“ä½œ</p><ul><li><p><code>app.component.html</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Keycloak Angular Example<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">&quot;isLoggedIn&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;logout()&quot;</span>&gt;</span>Log out<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> *<span class="attr">ngIf</span>=<span class="string">&quot;!isLoggedIn&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> (<span class="attr">click</span>)=<span class="string">&quot;login()&quot;</span>&gt;</span>Log in<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngIf</span>=<span class="string">&quot;userProfile&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>User information<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngIf</span>=<span class="string">&quot;userProfile.username&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;row&quot;</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; userProfile.username &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngIf</span>=<span class="string">&quot;userProfile.firstName&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;row&quot;</span>&gt;</span>First name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; userProfile.firstName &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngIf</span>=<span class="string">&quot;userProfile.lastName&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;row&quot;</span>&gt;</span>Last name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; userProfile.lastName &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span> *<span class="attr">ngIf</span>=<span class="string">&quot;userProfile.email&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;row&quot;</span>&gt;</span>E-mail<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; userProfile.email &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;row&quot;</span>&gt;</span>E-mail verified<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; userProfile.emailVerified ? &#x27;Yes&#x27; : &#x27;No&#x27; &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>app.component.ts</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ActivatedRoute</span>, <span class="title class_">Router</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">KeycloakService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;keycloak-angular&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">KeycloakProfile</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;keycloak-js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.css&#x27;</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> isLoggedIn = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="attr">userProfile</span>: <span class="title class_">KeycloakProfile</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> keycloak: KeycloakService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> <span class="title function_">ngOnInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoggedIn</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">keycloak</span>.<span class="title function_">isLoggedIn</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoggedIn</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userProfile</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">keycloak</span>.<span class="title function_">loadUserProfile</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keycloak</span>.<span class="title function_">login</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keycloak</span>.<span class="title function_">logout</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å‘ˆç¾ç•«é¢</p><p><img src="image-20221023132329423.png" alt="image-20221023132329423"></p></li></ol><p>è€Œ login å¾Œçš„ User è³‡è¨Šåˆ°åº•å¯ä»¥å–åˆ°ä»€éº¼ç¨‹åº¦ï¼Œä¹Ÿæ˜¯å¯ä»¥å¾å¾Œå°åšè¨­å®šçš„</p><p><img src="image-20221023132432605.png" alt="image-20221023132432605"></p><h3 id="AuthGuide-HttpInterceptor"><a class="header-anchor" href="#AuthGuide-HttpInterceptor"> </a>AuthGuide &amp; HttpInterceptor</h3><p>æ‰€å®‰è£çš„å¥—ä»¶ä¹Ÿå¥½å¿ƒçš„å°‡é€™å…©å€å¡Šçš„åŠŸèƒ½ï¼Œç¯„ä¾‹ç¨‹å¼ç¢¼éƒ½æä¾›å‡ºä¾†äº†ï¼Œé€™è£¡å°±ä¸å¤šå¯«ï¼Œç›´æ¥é™„ä¸Šé€£çµ</p><ul><li><a href="https://github.com/mauriciovigolo/keycloak-angular#authguard">AuthGuard</a></li><li><a href="https://github.com/mauriciovigolo/keycloak-angular#httpclient-interceptor">HttpClient Interceptor</a></li></ul><h2 id="å¿ƒå¾—"><a class="header-anchor" href="#å¿ƒå¾—"> </a>å¿ƒå¾—</h2><p>Keycloak çš„è¨­å®šå¾ˆå¤šï¼Œå¾ˆå¤šç´°ç¯€éœ€è¦ä»”ç´°çš„ç ”ç©¶ï¼Œä½†ç¸½çš„ä¾†èªªï¼ŒåŠŸèƒ½å¾ˆå¼·ä¹Ÿä¿æœ‰ä¸€å®šçš„å½ˆæ€§ï¼Œä¾‹å¦‚ User Info Storage çš„éƒ¨åˆ†å¯ä»¥ä¸²æ¥å…¶ä»–çš„è³‡è¨Šï¼Œæˆ–æ˜¯æ”¯æ´å…¶ä»–çš„ Identity providers ç­‰ï¼Œé–‹ç™¼ä¸Šçš„ä½¿ç”¨ä¹Ÿæ”¯æ´å¾ˆå¤šå¸¸è¦‹èªè¨€ï¼Œä¾‹å¦‚ Javaã€.NETã€JavaScript ã€Python ç­‰</p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://www.keycloak.org/">Keycloak</a></li><li><a href="https://github.com/mauriciovigolo/keycloak-angular">keycloak-angular</a></li><li><a href="https://www.keycloak.org/docs/latest/securing_apps/#_javascript_adapter">Keycloak JavaScript dapter</a></li></ul><p><a href="https://www.keycloak.org/"></a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;code&gt;Keycloak is an open source identity and access management solution&lt;/code&gt;. ä»–èƒ½æä¾› SSO ç³»çµ±æœå‹™ï¼Œä¸€å€‹ç°¡å–®çš„é©—è­‰æ©Ÿåˆ¶å¯ä»¥å¿«é€Ÿè¢«å»ºç«‹å‡ºä¾†ï¼Œæ›´å¤šè³‡è¨Šå¯ä»¥åˆ°&lt;a href=&quot;https://www.keycloak.org/&quot;&gt;å®˜ç¶²&lt;/a&gt;ä¸Šé–±è®€ï¼Œé‚£ç‚ºä»€éº¼è¦å¯«é€™ç¯‡ç­†è¨˜ï¼Œä¸»è¦æ˜¯æƒ³è¦ç­è§£é–‹ç™¼æ™‚ï¼Œå¦‚ä½•èˆ‡ Keycloak ä¸²æ¥ï¼Œæ‰€ä»¥è¦åœ¨æœ¬æ©Ÿä¸Šé¢å°‡è©²ç’°å¢ƒçµ¦æº–å‚™å‡ºä¾†ï¼Œä»¥ä¾›é–‹ç™¼ä½¿ç”¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Keycloak" scheme="http://blog.kevinyang.net/categories/Keycloak/"/>
    
    
    <category term="Keycloak" scheme="http://blog.kevinyang.net/tags/Keycloak/"/>
    
  </entry>
  
  <entry>
    <title>Playwright æ¢ç´¢æ—¥è¨˜(1) - åˆæ¬¡è¦‹é¢</title>
    <link href="http://blog.kevinyang.net/2022/10/22/playwright-note1/"/>
    <id>http://blog.kevinyang.net/2022/10/22/playwright-note1/</id>
    <published>2022-10-22T02:43:30.000Z</published>
    <updated>2023-12-30T10:00:10.147Z</updated>
    
    <content type="html"><![CDATA[<p>Playwright æ˜¯ä¸€å¥— E2E çš„æ¸¬è©¦å·¥å…·ï¼Œå¯ä»¥æ¸¬è©¦å¤šç¨®ç€è¦½å™¨ç’°å¢ƒ(åŒ…å«æ‰‹æ©Ÿ)ï¼Œæ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§ä¸”å®Œæ•´çš„å·¥å…·</p><span id="more"></span><p>å¼•ç”¨å®˜ç¶²çš„ä»‹ç´¹</p><p><img src="image-20221022105911680.png" alt="image-20221022105911680"></p><h2 id="å°ˆæ¡ˆåˆå§‹"><a class="header-anchor" href="#å°ˆæ¡ˆåˆå§‹"> </a>å°ˆæ¡ˆåˆå§‹</h2><p>å»ºç«‹ä¸€å€‹ playwright çš„å°ˆæ¡ˆå‹•ä½œå¾ˆå–®ç´”ï¼Œå¯ä»¥é€é <code>npm init</code> çš„æ–¹å¼å®Œæˆï¼Œæ­¥é©Ÿå¦‚ä¸‹</p><ol><li>å»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ä¾†æ”¾ playwright å°ˆæ¡ˆ</li><li>é–‹å•Ÿå‘½ä»¤è¦–çª—åˆ‡æ›åˆ°è©²è³‡æ–™å¤¾</li><li>åŸ·è¡Œ <code>npm init playwright@latest</code></li><li>éç¨‹ä¸­æœƒé‡åˆ°å¹¾å€‹é¸æ“‡<ol><li>èªè¨€: JavaScript or TypeScript</li><li>æ¸¬è©¦è³‡æ–™å¤¾çš„åç¨±</li><li>æ˜¯å¦è¦åŠ å…¥ GitHub Actions çš„æŒ‡ä»¤</li></ol></li><li>ç­‰å¾…å®‰è£ï¼Œå³å¯å®Œæˆ</li></ol><p>ç­‰ <code>npm install</code> çµæŸå¾Œå³å¯ç”¨ <code>VSCode</code> é–‹å•Ÿè©²è³‡æ–™å¤¾å°ˆæ¡ˆï¼Œæª”æ¡ˆçµæ§‹å¾ˆç°¡å–®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">playwright.config.ts</span><br><span class="line">package.json</span><br><span class="line">package-lock.json</span><br><span class="line">tests/</span><br><span class="line">  example.spec.ts</span><br><span class="line">tests-examples/</span><br><span class="line">  demo-todo-app.spec.ts</span><br></pre></td></tr></table></figure><p><code>playwright.config.ts</code> å’Œ <code>tests/</code> ä¸‹çš„æ±è¥¿æ™šé»ä¾†çœ‹ï¼Œå…ˆä¾†è·‘ä¸€ä¸‹æ¸¬è©¦èˆ‡æ¸¬è©¦å ±å‘Š</p><p>åŸ·è¡Œæ¸¬è©¦çš„æŒ‡ä»¤: <code>npx playwright test</code></p><p>æ¸¬è©¦å ±å‘ŠæŒ‡ä»¤: <code>npx playwright show-report</code></p><h2 id="Playwright-è¨­å®šæª”"><a class="header-anchor" href="#Playwright-è¨­å®šæª”"> </a>Playwright è¨­å®šæª”</h2><p>åœ¨ <code>playwright.config.ts</code> å…§å……æ»¿äº†æ»¿æ»¿çš„è¨»è§£ï¼Œæƒ³è¦çœ‹ä¸æ‡‚è¨­å®šçœŸçš„æœ‰ä¸€å®šçš„é›£åº¦ï¼Œé™¤äº†æ¸¬è©¦æª”æ¡ˆè³‡æ–™å¤¾æˆ–æ˜¯ timeout è¨­å®šéƒ½ç®—åŸºæœ¬çš„ï¼Œæ¸¬è©¦ç’°å¢ƒçš„è¨­å®šä¹Ÿæ˜¯åœ¨é€™å€‹è¨­å®šæª”å…§ï¼Œç›¸ä¿¡é€™å€‹å„ä½é–‹å•Ÿæª”æ¡ˆå¾Œæ‡‰è©²çŸ¥é“æ€éº¼è™•ç†äº†</p><h2 id="æ¸¬è©¦æª”çš„èªæ³•"><a class="header-anchor" href="#æ¸¬è©¦æª”çš„èªæ³•"> </a>æ¸¬è©¦æª”çš„èªæ³•</h2><p>å…ˆå¾é è¨­æ–°å¢çš„æ¸¬è©¦æª”æ¡ˆèªªæ˜èµ·ï¼Œå› ç‚º playwright æä¾›çš„ api åŠŸèƒ½å¼·å¤§ï¼Œéœ€è¦åˆ†åˆ¥ç ”ç©¶ï¼Œç¾éšæ®µå…ˆçœ‹å€‹æ„Ÿè¦º</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; test, expect &#125; <span class="keyword">from</span> <span class="string">&#x27;@playwright/test&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&#x27;homepage has Playwright in title and get started link linking to the intro page&#x27;</span>, <span class="keyword">async</span> (&#123; page &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="string">&#x27;https://playwright.dev/&#x27;</span>);</span><br><span class="line">  <span class="comment">// Expect a title &quot;to contain&quot; a substring.</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(page).<span class="title function_">toHaveTitle</span>(<span class="regexp">/Playwright/</span>);</span><br><span class="line">  <span class="comment">// create a locator</span></span><br><span class="line">  <span class="keyword">const</span> getStarted = page.<span class="title function_">getByText</span>(<span class="string">&#x27;Get Started&#x27;</span>);</span><br><span class="line">  <span class="comment">// Expect an attribute &quot;to be strictly equal&quot; to the value.</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(getStarted).<span class="title function_">toHaveAttribute</span>(<span class="string">&#x27;href&#x27;</span>, <span class="string">&#x27;/docs/intro&#x27;</span>);</span><br><span class="line">  <span class="comment">// Click the get started link.</span></span><br><span class="line">  <span class="keyword">await</span> getStarted.<span class="title function_">click</span>();</span><br><span class="line">  <span class="comment">// Expects the URL to contain intro.</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expect</span>(page).<span class="title function_">toHaveURL</span>(<span class="regexp">/.*intro/</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>åŸºæœ¬èªæ³•çµæ§‹è·Ÿå¯« JS Unit test å¾ˆåƒï¼Œåœ¨ <code>test</code> å…§å¯å·²æœ‰æ¸¬è©¦æè¿°å³è¦åŸ·è¡Œçš„æ¸¬è©¦ç¨‹å¼</li><li><code>page</code> ç‰©ä»¶çš„æ“ä½œç­‰åŒæ“ä½œç€è¦½å™¨çš„ä¸€å€‹ç¶²é </li><li>ä½¿ç”¨ jasmine line çš„ expect assertion çš„èªæ³•ä¾†åšæ¸¬è©¦ï¼Œåƒæ˜¯ <code>expect(page).toHaveTitle(/Playwright/);</code></li><li>page çš„æ“ä½œæœƒæŒçºŒç­‰å¾…çµæœå›ä¾†ï¼Œæˆ–æ˜¯è¶…é timeout æ™‚é–“å°±æœƒå™´éŒ¯</li><li>ä¹Ÿå¯ä»¥åŸ·è¡ŒæŒ‰éˆ•çš„å‹•ä½œæˆ–æ˜¯é»é¸é€£çµçš„è¡Œç‚º</li><li>æ•´å€‹æ¸¬è©¦æµç¨‹å¯è®€æ€§é‚„è »é«˜çš„</li></ul><h2 id="VSCode-Extension"><a class="header-anchor" href="#VSCode-Extension"> </a>VSCode Extension</h2><p>å¦‚æœæœ‰ä½¿ç”¨ VSCodeï¼Œä¹Ÿå¯ä»¥å®‰è£ playwright çš„ extensionï¼Œè£äº†ä¹‹å¾Œå¯ä»¥è®“æ¸¬è©¦ playwright æ›´è¼•é¬†</p><p><img src="image-20221022222048276.png" alt="image-20221022222048276"></p><p>çœ‹èµ·ä¾†å°±æ˜¯ç°¡å–®å¥½ç”¨ï¼Œæ›´å¤šä»¶ä»‹ç´¹<a href="https://marketplace.visualstudio.com/items?itemName=ms-playwright.playwright">ç”±æ­¤å»</a></p><h2 id="å¿ƒå¾—"><a class="header-anchor" href="#å¿ƒå¾—"> </a>å¿ƒå¾—</h2><p>å¿«é€Ÿæƒéå®˜æ–¹æ–‡ä»¶ï¼Œå…¶å¯¦ä»–å¯ä»¥åšçš„ä¸åªæœ‰ E2Eï¼Œä¹Ÿé‚„å¯ä»¥åš API Testingï¼Œè€Œä¸”ä¸åƒ <a href="http://cypress.io">cypress.io</a> ä¸€é–‹å§‹å°±é‚£éº¼è‚¥å¤§ï¼Œçœ‹èµ·ä¾†æ˜¯ä¸€å€‹å€¼å¾—æ·±å…¥ç ”ç©¶çš„å·¥å…·</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Playwright æ˜¯ä¸€å¥— E2E çš„æ¸¬è©¦å·¥å…·ï¼Œå¯ä»¥æ¸¬è©¦å¤šç¨®ç€è¦½å™¨ç’°å¢ƒ(åŒ…å«æ‰‹æ©Ÿ)ï¼Œæ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§ä¸”å®Œæ•´çš„å·¥å…·&lt;/p&gt;</summary>
    
    
    
    <category term="playwright" scheme="http://blog.kevinyang.net/categories/playwright/"/>
    
    
    <category term="playwright" scheme="http://blog.kevinyang.net/tags/playwright/"/>
    
  </entry>
  
  <entry>
    <title>[RxJS] Config.onUnhandledError</title>
    <link href="http://blog.kevinyang.net/2022/09/18/rxjs-config/"/>
    <id>http://blog.kevinyang.net/2022/09/18/rxjs-config/</id>
    <published>2022-09-18T14:46:59.000Z</published>
    <updated>2023-12-30T10:00:10.147Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©å¿ƒè¡€ä¾†æ½®è·‘å» <code>RxJS</code> å®˜ç¶²æ™ƒäº†ä¸€ä¸‹ï¼Œç„¡æ„é–“çœ‹åˆ°ä¸€å€‹æˆ‘å¾æ²’æ³¨æ„åˆ°çš„å¥½åŠŸèƒ½ï¼Œç‰¹åœ°å¯«ä¸€ç¯‡æ–‡ç« è¨˜éŒ„ä¸€ä¸‹ï¼Œæˆ‘å€‘åœ¨å¯« Angular æ™‚æœƒå»å¯«ä¸€å€‹ global çš„ error handleï¼Œä¸»è¦ç›®çš„æ˜¯ç‚ºäº†é‚£äº›æœªè¢«è™•ç†çš„ exceptionï¼Œè€Œ <code>RxJS</code> ä¹Ÿæœ‰ä¸€æ¨£çš„åŠŸèƒ½ï¼Œé‚£å°±æ˜¯ <code>config</code></p><span id="more"></span><p>å…ˆè²¼ä¸Šä¸€æ®µ codeï¼Œç›´æ¥ç”¨ç¨‹å¼ç¢¼èªªæ˜</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; config, throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line">config.<span class="property">onUnhandledError</span> = <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(err);</span><br><span class="line"></span><br><span class="line"><span class="title function_">throwError</span>(<span class="function">() =&gt;</span> <span class="string">&#x27;error without handle&#x27;</span>).<span class="title function_">subscribe</span>();</span><br><span class="line"><span class="title function_">throwError</span>(<span class="function">() =&gt;</span> <span class="string">&#x27;error with handle&#x27;</span>).<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">  <span class="attr">error</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(err),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŸ·è¡Œæ•ˆæœå¦‚ä¸‹åœ–</p><p><img src="image-20220918225327395.png" alt="image-20220918225327395"></p><p>å…‰çœ‹åˆ°é€™æ¨£æ˜¯å¦å°±è¦ºå¾—æœ‰ä½¿ç”¨ä»–çš„åœ°æ–¹äº†ï¼Œè€Œå¯¦éš›åœ¨ Angular å…§æœƒæ€éº¼ä½¿ç”¨å‘¢? å› ç‚º <code>config</code> æ˜¯ global è¨­å®šï¼Œæ‰€ä»¥å¯ä»¥åœ¨ root module å®šç¾©ï¼Œå‰©ä¸‹çš„å°±æœƒè‡ªå·±è™•ç†äº†ï¼Œååˆ†æ–¹ä¾¿</p><p><img src="image-20220918230230345.png" alt="image-20220918230230345"></p><h2 id="åƒè€ƒè³‡æ–™"><a class="header-anchor" href="#åƒè€ƒè³‡æ–™"> </a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://rxjs.dev/api/index/interface/GlobalConfig">RxJS config</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»Šå¤©å¿ƒè¡€ä¾†æ½®è·‘å» &lt;code&gt;RxJS&lt;/code&gt; å®˜ç¶²æ™ƒäº†ä¸€ä¸‹ï¼Œç„¡æ„é–“çœ‹åˆ°ä¸€å€‹æˆ‘å¾æ²’æ³¨æ„åˆ°çš„å¥½åŠŸèƒ½ï¼Œç‰¹åœ°å¯«ä¸€ç¯‡æ–‡ç« è¨˜éŒ„ä¸€ä¸‹ï¼Œæˆ‘å€‘åœ¨å¯« Angular æ™‚æœƒå»å¯«ä¸€å€‹ global çš„ error handleï¼Œä¸»è¦ç›®çš„æ˜¯ç‚ºäº†é‚£äº›æœªè¢«è™•ç†çš„ exceptionï¼Œè€Œ &lt;code&gt;RxJS&lt;/code&gt; ä¹Ÿæœ‰ä¸€æ¨£çš„åŠŸèƒ½ï¼Œé‚£å°±æ˜¯ &lt;code&gt;config&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/categories/Angular/"/>
    
    
    <category term="Angular" scheme="http://blog.kevinyang.net/tags/Angular/"/>
    
  </entry>
  
</feed>
